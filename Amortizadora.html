<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Amortización Hipotecaria</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 20px; }
  .container { max-width: 1200px; margin: auto; }
  .table-editable td[contenteditable=true] {
    background-color: #eef;
    outline: 1px solid #ccc;
  }
  .table-editable td[contenteditable=true]:hover {
    background-color: #ddf;
    cursor: text;
  }
  /* Tooltip icon style */
  .info-icon {
    display: inline-block;
    color: #0d6efd;
    text-decoration: none;
    cursor: pointer;
    margin-left: 5px;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="container">
  <h1 class="mb-4 text-center">Calculadora de Amortización de Préstamo Hipotecario</h1>
  <!-- Input Form -->
  <form id="loanForm" class="row gy-3 gx-3 mb-4">
    <div class="col-md-4">
      <label for="principal" class="form-label">Monto del préstamo</label>
      <input type="number" step="0.01" class="form-control" id="principal" required>
    </div>
    <div class="col-md-4">
      <label for="term" class="form-label">Plazo (meses)</label>
      <input type="number" class="form-control" id="term" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Tasa de interés</label>
      <div class="input-group">
        <input type="number" step="0.001" class="form-control" id="interestRate" required>
        <span class="input-group-text">%</span>
      </div>
      <div class="form-text">Tasa de interés mensual</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Tipo de tasa</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="rateType" id="rateFixed" value="fixed" checked>
        <label class="form-check-label" for="rateFixed">Fija</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="rateType" id="rateVariable" value="variable">
        <label class="form-check-label" for="rateVariable">Variable (editable por mes)</label>
      </div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Modalidad de pago</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="payMode" id="modeFrench" value="french" checked>
        <label class="form-check-label" for="modeFrench">Cuota fija (francesa)</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="payMode" id="modeGerman" value="german">
        <label class="form-check-label" for="modeGerman">Capital fijo (alemana)</label>
      </div>
    </div>
    <div class="col-12">
      <button type="button" id="btnGenerate" class="btn btn-primary">Generar Cronograma</button>
    </div>
  </form>
  
  <!-- Summary and Charts -->
  <div id="results" style="display:none;">
    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Pago mensual estimado</h5>
            <p class="card-text"><span id="summaryPayment"></span></p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Total Intereses</h5>
            <p class="card-text"><span id="summaryInterest"></span></p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Total Pagado</h5>
            <p class="card-text"><span id="summaryTotal"></span></p>
          </div>
        </div>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <canvas id="chartPayments" height="200"></canvas>
      </div>
      <div class="col-md-6 mb-3">
        <canvas id="chartComposition" height="200"></canvas>
      </div>
    </div>
    <div class="mb-2">
      <button class="btn btn-secondary me-2" id="btnRecalc">Recalcular cronograma</button>
      <button class="btn btn-success me-2" id="btnExportCSV">Exportar Excel (CSV)</button>
      <button class="btn btn-success" id="btnExportPDF">Exportar PDF</button>
    </div>
    <div class="table-responsive table-editable">
      <table id="amortTable" class="table table-bordered table-hover mt-3">
        <thead class="table-light">
          <tr>
            <th>Mes</th>
            <th>Saldo Inicial</th>
            <th>Pago Total</th>
            <th>Interés</th>
            <th>Capital Pagado</th>
            <th>Abono a Capital <a href="#" class="info-icon" data-bs-toggle="tooltip" title="Pago extra para reducir el saldo (abono a capital).">?</a></th>
            <th>Saldo Final</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Bootstrap Bundle with Popper (for tooltips) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<!-- FileSaver.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<!-- jsPDF and jsPDF-AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
(function(){
  // Utility: format number as currency
  function formatCurrency(num) {
    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(num);
  }
  // Utility: format number as percentage
  function formatPercent(num) {
    return num.toFixed(2) + '%';
  }
  // Utility: parse float from localized string
  function parseFloatLocale(str) {
    if(typeof str === 'number') return str;
    var s = str.replace(/[^0-9.\,\-]/g, '');
    if(s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
      if(s.lastIndexOf(',') > s.lastIndexOf('.')) {
        s = s.split('.').join('');
        s = s.replace(',', '.');
      } else {
        s = s.split(',').join('');
      }
      return parseFloat(s) || 0;
    }
    if(s.indexOf(',') !== -1 && s.indexOf('.') === -1) {
      var parts = s.split(',');
      if(parts.length > 2) {
        s = s.split(',').join('');
        return parseFloat(s) || 0;
      }
      if(parts.length === 2) {
        var fracLen = parts[1].length;
        if(fracLen === 0) {
          s = parts[0];
        } else if(fracLen <= 2) {
          s = s.replace(',', '.');
        } else {
          s = s.split(',').join('');
        }
        return parseFloat(s) || 0;
      }
    }
    if(s.indexOf('.') !== -1 && s.indexOf(',') === -1) {
      var partsDot = s.split('.');
      if(partsDot.length > 2) {
        var lastSegmentLen = partsDot[partsDot.length - 1].length;
        if(lastSegmentLen <= 2) {
          var lastDotIndex = s.lastIndexOf('.');
          s = s.substring(0, lastDotIndex).split('.').join('') + '.' + s.substring(lastDotIndex+1);
        } else {
          s = s.split('.').join('');
        }
        return parseFloat(s) || 0;
      } else {
        var fracLen2 = partsDot.length > 1 ? partsDot[1].length : 0;
        if(fracLen2 <= 2) {
          return parseFloat(s) || 0;
        } else {
          s = s.split('.').join('');
          return parseFloat(s) || 0;
        }
      }
    }
    return parseFloat(s) || 0;
  }
  
  var chartPayments = null;
  var chartComposition = null;
  var originalSchedule = []; // store last generated schedule
  
  // Event: Generate schedule
  document.getElementById('btnGenerate').addEventListener('click', function(){
    // Read inputs
    var P = parseFloat(document.getElementById('principal').value);
    var N = parseInt(document.getElementById('term').value);
    var rateType = document.querySelector('input[name="rateType"]:checked').value;
    var payMode = document.querySelector('input[name="payMode"]:checked').value;
    var fixedRate = parseFloat(document.getElementById('interestRate').value) / 100;
    if(!P || !N || (rateType=='fixed' && isNaN(fixedRate))) {
      alert('Por favor, complete todos los campos correctamente.');
      return;
    }
    // Prepare rates array
    var rates = [];
    if(rateType === 'fixed') {
      for(var i=0; i<N; i++){ rates[i] = fixedRate; }
    } else {
      for(var i=0; i<N; i++){ rates[i] = fixedRate; }
    }
    // Calculate initial schedule
    originalSchedule = generateSchedule(P, N, rates, payMode);
    renderSchedule(originalSchedule);
    updateSummaryAndCharts(originalSchedule);
    document.getElementById('results').style.display = 'block';
    // Save inputs to localStorage
    try {
      var saveData = {
        principal: P,
        term: N,
        rateType: rateType,
        interestRate: parseFloat(document.getElementById('interestRate').value),
        payMode: payMode
      };
      localStorage.setItem('loanCalcData', JSON.stringify(saveData));
    } catch(e) {}
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(elem) {
      new bootstrap.Tooltip(elem);
    });
  });
  
  // Generate amortization schedule array based on inputs
  function generateSchedule(P, N, rates, payMode) {
    var schedule = [];
    var balance = P;
    var payment = 0;
    var constPrincipal = 0;
    if(payMode === 'french') {
      if(rates.every(r => r === rates[0])) {
        var r = rates[0];
        if(r === 0) {
          payment = balance / N;
        } else {
          payment = balance * r / (1 - Math.pow(1+r, -N));
        }
      } else {
        payment = findPaymentForVariable(balance, rates, 0, N);
      }
    } else if(payMode === 'german') {
      constPrincipal = balance / N;
    }
    for(var i=1; i<=N; i++) {
      var startBal = balance;
      var interest = startBal * rates[i-1];
      var normalPay = 0;
      var principalPay = 0;
      if(payMode === 'french') {
        normalPay = payment;
        if(i === N) {
          normalPay = balance * (1+rates[i-1]);
        }
        if(normalPay < interest) {
          normalPay = interest;
        }
        principalPay = normalPay - interest;
      } else if(payMode === 'german') {
        principalPay = constPrincipal;
        if(principalPay > balance) principalPay = balance;
        normalPay = principalPay + interest;
      }
      balance = startBal - principalPay;
      var endBal = balance;
      if(endBal < 1e-8) endBal = 0;
      schedule.push({
        month: i,
        start: startBal,
        payment: normalPay,
        interest: interest,
        principal: principalPay,
        extra: 0,
        end: endBal
      });
      balance = endBal;
    }
    return schedule;
  }
  
  // Find constant payment for variable rates via binary search
  function findPaymentForVariable(P, rates, startIndex, totalMonths) {
    var lo = 0;
    var hi = P * 10;
    var payment = 0;
    for(var iter=0; iter<50; iter++) {
      payment = (lo + hi) / 2;
      var bal = P;
      for(var j = 0; j < totalMonths; j++) {
        bal = bal * (1 + rates[startIndex + j]) - payment;
      }
      if(Math.abs(bal) < 1e-6) break;
      if(bal > 0) {
        lo = payment;
      } else {
        hi = payment;
      }
    }
    return payment;
  }
  
  // Render schedule into HTML table
  function renderSchedule(schedule) {
    var tbody = document.querySelector('#amortTable tbody');
    tbody.innerHTML = '';
    schedule.forEach(function(row) {
      var tr = document.createElement('tr');
      var tdMonth = document.createElement('td');
      tdMonth.textContent = row.month;
      tr.appendChild(tdMonth);
      var tdStart = document.createElement('td');
      tdStart.textContent = formatCurrency(row.start);
      tr.appendChild(tdStart);
      var tdPay = document.createElement('td');
      tdPay.textContent = formatCurrency(row.payment);
      tdPay.contentEditable = true;
      tr.appendChild(tdPay);
      var tdInterest = document.createElement('td');
      tdInterest.textContent = formatCurrency(row.interest);
      if(document.getElementById('rateVariable').checked) {
        tdInterest.textContent = (row.interest === 0 ? '0.00' : ((row.interest / row.start) * 100).toFixed(2)) + '%';
        tdInterest.contentEditable = true;
      }
      tr.appendChild(tdInterest);
      var tdPrincipal = document.createElement('td');
      tdPrincipal.textContent = formatCurrency(row.principal);
      tr.appendChild(tdPrincipal);
      var tdExtra = document.createElement('td');
      tdExtra.textContent = row.extra ? formatCurrency(row.extra) : '';
      tdExtra.contentEditable = true;
      tr.appendChild(tdExtra);
      var tdEnd = document.createElement('td');
      tdEnd.textContent = formatCurrency(row.end);
      tr.appendChild(tdEnd);
      tbody.appendChild(tr);
    });
  }
  
  // Update summary text and charts
  function updateSummaryAndCharts(schedule) {
    var totalInterest = schedule.reduce((sum, r) => sum + r.interest, 0);
    var totalPaid = schedule.reduce((sum, r) => sum + (r.payment + r.extra), 0);
    var monthlyPay = schedule.length > 0 ? schedule[0].payment : 0;
    document.getElementById('summaryPayment').textContent = formatCurrency(monthlyPay);
    document.getElementById('summaryInterest').textContent = formatCurrency(totalInterest);
    document.getElementById('summaryTotal').textContent = formatCurrency(totalPaid);
    var labels = schedule.map(r => r.month.toString());
    var dataPrincipal = schedule.map(r => r.principal + (r.extra || 0));
    var dataInterest = schedule.map(r => r.interest);
    if(chartPayments) chartPayments.destroy();
    chartPayments = new Chart(document.getElementById('chartPayments'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'Capital', data: dataPrincipal, backgroundColor: '#4e79a7' },
          { label: 'Interés', data: dataInterest, backgroundColor: '#e15759' }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(ctx) {
                var label = ctx.dataset.label || '';
                var value = ctx.parsed.y;
                return label + ': ' + formatCurrency(value);
              }
            }
          }
        }
      }
    });
    if(chartComposition) chartComposition.destroy();
    chartComposition = new Chart(document.getElementById('chartComposition'), {
      type: 'pie',
      data: {
        labels: ['Intereses', 'Capital'],
        datasets: [{
          data: [totalInterest, schedule[0].start - schedule[schedule.length-1].end],
          backgroundColor: ['#e15759', '#4e79a7']
        }]
      },
      options: {
        plugins: {
          tooltip: {
            callbacks: {
              label: function(ctx) {
                var label = ctx.label || '';
                var value = ctx.parsed;
                return label + ': ' + formatCurrency(value);
              }
            }
          }
        }
      }
    });
  }
  
  // Recalculate schedule after manual edits
  document.getElementById('btnRecalc').addEventListener('click', function(){
    if(!originalSchedule.length) return;
    var table = document.getElementById('amortTable');
    var rows = table.querySelectorAll('tbody tr');
    var N = rows.length;
    var P = originalSchedule[0].start;
    var payMode = document.querySelector('input[name="payMode"]:checked').value;
    var rateType = document.querySelector('input[name="rateType"]:checked').value;
    var rates = [];
    for(var i=0; i<rows.length; i++){
      if(rateType === 'variable') {
        var interestCellText = rows[i].cells[3].innerText.trim();
        if(interestCellText.endsWith('%')) {
          interestCellText = interestCellText.slice(0, -1);
        }
        rates[i] = parseFloatLocale(interestCellText) / 100;
      } else {
        rates[i] = originalSchedule[i].interest / (originalSchedule[i].start || 1);
      }
    }
    var newSchedule = [];
    var balance = P;
    var currentPayment = 0;
    var currentPrincipalPortion = 0;
    if(payMode === 'french') {
      if(rateType === 'fixed') {
        var r = rates[0];
        if(r === 0) {
          currentPayment = balance / N;
        } else {
          currentPayment = balance * r / (1 - Math.pow(1+r, -N));
        }
      } else {
        currentPayment = findPaymentForVariable(balance, rates, 0, N);
      }
    } else if(payMode === 'german') {
      currentPrincipalPortion = balance / N;
    }
    var overrideMonths = [];
    for(var i=0; i<rows.length; i++) {
      var payVal = parseFloatLocale(rows[i].cells[2].innerText);
      var extraVal = parseFloatLocale(rows[i].cells[5].innerText);
      if(Math.abs(payVal - originalSchedule[i].payment) > 1e-2) {
        overrideMonths.push(i+1);
      } else if(Math.abs(extraVal - (originalSchedule[i].extra || 0)) > 1e-2) {
        overrideMonths.push(i+1);
      }
    }
    overrideMonths = [...new Set(overrideMonths)].sort((a,b) => a - b);
    var nextOverrideIndex = 0;
    var nextOverrideMonth = overrideMonths.length ? overrideMonths[0] : null;
    for(var m=1; m<=N; m++) {
      var startBal = balance;
      var interest = startBal * rates[m-1];
      var payment = 0;
      var principalPay = 0;
      var extraPay = 0;
      if(nextOverrideMonth && m === nextOverrideMonth) {
        var overridePayVal = parseFloatLocale(rows[m-1].cells[2].innerText);
        payment = overridePayVal || currentPayment;
      } else {
        if(payMode === 'french') {
          payment = currentPayment;
        }
      }
      if(payMode === 'french') {
        if(m === N) {
          payment = balance * (1 + rates[m-1]);
        }
        if(payment < interest) payment = interest;
        principalPay = payment - interest;
      } else if(payMode === 'german') {
        principalPay = currentPrincipalPortion;
        if(principalPay > balance) principalPay = balance;
        payment = principalPay + interest;
      }
      balance = startBal - principalPay;
      var extraVal = parseFloatLocale(rows[m-1].cells[5].innerText);
      if(extraVal) {
        extraPay = extraVal;
        balance -= extraPay;
      }
      var endBal = balance;
      if(endBal < 1e-8) endBal = 0;
      newSchedule.push({
        month: m,
        start: startBal,
        payment: payment,
        interest: interest,
        principal: principalPay,
        extra: extraPay,
        end: endBal
      });
      balance = endBal;
      if(nextOverrideMonth && m === nextOverrideMonth) {
        nextOverrideIndex++;
        nextOverrideMonth = overrideMonths[nextOverrideIndex] || null;
        var remainingMonths = N - m;
        if(remainingMonths > 0) {
          if(payMode === 'french') {
            if(rateType === 'fixed') {
              var r_next = rates[m];
              if(r_next === 0) {
                currentPayment = balance / remainingMonths;
              } else {
                currentPayment = balance * r_next / (1 - Math.pow(1+r_next, -remainingMonths));
              }
            } else {
              currentPayment = findPaymentForVariable(balance, rates, m, remainingMonths);
            }
          } else if(payMode === 'german') {
            currentPrincipalPortion = remainingMonths > 0 ? balance / remainingMonths : 0;
          }
        }
      }
      if(endBal === 0) {
        for(var k=m+1; k<=N; k++) {
          newSchedule.push({
            month: k,
            start: 0,
            payment: 0,
            interest: 0,
            principal: 0,
            extra: 0,
            end: 0
          });
        }
        break;
      }
    }
    originalSchedule = newSchedule;
    renderSchedule(newSchedule);
    updateSummaryAndCharts(newSchedule);
  });
  
  // Export CSV
  document.getElementById('btnExportCSV').addEventListener('click', function(){
    if(!originalSchedule.length) return;
    var csv = 'Mes,Saldo Inicial,Pago Total,Interés,Capital,Abono a Capital,Saldo Final\n';
    originalSchedule.forEach(function(r) {
      csv += r.month + ',' +
             r.start.toFixed(2) + ',' +
             r.payment.toFixed(2) + ',' +
             r.interest.toFixed(2) + ',' +
             r.principal.toFixed(2) + ',' +
             (r.extra ? r.extra.toFixed(2) : '0.00') + ',' +
             r.end.toFixed(2) + '\n';
    });
    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    saveAs(blob, 'amortizacion.csv');
  });
  
  // Export PDF
  document.getElementById('btnExportPDF').addEventListener('click', function(){
    if(!originalSchedule.length) return;
    var doc = new jsPDF();
    doc.autoTable({ html: '#amortTable', theme: 'grid', styles: { font: 'helvetica', fontSize: 10 } });
    doc.save('amortizacion.pdf');
  });
  
  // Restore saved inputs on load
  window.addEventListener('load', function(){
    try {
      var saved = JSON.parse(localStorage.getItem('loanCalcData'));
      if(saved) {
        document.getElementById('principal').value = saved.principal;
        document.getElementById('term').value = saved.term;
        document.getElementById('interestRate').value = saved.interestRate;
        if(saved.rateType === 'variable') {
          document.getElementById('rateVariable').checked = true;
        } else {
          document.getElementById('rateFixed').checked = true;
        }
        if(saved.payMode === 'german') {
          document.getElementById('modeGerman').checked = true;
        } else {
          document.getElementById('modeFrench').checked = true;
        }
      }
    } catch(e) {}
  });
})();
</script>
</body>
</html>
