<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Premios de Lotería - Estilo Neón</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================= */
        /*     VARIABLES CSS THEMES      */
        /* ============================= */
        :root {
            /* MODO CLARO - Colores Crema/Beige */
            --light-bg-primary: #faf7f2;
            --light-bg-secondary: #f5f1eb;
            --light-bg-accent: #ede5d8;
            --light-text-primary: #3c2e26;
            --light-text-secondary: #6b5b4f;
            --light-accent: #d4a574;
            --light-accent-hover: #c49660;
            --light-border: #e0d3c4;
            --light-shadow: rgba(212, 165, 116, 0.2);
            
            /* MODO OSCURO - Colores Neón */
            --dark-bg-primary: #0a0a0a;
            --dark-bg-secondary: #1e1e1e;
            --dark-bg-accent: #2a2a2a;
            --dark-text-primary: #ffffff;
            --dark-text-secondary: #cccccc;
            --dark-neon-cyan: #00ffff;
            --dark-neon-purple: #ff00ff;
            --dark-neon-green: #39ff14;
            --dark-neon-red: #ff0044;
            --dark-border: #00ffff;
            
            /* Variables activas (se cambian con toggle) */
            --bg-primary: var(--light-bg-primary);
            --bg-secondary: var(--light-bg-secondary);
            --bg-accent: var(--light-bg-accent);
            --text-primary: var(--light-text-primary);
            --text-secondary: var(--light-text-secondary);
            --accent: var(--light-accent);
            --accent-hover: var(--light-accent-hover);
            --border: var(--light-border);
            --shadow: var(--light-shadow);
        }

        /* Aplicar tema oscuro */
        .dark-theme {
            --bg-primary: var(--dark-bg-primary);
            --bg-secondary: var(--dark-bg-secondary);
            --bg-accent: var(--dark-bg-accent);
            --text-primary: var(--dark-text-primary);
            --text-secondary: var(--dark-text-secondary);
            --accent: var(--dark-neon-cyan);
            --accent-hover: var(--dark-neon-cyan);
            --border: var(--dark-border);
            --shadow: var(--dark-neon-cyan);
        }

        /* ============================= */
        /*       ESTILOS GLOBALES        */
        /* ============================= */
        * {
            transition: all 0.3s ease;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Montserrat', 'Poppins', sans-serif;
            line-height: 1.6;
        }

        /* ============================= */
        /*        CONTENEDORES           */
        /* ============================= */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 15px;
            box-shadow: 0 8px 32px var(--shadow);
        }

        .dark-theme .glass-container {
            background: rgba(30, 30, 30, 0.95);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
        }

        /* ============================= */
        /*          TÍTULOS              */
        /* ============================= */
        .neon-title {
            color: var(--accent);
            font-weight: 600;
        }

        .dark-theme .neon-title {
            text-shadow: 0 0 10px var(--dark-neon-cyan);
            animation: glow-pulse 2s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from { text-shadow: 0 0 10px var(--dark-neon-cyan); }
            to { text-shadow: 0 0 20px var(--dark-neon-cyan), 0 0 30px var(--dark-neon-cyan); }
        }

        /* ============================= */
        /*          BOTONES              */
        /* ============================= */
        .btn-neon {
            background: var(--accent);
            color: var(--bg-primary);
            border: 2px solid var(--accent);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-neon:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .dark-theme .btn-neon {
            box-shadow: 0 0 10px var(--dark-neon-cyan);
        }

        .dark-theme .btn-neon:hover {
            box-shadow: 0 0 20px var(--dark-neon-cyan);
            transform: scale(1.05) translateY(-2px);
        }

        /* Botón de éxito con pulso */
        .btn-success-neon {
            background: var(--dark-neon-green);
            color: #000;
            border: 2px solid var(--dark-neon-green);
        }

        .dark-theme .btn-success-neon {
            box-shadow: 0 0 10px var(--dark-neon-green);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 10px var(--dark-neon-green); }
            50% { box-shadow: 0 0 20px var(--dark-neon-green), 0 0 30px var(--dark-neon-green); }
            100% { box-shadow: 0 0 10px var(--dark-neon-green); }
        }

        /* Botón de peligro */
        .btn-danger-neon {
            background: var(--dark-neon-red);
            color: #fff;
            border: 2px solid var(--dark-neon-red);
        }

        .dark-theme .btn-danger-neon {
            box-shadow: 0 0 10px var(--dark-neon-red);
        }

        .dark-theme .btn-danger-neon:hover {
            box-shadow: 0 0 20px var(--dark-neon-red);
            transform: scale(1.05);
        }

        /* ============================= */
        /*          INPUTS               */
        /* ============================= */
        .input-neon {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .input-neon:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--shadow);
        }

        .dark-theme .input-neon {
            background: var(--dark-bg-secondary);
            border-color: var(--dark-neon-cyan);
        }

        .dark-theme .input-neon:focus {
            border-color: var(--dark-neon-purple);
            box-shadow: 0 0 15px var(--dark-neon-purple);
        }

        /* Placeholder styles */
        .input-neon::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* ============================= */
        /*          TARJETAS             */
        /* ============================= */
        .card-neon {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow);
            overflow: hidden;
        }

        .dark-theme .card-neon {
            background: var(--dark-bg-secondary);
            border-color: var(--dark-neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }

        .card-neon:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .dark-theme .card-neon:hover {
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }

        /* ============================= */
        /*          MÉTRICAS             */
        /* ============================= */
        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-accent));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .dark-theme .metric-card {
            background: linear-gradient(135deg, var(--dark-bg-secondary), var(--dark-bg-accent));
            border-color: var(--dark-neon-cyan);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .dark-theme .metric-value {
            text-shadow: 0 0 10px var(--dark-neon-cyan);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px var(--shadow));
        }

        .dark-theme .metric-icon {
            filter: drop-shadow(0 0 10px var(--dark-neon-cyan));
        }

        /* ============================= */
        /*          TABLAS               */
        /* ============================= */
        .table-neon {
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .dark-theme .table-neon {
            background: var(--dark-bg-secondary);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }

        .table-neon th {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
            padding: 15px;
            border: none;
        }

        .dark-theme .table-neon th {
            background: var(--dark-bg-accent);
            color: var(--dark-neon-cyan);
            text-shadow: 0 0 5px var(--dark-neon-cyan);
            border-bottom: 1px solid var(--dark-neon-cyan);
        }

        .table-neon td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }

        .dark-theme .table-neon td {
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .table-neon tbody tr:hover {
            background: var(--bg-accent);
        }

        .dark-theme .table-neon tbody tr:hover {
            background: rgba(0, 255, 255, 0.1);
        }

        /* ============================= */
        /*          PESTAÑAS             */
        /* ============================= */
        .tab-neon {
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 8px 8px 0 0;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-neon:hover {
            background: var(--bg-accent);
            color: var(--text-primary);
        }

        .tab-neon.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .dark-theme .tab-neon {
            background: var(--dark-bg-secondary);
            border-color: transparent;
        }

        .dark-theme .tab-neon:hover {
            background: var(--dark-bg-accent);
            color: var(--dark-neon-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .dark-theme .tab-neon.active {
            background: var(--dark-bg-accent);
            color: var(--dark-neon-cyan);
            border-color: var(--dark-neon-cyan);
            box-shadow: 0 0 15px var(--dark-neon-cyan);
            text-shadow: 0 0 5px var(--dark-neon-cyan);
        }

        /* ============================= */
        /*          MODALES              */
        /* ============================= */
        .modal-neon {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content-neon {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 15px;
            box-shadow: 0 20px 40px var(--shadow);
        }

        .dark-theme .modal-content-neon {
            background: var(--dark-bg-primary);
            border-color: var(--dark-neon-cyan);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        /* ============================= */
        /*        TOGGLE THEME           */
        /* ============================= */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-accent);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .dark-theme .theme-toggle {
            background: var(--dark-bg-accent);
            border-color: var(--dark-neon-cyan);
            box-shadow: 0 0 10px var(--dark-neon-cyan);
        }

        .dark-theme .theme-toggle:before {
            background: var(--dark-neon-cyan);
            transform: translateX(28px);
            box-shadow: 0 0 10px var(--dark-neon-cyan);
        }

        /* ============================= */
        /*          BADGES               */
        /* ============================= */
        .badge-neon {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .dark-theme .badge-pending {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
            border: 1px solid #ffff00;
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
        }

        .badge-approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .dark-theme .badge-approved {
            background: rgba(57, 255, 20, 0.2);
            color: var(--dark-neon-green);
            border: 1px solid var(--dark-neon-green);
            box-shadow: 0 0 5px rgba(57, 255, 20, 0.5);
        }

        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .dark-theme .badge-rejected {
            background: rgba(255, 0, 68, 0.2);
            color: var(--dark-neon-red);
            border: 1px solid var(--dark-neon-red);
            box-shadow: 0 0 5px rgba(255, 0, 68, 0.5);
        }

        .badge-no-win {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .dark-theme .badge-no-win {
            background: rgba(255, 255, 255, 0.1);
            color: var(--dark-text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ============================= */
        /*        ANIMACIONES            */
        /* ============================= */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* ============================= */
        /*        RESPONSIVE             */
        /* ============================= */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 1.5rem;
            }
            
            .metric-icon {
                font-size: 2rem;
            }
            
            .tab-neon {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }

        /* ============================= */
        /*        SCROLLBAR              */
        /* ============================= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .dark-theme ::-webkit-scrollbar-thumb {
            background: var(--dark-neon-cyan);
            box-shadow: 0 0 5px var(--dark-neon-cyan);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        /* ============================= */
        /*      EFECTOS ESPECIALES       */
        /* ============================= */
        .glow-effect {
            position: relative;
        }

        .dark-theme .glow-effect:before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, var(--dark-neon-cyan), var(--dark-neon-purple), var(--dark-neon-green));
            border-radius: inherit;
            z-index: -1;
            opacity: 0.7;
            filter: blur(4px);
        }

        /* Efecto de partículas para modo oscuro */
        .dark-theme body:before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, var(--dark-neon-cyan), transparent),
                radial-gradient(2px 2px at 40px 70px, var(--dark-neon-purple), transparent),
                radial-gradient(1px 1px at 90px 40px, var(--dark-neon-green), transparent);
            background-repeat: repeat;
            background-size: 200px 200px;
            animation: sparkle 20s linear infinite;
            pointer-events: none;
            opacity: 0.1;
            z-index: -1;
        }

        @keyframes sparkle {
            0% { transform: translateY(0); }
            100% { transform: translateY(-200px); }
        }

        /* Efectos de entrada */
        .slide-in-left {
            animation: slideInLeft 0.5s ease-out;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Efecto de hover para las tarjetas en modo oscuro */
        .dark-theme .card-neon:hover {
            box-shadow: 
                0 0 20px var(--dark-neon-cyan),
                0 0 40px rgba(0, 255, 255, 0.2),
                0 0 60px rgba(0, 255, 255, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header with Theme Toggle -->
    <header class="glass-container mx-4 my-4 p-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold neon-title">🎰 Calculadora de Premios</h1>
                <span class="badge-neon badge-approved">VERSIÓN NEÓN</span>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Theme Toggle Button -->
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium" style="color: var(--text-secondary);">☀️ Claro</span>
                    <div class="theme-toggle" id="theme-toggle" title="Cambiar tema"></div>
                    <span class="text-sm font-medium" style="color: var(--text-secondary);">🌙 Oscuro</span>
                </div>
                <button id="export-excel-btn" class="btn-neon">
                    <span class="mr-2">📊</span>Exportar Excel
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="mx-4 mb-6">
        <div class="flex space-x-2 overflow-x-auto">
            <button class="tab-neon active" data-game="PICK3">PICK3</button>
            <button class="tab-neon" data-game="WIN4">WIN4</button>
            <button class="tab-neon" data-game="VENEZUELA">VENEZUELA</button>
            <button class="tab-neon" data-game="PULITO">PULITO</button>
            <button class="tab-neon" data-game="SD">SD</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="mx-4 space-y-6">
        <!-- Control Panel -->
        <div class="card-neon p-6 fade-in">
            <h2 class="text-xl font-semibold neon-title mb-6">🎮 Panel de Control</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Manual Play Entry -->
                <button id="add-play-btn" class="p-6 border-2 border-dashed rounded-lg transition-all hover:scale-105" style="border-color: var(--border); background: var(--bg-accent);">
                    <div class="text-center">
                        <div class="text-3xl mb-2">➕</div>
                        <p class="font-medium" style="color: var(--text-primary);">Agregar Jugada</p>
                        <p class="text-sm" style="color: var(--text-secondary);">Manual</p>
                    </div>
                </button>

                <!-- Excel/CSV Import -->
                <button id="import-excel-btn" class="p-6 border-2 border-dashed rounded-lg transition-all hover:scale-105" style="border-color: var(--border); background: var(--bg-accent);">
                    <div class="text-center">
                        <div class="text-3xl mb-2">📂</div>
                        <p class="font-medium" style="color: var(--text-primary);">Importar Excel</p>
                        <p class="text-sm" style="color: var(--text-secondary);">Archivo CSV/XLSX</p>
                    </div>
                </button>

                <!-- Scraper Integration -->
                <button id="scraper-sync-btn" class="p-6 border-2 border-dashed rounded-lg opacity-50 transition-all" style="border-color: var(--border); background: var(--bg-accent);" disabled>
                    <div class="text-center">
                        <div class="text-3xl mb-2">🔄</div>
                        <p class="font-medium" style="color: var(--text-primary);">Sincronizar</p>
                        <p class="text-sm" style="color: var(--text-secondary);">Módulo Scraper</p>
                    </div>
                </button>

                <!-- Recalculate All -->
                <button id="recalculate-btn" class="btn-success-neon p-6 rounded-lg transition-all hover:scale-105">
                    <div class="text-center">
                        <div class="text-3xl mb-2">🧮</div>
                        <p class="font-medium">Recalcular</p>
                        <p class="text-sm">Todos los premios</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Metrics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 slide-in-left">
            <div class="metric-card bounce-in">
                <div class="metric-icon">💰</div>
                <p class="text-sm" style="color: var(--text-secondary);">Total Apostado</p>
                <p id="total-wagered" class="metric-value">$0.00</p>
            </div>

            <div class="metric-card bounce-in" style="animation-delay: 0.1s">
                <div class="metric-icon">🏆</div>
                <p class="text-sm" style="color: var(--text-secondary);">A Pagar</p>
                <p id="total-prizes" class="metric-value text-green-500">$0.00</p>
            </div>

            <div class="metric-card bounce-in" style="animation-delay: 0.2s">
                <div class="metric-icon">📊</div>
                <p class="text-sm" style="color: var(--text-secondary);">ROI</p>
                <p id="roi" class="metric-value text-blue-500">0%</p>
            </div>

            <div class="metric-card bounce-in" style="animation-delay: 0.3s">
                <div class="metric-icon">⏳</div>
                <p class="text-sm" style="color: var(--text-secondary);">Pendientes</p>
                <p id="pending-prizes" class="metric-value text-yellow-500">0</p>
            </div>

            <div class="metric-card bounce-in" style="animation-delay: 0.4s">
                <div class="metric-icon">✅</div>
                <p class="text-sm" style="color: var(--text-secondary);">Aprobados</p>
                <p id="approved-prizes" class="metric-value text-green-500">0</p>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Prize Table -->
            <div class="card-neon slide-in-left">
                <div class="p-4 border-b" style="border-color: var(--border);">
                    <h3 class="text-lg font-semibold neon-title">💎 Tabla de Premios</h3>
                    <p class="text-sm" style="color: var(--text-secondary);">Premios por $1 apostado (editable)</p>
                </div>
                <div id="prize-table-container" class="p-4 max-h-96 overflow-y-auto"></div>
            </div>

            <!-- Winning Numbers -->
            <div class="card-neon slide-in-right">
                <div class="p-4 border-b flex justify-between items-center" style="border-color: var(--border);">
                    <div>
                        <h3 class="text-lg font-semibold neon-title">🏆 Números Ganadores</h3>
                    </div>
                    <button id="add-winner-btn" class="btn-neon">+ Agregar</button>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <div class="table-neon">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Juego</th>
                                    <th>Números</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="winners-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Plays List -->
            <div class="card-neon fade-in">
                <div class="p-4 border-b" style="border-color: var(--border);">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold neon-title">🎮 Jugadas</h3>
                        <div class="flex space-x-2">
                            <button id="approve-all-btn" class="btn-success-neon text-sm px-3 py-1 rounded">
                                ✅ Aprobar Todas
                            </button>
                            <button id="filter-toggle-btn" class="btn-neon text-sm px-3 py-1 rounded">
                                🔍 Filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Panel -->
                    <div id="filter-panel" class="hidden p-4 rounded-lg" style="background: var(--bg-accent);">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="filter-game" class="input-neon">
                                <option value="">Todos los juegos</option>
                                <option value="PICK3">PICK3</option>
                                <option value="WIN4">WIN4</option>
                                <option value="VENEZUELA">VENEZUELA</option>
                                <option value="PULITO">PULITO</option>
                                <option value="SD">SD</option>
                            </select>
                            <select id="filter-status" class="input-neon">
                                <option value="">Todos los estados</option>
                                <option value="PENDING">Pendientes</option>
                                <option value="APPROVED">Aprobados</option>
                                <option value="REJECTED">Rechazados</option>
                                <option value="NO_WIN">Sin premio</option>
                            </select>
                            <input type="date" id="filter-date" class="input-neon">
                        </div>
                    </div>
                </div>
                <div id="plays-container" class="max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </main>

    <!-- Add Play Modal -->
    <div id="add-play-modal" class="modal-neon fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-content-neon max-w-md w-full mx-4 p-6">
            <div class="mb-6">
                <h3 class="text-xl font-semibold neon-title">Agregar Nueva Jugada</h3>
            </div>
            <form id="add-play-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Fecha</label>
                        <input type="date" name="date" class="input-neon w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Estado</label>
                        <select name="state" class="input-neon w-full" required>
                            <option value="FL">Florida</option>
                            <option value="NY">New York</option>
                            <option value="VE">Venezuela</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Sorteo</label>
                        <select name="draw" class="input-neon w-full" required>
                            <option value="MID">Mediodía</option>
                            <option value="EVE">Noche</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Juego</label>
                        <select name="game" id="play-game-select" class="input-neon w-full" required>
                            <option value="PICK3">PICK3</option>
                            <option value="WIN4">WIN4</option>
                            <option value="VENEZUELA">VENEZUELA</option>
                            <option value="PULITO">PULITO</option>
                            <option value="SD">SD</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tipo de Apuesta</label>
                    <select name="betType" id="bet-type-select" class="input-neon w-full" required></select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Números</label>
                    <input type="text" name="numbers" id="numbers-input" placeholder="Ej: 123, 12-34-56" class="input-neon w-full" required>
                    <p id="numbers-help" class="mt-1 text-xs" style="color: var(--text-secondary);">Formato según el juego seleccionado</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Apuesta ($)</label>
                        <input type="number" name="wager" step="0.01" min="0.01" class="input-neon w-full" required>
                    </div>
                    <div id="position-container" class="hidden">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Posición</label>
                        <select name="position" class="input-neon w-full">
                            <option value="1">Primera</option>
                            <option value="2">Segunda</option>
                            <option value="3">Tercera</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('add-play-modal')" class="btn-neon px-4 py-2">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-success-neon px-4 py-2">
                        Agregar Jugada
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div id="import-excel-modal" class="modal-neon fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-content-neon max-w-lg w-full mx-4 p-6">
            <div class="mb-6">
                <h3 class="text-xl font-semibold neon-title">Importar Jugadas desde Excel/CSV</h3>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Seleccionar Archivo</label>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" class="input-neon w-full">
                </div>
                
                <div class="p-4 rounded-lg" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3);">
                    <h4 class="text-sm font-medium text-blue-600 dark:text-blue-400">Formato Esperado:</h4>
                    <ul class="mt-2 text-xs text-blue-700 dark:text-blue-300 space-y-1">
                        <li>• <strong>Fecha</strong>: YYYY-MM-DD</li>
                        <li>• <strong>Modalidad de Juego</strong>: Peak 3, Win 4, Venezuela, etc.</li>
                        <li>• <strong>Track</strong>: Estado, Sorteo (Ej: NYS, MID-DAY)</li>
                        <li>• <strong>Número</strong>: Números de la jugada</li>
                        <li>• <strong>Straight/Box</strong>: Montos de apuesta</li>
                    </ul>
                </div>

                <div id="import-preview" class="hidden">
                    <h4 class="text-sm font-medium" style="color: var(--text-secondary);">Vista Previa (primeras 5 filas):</h4>
                    <div id="preview-table" class="mt-2 max-h-48 overflow-auto table-neon"></div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('import-excel-modal')" class="btn-neon px-4 py-2">
                        Cancelar
                    </button>
                    <button type="button" id="confirm-import-btn" class="btn-success-neon px-4 py-2 disabled:opacity-50" disabled>
                        Importar Jugadas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Winner Modal -->
    <div id="add-winner-modal" class="modal-neon fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-content-neon max-w-md w-full mx-4 p-6">
            <div class="mb-6">
                <h3 class="text-xl font-semibold neon-title">Agregar Número Ganador</h3>
            </div>
            <form id="add-winner-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Fecha</label>
                    <input type="date" name="date" class="input-neon w-full" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Estado</label>
                        <select name="state" class="input-neon w-full" required>
                            <option value="FL">Florida</option>
                            <option value="NY">New York</option>
                            <option value="VE">Venezuela</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Sorteo</label>
                        <select name="draw" class="input-neon w-full" required>
                            <option value="MID">Mediodía</option>
                            <option value="EVE">Noche</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Juego</label>
                    <select name="game" id="winner-game-select" class="input-neon w-full" required>
                        <option value="PICK3">PICK3</option>
                        <option value="WIN4">WIN4</option>
                        <option value="VENEZUELA">VENEZUELA</option>
                        <option value="PULITO">PULITO</option>
                        <option value="SD">SD</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Números Ganadores</label>
                    <input type="text" name="numbers" id="winner-numbers-input" placeholder="Ej: 123 o 12-34-56" class="input-neon w-full" required>
                    <p id="winner-numbers-help" class="mt-1 text-xs" style="color: var(--text-secondary);">Formato según el juego seleccionado</p>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('add-winner-modal')" class="btn-neon px-4 py-2">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-success-neon px-4 py-2">
                        Agregar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Prize Confirmation Modal -->
    <div id="prize-modal" class="modal-neon fixed inset-0 hidden items-center justify-center z-50">
        <div class="modal-content-neon max-w-lg w-full mx-4 p-6">
            <div class="mb-6">
                <h3 class="text-xl font-semibold neon-title">Confirmar Premio</h3>
            </div>
            <div id="prize-details" class="space-y-3 mb-6"></div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('prize-modal')" class="btn-neon px-4 py-2">
                    Cerrar
                </button>
                <button type="button" id="reject-prize-btn" class="btn-danger-neon px-4 py-2">
                    Rechazar
                </button>
                <button type="button" id="approve-prize-btn" class="btn-success-neon px-4 py-2">
                    Aprobar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // THEME SYSTEM
        // ==========================================
        class ThemeManager {
            constructor() {
                this.isDark = localStorage.getItem('theme') === 'dark';
                this.init();
            }

            init() {
                this.applyTheme();
                this.setupToggle();
            }

            applyTheme() {
                const body = document.body;
                const toggle = document.getElementById('theme-toggle');
                
                if (this.isDark) {
                    body.classList.add('dark-theme');
                } else {
                    body.classList.remove('dark-theme');
                }
                
                // Save preference
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
            }

            setupToggle() {
                const toggle = document.getElementById('theme-toggle');
                toggle.addEventListener('click', () => {
                    this.toggle();
                });
            }

            toggle() {
                this.isDark = !this.isDark;
                this.applyTheme();
                
                // Add animation effect
                document.body.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    document.body.style.transition = '';
                }, 300);
            }
        }

        // ==========================================
        // TOAST NOTIFICATIONS WITH NEON STYLE
        // ==========================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const isDark = document.body.classList.contains('dark-theme');
            
            let bgColor, textColor, glowEffect = '';
            
            switch (type) {
                case 'success':
                    bgColor = isDark ? 'rgba(57, 255, 20, 0.9)' : '#d4edda';
                    textColor = isDark ? '#000' : '#155724';
                    glowEffect = isDark ? 'box-shadow: 0 0 20px rgba(57, 255, 20, 0.5);' : '';
                    break;
                case 'error':
                    bgColor = isDark ? 'rgba(255, 0, 68, 0.9)' : '#f8d7da';
                    textColor = isDark ? '#fff' : '#721c24';
                    glowEffect = isDark ? 'box-shadow: 0 0 20px rgba(255, 0, 68, 0.5);' : '';
                    break;
                case 'warning':
                    bgColor = isDark ? 'rgba(255, 255, 0, 0.9)' : '#fff3cd';
                    textColor = isDark ? '#000' : '#856404';
                    glowEffect = isDark ? 'box-shadow: 0 0 20px rgba(255, 255, 0, 0.5);' : '';
                    break;
                default:
                    bgColor = isDark ? 'rgba(0, 255, 255, 0.9)' : '#d1ecf1';
                    textColor = isDark ? '#000' : '#0c5460';
                    glowEffect = isDark ? 'box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);' : '';
            }
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: ${textColor};
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 500;
                z-index: 1000;
                transform: translateX(100%);
                transition: all 0.3s ease;
                border: 2px solid ${bgColor};
                ${glowEffect}
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Slide in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Slide out and remove
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ==========================================
        // PRIZE TABLE CONFIGURATION
        // ==========================================
        const DEFAULT_PRIZE_TABLE = {
            PICK3: {
                STRAIGHT: 700,
                BOX_3WAY: 232,
                BOX_6WAY: 116,
                STRAIGHT_TRIPLE: 500,
                BOX_TRIPLE: 500
            },
            WIN4: {
                STRAIGHT: 5000,
                BOX_24WAY: 200,
                BOX_1COUPLE: 400,
                BOX_DOUBLECOUPLE: 800,
                BOX_TRIPLE: 1200,
                STRAIGHT_OTHER_ST: 2500,
                BOX_OTHER_ST: 100
            },
            VENEZUELA: {
                QUINIELA_PRIMERA: 55,
                QUINIELA_SEGUNDA: 15,
                QUINIELA_TERCERA: 10,
                PALE_FULL: 700,
                PALE_BOX: 175
            },
            PULITO: {
                STRAIGHT: 80,
                BOX: 40
            },
            SD: {
                QUINIELA_PRIMERA: 56,
                QUINIELA_SEGUNDA: 12,
                QUINIELA_TERCERA: 4,
                PALE_FULL: 1300,
                PALE_PARCIAL: 200,
                PALE_BOX: 325
            }
        };

        // BET TYPE OPTIONS BY GAME
        const BET_TYPE_OPTIONS = {
            PICK3: [
                { value: 'STRAIGHT', label: 'Straight (Exact Order)' },
                { value: 'BOX_3WAY', label: 'Box (3-Way/Doble)' },
                { value: 'BOX_6WAY', label: 'Box (6-Way)' },
                { value: 'STRAIGHT_TRIPLE', label: 'Straight Triple' },
                { value: 'BOX_TRIPLE', label: 'Box Triple' }
            ],
            WIN4: [
                { value: 'STRAIGHT', label: 'Straight' },
                { value: 'BOX_24WAY', label: 'Box (24-Way)' },
                { value: 'BOX_1COUPLE', label: 'Box (1 Couple)' },
                { value: 'BOX_DOUBLECOUPLE', label: 'Box (Double Couple)' },
                { value: 'BOX_TRIPLE', label: 'Box (Triple)' },
                { value: 'STRAIGHT_OTHER_ST', label: 'Straight Other State' },
                { value: 'BOX_OTHER_ST', label: 'Box Other State' }
            ],
            VENEZUELA: [
                { value: 'QUINIELA_PRIMERA', label: 'Quiniela Primera' },
                { value: 'QUINIELA_SEGUNDA', label: 'Quiniela Segunda' },
                { value: 'QUINIELA_TERCERA', label: 'Quiniela Tercera' },
                { value: 'PALE_FULL', label: 'Pale Full' },
                { value: 'PALE_BOX', label: 'Pale Box' }
            ],
            PULITO: [
                { value: 'STRAIGHT', label: 'Straight' },
                { value: 'BOX', label: 'Box' }
            ],
            SD: [
                { value: 'QUINIELA_PRIMERA', label: 'Quiniela Primera' },
                { value: 'QUINIELA_SEGUNDA', label: 'Quiniela Segunda' },
                { value: 'QUINIELA_TERCERA', label: 'Quiniela Tercera' },
                { value: 'PALE_FULL', label: 'Pale Full' },
                { value: 'PALE_PARCIAL', label: 'Pale Parcial' },
                { value: 'PALE_BOX', label: 'Pale Box' }
            ]
        };

        // SAMPLE DATA
        const SAMPLE_PLAYS = [
            {
                _id: "play001",
                userId: "user1",
                date: "2024-01-15",
                state: "FL",
                draw: "MID",
                game: "PICK3",
                betType: "STRAIGHT",
                numbers: "123",
                wager: 1.00
            },
            {
                _id: "play002",
                userId: "user1",
                date: "2024-01-15",
                state: "FL",
                draw: "EVE",
                game: "WIN4",
                betType: "BOX_24WAY",
                numbers: "1234",
                wager: 0.50
            },
            {
                _id: "play003",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                betType: "QUINIELA_PRIMERA",
                numbers: "12",
                wager: 2.00,
                extra: { position: 1 }
            },
            {
                _id: "play004",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                betType: "QUINIELA_SEGUNDA",
                numbers: "34",
                wager: 1.00,
                extra: { position: 2 }
            },
            {
                _id: "play005",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "EVE",
                game: "PULITO",
                betType: "STRAIGHT",
                numbers: "56",
                wager: 1.50
            },
            {
                _id: "play006",
                userId: "user3",
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                betType: "PALE_FULL",
                numbers: "78-90-12",
                wager: 1.00
            },
            {
                _id: "play007",
                userId: "user3",
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                betType: "QUINIELA_PRIMERA",
                numbers: "78",
                wager: 0.75,
                extra: { position: 1 }
            },
            {
                _id: "play008",
                userId: "user4",
                date: "2024-01-15",
                state: "NY",
                draw: "MID",
                game: "PICK3",
                betType: "BOX_3WAY",
                numbers: "112",
                wager: 2.00
            }
        ];

        const SAMPLE_WINNERS = [
            {
                date: "2024-01-15",
                state: "FL",
                draw: "MID",
                game: "PICK3",
                numbers: "123"
            },
            {
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                numbers: "12-34-56"
            },
            {
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                numbers: "78-90-12"
            }
        ];

        // ==========================================
        // PRIZE CALCULATION ENGINE (Same as before)
        // ==========================================
        class PrizeCalculator {
            static calculatePrize(play, winner) {
                if (play.date !== winner.date || 
                    play.state !== winner.state || 
                    play.draw !== winner.draw || 
                    play.game !== winner.game) {
                    return { hit: false, amount: 0 };
                }

                const prizeTable = JSON.parse(localStorage.getItem('prizeTable') || JSON.stringify(DEFAULT_PRIZE_TABLE));
                const gameTable = prizeTable[play.game];
                
                if (!gameTable || !gameTable[play.betType]) {
                    return { hit: false, amount: 0 };
                }

                switch (play.game) {
                    case 'PICK3':
                        return this.calculatePick3Prize(play, winner, gameTable);
                    case 'WIN4':
                        return this.calculateWin4Prize(play, winner, gameTable);
                    case 'VENEZUELA':
                        return this.calculateVenezuelaPrize(play, winner, gameTable);
                    case 'PULITO':
                        return this.calculatePulitoPrize(play, winner, gameTable);
                    case 'SD':
                        return this.calculateSDPrize(play, winner, gameTable);
                    default:
                        return { hit: false, amount: 0 };
                }
            }

            static calculatePick3Prize(play, winner, gameTable) {
                const playNumbers = play.numbers.replace(/\D/g, '');
                const winNumbers = winner.numbers.replace(/\D/g, '');
                
                if (playNumbers.length !== 3 || winNumbers.length !== 3) {
                    return { hit: false, amount: 0 };
                }

                switch (play.betType) {
                    case 'STRAIGHT':
                    case 'STRAIGHT_TRIPLE':
                        if (playNumbers === winNumbers) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                        
                    case 'BOX_3WAY':
                    case 'BOX_6WAY':
                    case 'BOX_TRIPLE':
                        const playDigits = playNumbers.split('').sort();
                        const winDigits = winNumbers.split('').sort();
                        if (playDigits.join('') === winDigits.join('')) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                }
                
                return { hit: false, amount: 0 };
            }

            static calculateWin4Prize(play, winner, gameTable) {
                const playNumbers = play.numbers.replace(/\D/g, '');
                const winNumbers = winner.numbers.replace(/\D/g, '');
                
                if (playNumbers.length !== 4 || winNumbers.length !== 4) {
                    return { hit: false, amount: 0 };
                }

                switch (play.betType) {
                    case 'STRAIGHT':
                    case 'STRAIGHT_OTHER_ST':
                        if (playNumbers === winNumbers) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                        
                    case 'BOX_24WAY':
                    case 'BOX_1COUPLE':
                    case 'BOX_DOUBLECOUPLE':
                    case 'BOX_TRIPLE':
                    case 'BOX_OTHER_ST':
                        const playDigits = playNumbers.split('').sort();
                        const winDigits = winNumbers.split('').sort();
                        if (playDigits.join('') === winDigits.join('')) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                }
                
                return { hit: false, amount: 0 };
            }

            static calculateVenezuelaPrize(play, winner, gameTable) {
                const winNumbers = winner.numbers.split('-');
                
                if (winNumbers.length !== 3) {
                    return { hit: false, amount: 0 };
                }

                const playNumber = play.numbers.replace(/\D/g, '');
                const position = play.extra?.position || 1;

                switch (play.betType) {
                    case 'QUINIELA_PRIMERA':
                        if (position === 1 && winNumbers[0] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_PRIMERA };
                        }
                        break;
                        
                    case 'QUINIELA_SEGUNDA':
                        if (position === 2 && winNumbers[1] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_SEGUNDA };
                        }
                        break;
                        
                    case 'QUINIELA_TERCERA':
                        if (position === 3 && winNumbers[2] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_TERCERA };
                        }
                        break;
                        
                    case 'PALE_FULL':
                        const playParts = play.numbers.split('-');
                        if (playParts.length === 2) {
                            if ((winNumbers[0] === playParts[0] && winNumbers[1] === playParts[1]) ||
                                (winNumbers[0] === playParts[0] && winNumbers[2] === playParts[1]) ||
                                (winNumbers[1] === playParts[0] && winNumbers[2] === playParts[1])) {
                                return { hit: true, amount: play.wager * gameTable.PALE_FULL };
                            }
                        }
                        break;
                        
                    case 'PALE_BOX':
                        const playBoxParts = play.numbers.split('-');
                        if (playBoxParts.length === 2) {
                            if (winNumbers.includes(playBoxParts[0]) && winNumbers.includes(playBoxParts[1])) {
                                return { hit: true, amount: play.wager * gameTable.PALE_BOX };
                            }
                        }
                        break;
                }
                
                return { hit: false, amount: 0 };
            }

            static calculatePulitoPrize(play, winner, gameTable) {
                const playNumbers = play.numbers.replace(/\D/g, '');
                const winNumbers = winner.numbers.replace(/\D/g, '');
                
                if (playNumbers.length !== 2 || winNumbers.length !== 2) {
                    return { hit: false, amount: 0 };
                }

                switch (play.betType) {
                    case 'STRAIGHT':
                        if (playNumbers === winNumbers) {
                            return { hit: true, amount: play.wager * gameTable.STRAIGHT };
                        }
                        break;
                        
                    case 'BOX':
                        const playDigits = playNumbers.split('').sort();
                        const winDigits = winNumbers.split('').sort();
                        if (playDigits.join('') === winDigits.join('')) {
                            return { hit: true, amount: play.wager * gameTable.BOX };
                        }
                        break;
                }
                
                return { hit: false, amount: 0 };
            }

            static calculateSDPrize(play, winner, gameTable) {
                const winNumbers = winner.numbers.split('-');
                
                if (winNumbers.length !== 3) {
                    return { hit: false, amount: 0 };
                }

                const playNumber = play.numbers.split('-')[0];
                const position = play.extra?.position || 1;

                switch (play.betType) {
                    case 'QUINIELA_PRIMERA':
                        if (position === 1 && winNumbers[0] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_PRIMERA };
                        }
                        break;
                        
                    case 'QUINIELA_SEGUNDA':
                        if (position === 2 && winNumbers[1] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_SEGUNDA };
                        }
                        break;
                        
                    case 'QUINIELA_TERCERA':
                        if (position === 3 && winNumbers[2] === playNumber) {
                            return { hit: true, amount: play.wager * gameTable.QUINIELA_TERCERA };
                        }
                        break;
                        
                    case 'PALE_FULL':
                        const playParts = play.numbers.split('-');
                        if (playParts.length === 3 && play.numbers === winner.numbers) {
                            return { hit: true, amount: play.wager * gameTable.PALE_FULL };
                        }
                        break;
                        
                    case 'PALE_PARCIAL':
                        const playPartialParts = play.numbers.split('-');
                        if (playPartialParts.length >= 2) {
                            let matches = 0;
                            for (let i = 0; i < Math.min(playPartialParts.length, winNumbers.length); i++) {
                                if (playPartialParts[i] === winNumbers[i]) matches++;
                            }
                            if (matches >= 2) {
                                return { hit: true, amount: play.wager * gameTable.PALE_PARCIAL };
                            }
                        }
                        break;
                        
                    case 'PALE_BOX':
                        const playBoxParts = play.numbers.split('-');
                        if (playBoxParts.length >= 2) {
                            let foundMatches = 0;
                            for (const part of playBoxParts) {
                                if (winNumbers.includes(part)) foundMatches++;
                            }
                            if (foundMatches >= 2) {
                                return { hit: true, amount: play.wager * gameTable.PALE_BOX };
                            }
                        }
                        break;
                }
                
                return { hit: false, amount: 0 };
            }
        }

        // ==========================================
        // GAME VALIDATOR
        // ==========================================
        class GameValidator {
            static validatePlay(play) {
                const errors = [];
                
                if (!play.date || !play.state || !play.draw || !play.game || !play.betType) {
                    errors.push('Faltan campos obligatorios');
                }
                
                if (!play.numbers || !this.validateNumbers(play.game, play.numbers)) {
                    errors.push('Formato de números inválido para el juego seleccionado');
                }
                
                if (!play.wager || play.wager <= 0) {
                    errors.push('La apuesta debe ser mayor a 0');
                }
                
                return errors;
            }
            
            static validateNumbers(game, numbers) {
                const cleanNumbers = numbers.replace(/\s/g, '');
                
                switch (game) {
                    case 'PICK3':
                        return /^\d{3}$/.test(cleanNumbers);
                    case 'WIN4':
                        return /^\d{4}$/.test(cleanNumbers);
                    case 'VENEZUELA':
                        return /^\d{2}$/.test(cleanNumbers) || /^\d{2}-\d{2}$/.test(cleanNumbers);
                    case 'PULITO':
                        return /^\d{2}$/.test(cleanNumbers);
                    case 'SD':
                        return /^\d{2}$/.test(cleanNumbers) || /^\d{2}-\d{2}-\d{2}$/.test(cleanNumbers);
                    default:
                        return false;
                }
            }
            
            static getNumbersHelp(game) {
                switch (game) {
                    case 'PICK3':
                        return 'Formato: 123 (3 dígitos)';
                    case 'WIN4':
                        return 'Formato: 1234 (4 dígitos)';
                    case 'VENEZUELA':
                        return 'Formato: 12 (quiniela) o 12-34 (pale)';
                    case 'PULITO':
                        return 'Formato: 12 (2 dígitos)';
                    case 'SD':
                        return 'Formato: 12 (quiniela) o 12-34-56 (pale)';
                    default:
                        return 'Formato según el juego seleccionado';
                }
            }
        }

        // ==========================================
        // STORAGE SERVICE
        // ==========================================
        class StorageService {
            static save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('Storage save error:', error);
                    return false;
                }
            }
            
            static load(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('Storage load error:', error);
                    return defaultValue;
                }
            }
            
            static remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Storage remove error:', error);
                    return false;
                }
            }
        }

        // ==========================================
        // EXCEL IMPORT SERVICE (Same as before)
        // ==========================================
        class ExcelImportService {
            static async parseFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            let sheetName = 'TRANSACTIONS';
                            if (!workbook.SheetNames.includes(sheetName)) {
                                sheetName = workbook.SheetNames[0];
                            }
                            
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            resolve(this.convertToPlays(jsonData));
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('Error reading file'));
                    reader.readAsArrayBuffer(file);
                });
            }
            
            static convertToPlays(rawData) {
                const plays = [];
                
                let headerRowIndex = -1;
                for (let i = 0; i < Math.min(10, rawData.length); i++) {
                    const row = rawData[i];
                    if (row && row.some(cell => 
                        typeof cell === 'string' && 
                        (cell.toLowerCase().includes('fecha') || 
                         cell.toLowerCase().includes('modalidad') ||
                         cell.toLowerCase().includes('número'))
                    )) {
                        headerRowIndex = i;
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    throw new Error('No se encontraron encabezados válidos en el archivo');
                }
                
                const headers = rawData[headerRowIndex];
                const dataRows = rawData.slice(headerRowIndex + 1);
                
                const colMapping = this.mapColumns(headers);
                
                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    if (!row || row.length === 0 || !row[colMapping.fecha]) continue;
                    
                    try {
                        const play = this.convertRowToPlay(row, colMapping, i);
                        if (play) {
                            plays.push(play);
                        }
                    } catch (error) {
                        console.warn(`Error converting row ${i + headerRowIndex + 2}:`, error);
                    }
                }
                
                return plays;
            }
            
            static mapColumns(headers) {
                const mapping = {};
                
                for (let i = 0; i < headers.length; i++) {
                    const header = String(headers[i] || '').toLowerCase();
                    
                    if (header.includes('fecha')) mapping.fecha = i;
                    else if (header.includes('modalidad') || header.includes('juego')) mapping.modalidad = i;
                    else if (header.includes('track') || header.includes('estado')) mapping.track = i;
                    else if (header.includes('número') && !header.includes('ticket')) mapping.numero = i;
                    else if (header.includes('straight')) mapping.straight = i;
                    else if (header.includes('box')) mapping.box = i;
                    else if (header.includes('combo')) mapping.combo = i;
                    else if (header.includes('ticket')) mapping.ticket = i;
                }
                
                return mapping;
            }
            
            static convertRowToPlay(row, colMapping, index) {
                const fecha = this.parseDate(row[colMapping.fecha]);
                const modalidad = String(row[colMapping.modalidad] || '').trim();
                const track = String(row[colMapping.track] || '').trim();
                const numero = String(row[colMapping.numero] || '').trim();
                
                if (!fecha || !modalidad || !numero) {
                    return null;
                }
                
                const trackParts = track.split(',').map(s => s.trim());
                const state = this.mapState(trackParts[0] || 'FL');
                const draw = this.mapDraw(trackParts[1] || 'MID');
                
                const game = this.mapGame(modalidad);
                
                const straight = parseFloat(row[colMapping.straight] || 0);
                const box = parseFloat(row[colMapping.box] || 0);
                const combo = parseFloat(row[colMapping.combo] || 0);
                
                let betType, wager;
                
                if (straight > 0 && box > 0) {
                    betType = 'STRAIGHT';
                    wager = straight;
                } else if (straight > 0) {
                    betType = 'STRAIGHT';
                    wager = straight;
                } else if (box > 0) {
                    betType = game === 'PICK3' ? 'BOX_6WAY' : 'BOX_24WAY';
                    wager = box;
                } else if (combo > 0) {
                    betType = 'COMBO_6WAY';
                    wager = combo;
                } else {
                    wager = 1.00;
                    betType = 'STRAIGHT';
                }
                
                const play = {
                    _id: `import_${Date.now()}_${index}`,
                    userId: 'imported',
                    date: fecha,
                    state: state,
                    draw: draw,
                    game: game,
                    betType: betType,
                    numbers: this.formatNumbers(numero, game),
                    wager: wager
                };
                
                return play;
            }
            
            static parseDate(dateValue) {
                if (!dateValue) return null;
                
                if (dateValue instanceof Date) {
                    return dateValue.toISOString().split('T')[0];
                }
                
                if (typeof dateValue === 'number') {
                    const date = new Date((dateValue - 25569) * 86400 * 1000);
                    return date.toISOString().split('T')[0];
                }
                
                if (typeof dateValue === 'string') {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString().split('T')[0];
                    }
                }
                
                return null;
            }
            
            static mapState(stateStr) {
                const state = stateStr.toUpperCase();
                if (state.includes('NY') || state.includes('NEW YORK')) return 'NY';
                if (state.includes('FL') || state.includes('FLORIDA')) return 'FL';
                if (state.includes('VE') || state.includes('VENEZUELA')) return 'VE';
                return 'FL';
            }
            
            static mapDraw(drawStr) {
                const draw = drawStr.toUpperCase();
                if (draw.includes('MID') || draw.includes('MEDIO')) return 'MID';
                if (draw.includes('EVE') || draw.includes('NOCHE') || draw.includes('NIGHT')) return 'EVE';
                return 'MID';
            }
            
            static mapGame(modalidadStr) {
                const modalidad = modalidadStr.toLowerCase();
                if (modalidad.includes('peak 3') || modalidad.includes('pick 3') || modalidad.includes('pick3')) return 'PICK3';
                if (modalidad.includes('win 4') || modalidad.includes('win4') || modalidad.includes('win four')) return 'WIN4';
                if (modalidad.includes('venezuela')) return 'VENEZUELA';
                if (modalidad.includes('pulito')) return 'PULITO';
                if (modalidad.includes('sd') || modalidad.includes('santo domingo')) return 'SD';
                return 'PICK3';
            }
            
            static formatNumbers(numeroStr, game) {
                const clean = numeroStr.replace(/\D/g, '');
                
                switch (game) {
                    case 'PICK3':
                        return clean.length >= 3 ? clean.substring(0, 3) : clean.padStart(3, '0');
                    case 'WIN4':
                        return clean.length >= 4 ? clean.substring(0, 4) : clean.padStart(4, '0');
                    case 'VENEZUELA':
                    case 'PULITO':
                        return clean.length >= 2 ? clean.substring(0, 2) : clean.padStart(2, '0');
                    case 'SD':
                        if (clean.length >= 6) {
                            return `${clean.substring(0, 2)}-${clean.substring(2, 4)}-${clean.substring(4, 6)}`;
                        } else if (clean.length >= 2) {
                            return clean.substring(0, 2);
                        }
                        return clean.padStart(2, '0');
                    default:
                        return clean;
                }
            }
        }

        // ==========================================
        // MAIN APPLICATION CLASS WITH NEON THEME
        // ==========================================
        class LotteryPrizeCalculator {
            constructor() {
                this.currentGame = 'PICK3';
                this.plays = [];
                this.winners = [];
                this.prizeTable = {};
                this.prizeResults = [];
                this.filteredPlays = [];
                this.currentPlayForPrize = null;
                this.importedData = null;
                this.themeManager = new ThemeManager();
                
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                this.render();
                
                setTimeout(() => {
                    showToast('Calculadora de Premios Neón cargada exitosamente! ✨', 'success');
                }, 500);
            }

            loadData() {
                this.plays = StorageService.load('plays', SAMPLE_PLAYS);
                this.winners = StorageService.load('winners', SAMPLE_WINNERS);
                this.prizeTable = StorageService.load('prizeTable', DEFAULT_PRIZE_TABLE);
                this.prizeResults = StorageService.load('prizeResults', []);
                
                this.calculateResults();
            }

            savePlays() {
                StorageService.save('plays', this.plays);
            }

            saveWinners() {
                StorageService.save('winners', this.winners);
            }

            savePrizeTable() {
                StorageService.save('prizeTable', this.prizeTable);
            }

            savePrizeResults() {
                StorageService.save('prizeResults', this.prizeResults);
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-neon').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setCurrentGame(e.target.dataset.game);
                    });
                });

                // Control panel buttons
                document.getElementById('add-play-btn').addEventListener('click', () => {
                    this.showAddPlayModal();
                });

                document.getElementById('import-excel-btn').addEventListener('click', () => {
                    this.showImportExcelModal();
                });

                document.getElementById('scraper-sync-btn').addEventListener('click', () => {
                    this.syncWithScraper();
                });

                document.getElementById('recalculate-btn').addEventListener('click', () => {
                    this.recalculateAll();
                });

                document.getElementById('add-winner-btn').addEventListener('click', () => {
                    showModal('add-winner-modal');
                });

                document.getElementById('approve-all-btn').addEventListener('click', () => {
                    this.approveAllPendingPrizes();
                });

                document.getElementById('filter-toggle-btn').addEventListener('click', () => {
                    this.toggleFilterPanel();
                });

                document.getElementById('export-excel-btn').addEventListener('click', () => {
                    this.exportToExcel();
                });

                // Form submissions
                document.getElementById('add-play-form').addEventListener('submit', (e) => {
                    this.handleAddPlay(e);
                });

                document.getElementById('add-winner-form').addEventListener('submit', (e) => {
                    this.handleAddWinner(e);
                });

                document.getElementById('excel-file-input').addEventListener('change', (e) => {
                    this.handleFileSelection(e);
                });

                document.getElementById('confirm-import-btn').addEventListener('click', () => {
                    this.confirmImport();
                });

                // Game selection changes
                document.getElementById('play-game-select').addEventListener('change', (e) => {
                    this.updateBetTypeOptions(e.target.value, 'bet-type-select');
                    this.updateNumbersHelp(e.target.value, 'numbers-help', 'numbers-input');
                    this.togglePositionField(e.target.value, 'position-container');
                });

                document.getElementById('winner-game-select').addEventListener('change', (e) => {
                    this.updateNumbersHelp(e.target.value, 'winner-numbers-help', 'winner-numbers-input');
                });

                // Filter changes
                ['filter-game', 'filter-status', 'filter-date'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.applyFilters();
                    });
                });

                // Prize modal actions
                document.getElementById('approve-prize-btn').addEventListener('click', () => {
                    this.approvePrize();
                });

                document.getElementById('reject-prize-btn').addEventListener('click', () => {
                    this.rejectPrize();
                });
            }

            setCurrentGame(game) {
                this.currentGame = game;
                
                // Update tab styles
                document.querySelectorAll('.tab-neon').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`[data-game="${game}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                this.render();
            }

            async syncWithScraper() {
                showToast('Función de sincronización con scraper en desarrollo 🔄', 'info');
            }

            addPlay(play) {
                if (!play._id) {
                    play._id = `play_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                }
                
                this.plays.push(play);
                this.savePlays();
                this.calculateResults();
                this.render();
            }

            addWinner(winner) {
                this.winners.push(winner);
                this.saveWinners();
                this.calculateResults();
                this.render();
            }

            removeWinner(index) {
                this.winners.splice(index, 1);
                this.saveWinners();
                this.calculateResults();
                this.render();
            }

            updatePrizeTable(game, betType, value) {
                if (typeof value === 'object') {
                    this.prizeTable[game][betType] = value;
                } else {
                    this.prizeTable[game][betType] = parseFloat(value) || 0;
                }
                this.savePrizeTable();
                this.calculateResults();
                this.render();
            }

            calculateResults() {
                this.prizeResults = [];
                
                for (const play of this.plays) {
                    for (const winner of this.winners) {
                        const result = PrizeCalculator.calculatePrize(play, winner);
                        
                        if (result.hit) {
                            const existingPrize = this.prizeResults.find(p => 
                                p.playId === play._id && 
                                p.winnerKey === `${winner.date}_${winner.state}_${winner.draw}_${winner.game}`
                            );
                            
                            if (!existingPrize) {
                                this.prizeResults.push({
                                    playId: play._id,
                                    winnerKey: `${winner.date}_${winner.state}_${winner.draw}_${winner.game}`,
                                    amount: result.amount,
                                    status: 'PENDING',
                                    calculatedAt: new Date().toISOString()
                                });
                            }
                        }
                    }
                }
                
                this.savePrizeResults();
                this.updateMetrics();
            }

            recalculateAll() {
                showToast('Recalculando todos los premios... ⚡', 'info');
                
                this.prizeResults = [];
                this.calculateResults();
                this.render();
                
                showToast('Recálculo completado ✨', 'success');
            }

            updateMetrics() {
                const totalWagered = this.plays.reduce((sum, play) => sum + play.wager, 0);
                const approvedPrizes = this.prizeResults.filter(p => p.status === 'APPROVED');
                const totalPrizes = approvedPrizes.reduce((sum, prize) => sum + prize.amount, 0);
                const pendingPrizes = this.prizeResults.filter(p => p.status === 'PENDING').length;
                const approvedCount = approvedPrizes.length;
                const roi = totalWagered > 0 ? ((totalPrizes / totalWagered) * 100) : 0;

                document.getElementById('total-wagered').textContent = `$${totalWagered.toFixed(2)}`;
                document.getElementById('total-prizes').textContent = `$${totalPrizes.toFixed(2)}`;
                document.getElementById('pending-prizes').textContent = pendingPrizes.toString();
                document.getElementById('approved-prizes').textContent = approvedCount.toString();
                document.getElementById('roi').textContent = `${roi.toFixed(1)}%`;
            }

            showAddPlayModal() {
                document.getElementById('add-play-form').reset();
                
                const today = new Date().toISOString().split('T')[0];
                document.querySelector('[name="date"]').value = today;
                
                document.getElementById('play-game-select').value = this.currentGame;
                this.updateBetTypeOptions(this.currentGame, 'bet-type-select');
                this.updateNumbersHelp(this.currentGame, 'numbers-help', 'numbers-input');
                this.togglePositionField(this.currentGame, 'position-container');
                
                showModal('add-play-modal');
            }

            showImportExcelModal() {
                document.getElementById('excel-file-input').value = '';
                document.getElementById('confirm-import-btn').disabled = true;
                document.getElementById('import-preview').classList.add('hidden');
                this.importedData = null;
                
                showModal('import-excel-modal');
            }

            async handleFileSelection(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    showToast('Procesando archivo... 📊', 'info');
                    
                    this.importedData = await ExcelImportService.parseFile(file);
                    
                    if (this.importedData.length === 0) {
                        throw new Error('No se encontraron jugadas válidas en el archivo');
                    }
                    
                    this.showImportPreview(this.importedData);
                    document.getElementById('confirm-import-btn').disabled = false;
                    
                    showToast(`${this.importedData.length} jugadas encontradas ✨`, 'success');
                    
                } catch (error) {
                    showToast(`Error al procesar archivo: ${error.message}`, 'error');
                    console.error('Import error:', error);
                }
            }

            showImportPreview(plays) {
                const preview = plays.slice(0, 5);
                
                let tableHTML = `
                    <table class="w-full text-xs">
                        <thead>
                            <tr style="background: var(--bg-accent);">
                                <th class="px-2 py-1 text-left" style="color: var(--text-primary);">Fecha</th>
                                <th class="px-2 py-1 text-left" style="color: var(--text-primary);">Juego</th>
                                <th class="px-2 py-1 text-left" style="color: var(--text-primary);">Tipo</th>
                                <th class="px-2 py-1 text-left" style="color: var(--text-primary);">Números</th>
                                <th class="px-2 py-1 text-left" style="color: var(--text-primary);">Apuesta</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                preview.forEach(play => {
                    tableHTML += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td class="px-2 py-1" style="color: var(--text-primary);">${play.date}</td>
                            <td class="px-2 py-1" style="color: var(--text-primary);">${play.game}</td>
                            <td class="px-2 py-1" style="color: var(--text-primary);">${play.betType}</td>
                            <td class="px-2 py-1" style="color: var(--text-primary);">${play.numbers}</td>
                            <td class="px-2 py-1" style="color: var(--text-primary);">$${play.wager.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                if (plays.length > 5) {
                    tableHTML += `
                        <tr>
                            <td colspan="5" class="px-2 py-1 text-center" style="color: var(--text-secondary);">
                                ... y ${plays.length - 5} más
                            </td>
                        </tr>
                    `;
                }
                
                tableHTML += '</tbody></table>';
                
                document.getElementById('preview-table').innerHTML = tableHTML;
                document.getElementById('import-preview').classList.remove('hidden');
            }

            confirmImport() {
                if (!this.importedData || this.importedData.length === 0) {
                    showToast('No hay datos para importar', 'error');
                    return;
                }
                
                this.importedData.forEach(play => {
                    this.addPlay(play);
                });
                
                closeModal('import-excel-modal');
                showToast(`${this.importedData.length} jugadas importadas exitosamente! 🎉`, 'success');
                
                this.importedData = null;
            }

            handleAddPlay(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const play = {
                    _id: `play_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    userId: 'manual',
                    date: formData.get('date'),
                    state: formData.get('state'),
                    draw: formData.get('draw'),
                    game: formData.get('game'),
                    betType: formData.get('betType'),
                    numbers: formData.get('numbers'),
                    wager: parseFloat(formData.get('wager'))
                };
                
                const position = formData.get('position');
                if (position && ['VENEZUELA', 'SD'].includes(play.game)) {
                    play.extra = { position: parseInt(position) };
                }
                
                const errors = GameValidator.validatePlay(play);
                if (errors.length > 0) {
                    showToast(`Error: ${errors.join(', ')}`, 'error');
                    return;
                }
                
                this.addPlay(play);
                closeModal('add-play-modal');
                showToast('Jugada agregada exitosamente! ✨', 'success');
            }

            handleAddWinner(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const winner = {
                    date: formData.get('date'),
                    state: formData.get('state'),
                    draw: formData.get('draw'),
                    game: formData.get('game'),
                    numbers: formData.get('numbers')
                };
                
                if (!winner.date || !winner.state || !winner.draw || !winner.game || !winner.numbers) {
                    showToast('Error: Todos los campos son obligatorios', 'error');
                    return;
                }
                
                if (!GameValidator.validateNumbers(winner.game, winner.numbers)) {
                    showToast('Error: Formato de números inválido para el juego seleccionado', 'error');
                    return;
                }
                
                this.addWinner(winner);
                closeModal('add-winner-modal');
                showToast('Número ganador agregado exitosamente! 🏆', 'success');
            }

            updateBetTypeOptions(game, selectId) {
                const select = document.getElementById(selectId);
                const options = BET_TYPE_OPTIONS[game] || [];
                
                select.innerHTML = options.map(option => 
                    `<option value="${option.value}">${option.label}</option>`
                ).join('');
            }

            updateNumbersHelp(game, helpId, inputId) {
                const helpText = GameValidator.getNumbersHelp(game);
                document.getElementById(helpId).textContent = helpText;
                
                const input = document.getElementById(inputId);
                if (input) {
                    switch (game) {
                        case 'PICK3':
                            input.placeholder = '123';
                            break;
                        case 'WIN4':
                            input.placeholder = '1234';
                            break;
                        case 'VENEZUELA':
                            input.placeholder = '12 o 12-34-56';
                            break;
                        case 'PULITO':
                            input.placeholder = '12';
                            break;
                        case 'SD':
                            input.placeholder = '12 o 12-34-56';
                            break;
                    }
                }
            }

            togglePositionField(game, containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    if (['VENEZUELA', 'SD'].includes(game)) {
                        container.classList.remove('hidden');
                    } else {
                        container.classList.add('hidden');
                    }
                }
            }

            toggleFilterPanel() {
                const panel = document.getElementById('filter-panel');
                panel.classList.toggle('hidden');
            }

            applyFilters() {
                const gameFilter = document.getElementById('filter-game').value;
                const statusFilter = document.getElementById('filter-status').value;
                const dateFilter = document.getElementById('filter-date').value;
                
                this.filteredPlays = this.plays.filter(play => {
                    if (gameFilter && play.game !== gameFilter) return false;
                    if (dateFilter && play.date !== dateFilter) return false;
                    
                    if (statusFilter) {
                        const prizes = this.prizeResults.filter(p => p.playId === play._id);
                        if (statusFilter === 'NO_WIN' && prizes.length > 0) return false;
                        if (statusFilter !== 'NO_WIN' && !prizes.some(p => p.status === statusFilter)) return false;
                    }
                    
                    return true;
                });
                
                this.renderPlays();
            }

            showPrizeModal(playId) {
                const play = this.plays.find(p => p._id === playId);
                const prizes = this.prizeResults.filter(p => p.playId === playId);
                
                if (!play || prizes.length === 0) return;
                
                this.currentPlayForPrize = playId;
                
                let detailsHTML = `
                    <div class="space-y-4">
                        <div class="border-b pb-3" style="border-color: var(--border);">
                            <h4 class="font-medium" style="color: var(--text-primary);">Detalles de la Jugada</h4>
                            <p class="text-sm" style="color: var(--text-secondary);">
                                ${play.game} - ${play.betType} - ${play.numbers} ($${play.wager.toFixed(2)})
                            </p>
                            <p class="text-xs" style="color: var(--text-secondary);">
                                ${play.date} | ${play.state} | ${play.draw}
                            </p>
                        </div>
                        <div>
                            <h4 class="font-medium" style="color: var(--text-primary);">Premios Calculados</h4>
                            <div class="space-y-2 mt-2">
                `;
                
                prizes.forEach(prize => {
                    const statusClass = {
                        'PENDING': 'badge-pending',
                        'APPROVED': 'badge-approved',
                        'REJECTED': 'badge-rejected'
                    }[prize.status] || 'badge-no-win';
                    
                    detailsHTML += `
                        <div class="flex justify-between items-center p-2 rounded" style="background: var(--bg-accent);">
                            <span class="text-sm" style="color: var(--text-primary);">Premio: $${prize.amount.toFixed(2)}</span>
                            <span class="badge-neon ${statusClass}">${prize.status}</span>
                        </div>
                    `;
                });
                
                detailsHTML += '</div></div></div>';
                
                document.getElementById('prize-details').innerHTML = detailsHTML;
                showModal('prize-modal');
            }

            approvePrize() {
                if (!this.currentPlayForPrize) return;
                
                this.prizeResults.forEach(prize => {
                    if (prize.playId === this.currentPlayForPrize && prize.status === 'PENDING') {
                        prize.status = 'APPROVED';
                        prize.approvedAt = new Date().toISOString();
                    }
                });
                
                this.savePrizeResults();
                this.updateMetrics();
                this.render();
                closeModal('prize-modal');
                showToast('Premio aprobado! ✅', 'success');
            }

            rejectPrize() {
                if (!this.currentPlayForPrize) return;
                
                this.prizeResults.forEach(prize => {
                    if (prize.playId === this.currentPlayForPrize && prize.status === 'PENDING') {
                        prize.status = 'REJECTED';
                        prize.rejectedAt = new Date().toISOString();
                    }
                });
                
                this.savePrizeResults();
                this.updateMetrics();
                this.render();
                closeModal('prize-modal');
                showToast('Premio rechazado ❌', 'error');
            }

            approveAllPendingPrizes() {
                const pendingPrizes = this.prizeResults.filter(p => p.status === 'PENDING');
                
                if (pendingPrizes.length === 0) {
                    showToast('No hay premios pendientes', 'info');
                    return;
                }
                
                if (!confirm(`¿Aprobar ${pendingPrizes.length} premios pendientes?`)) {
                    return;
                }
                
                pendingPrizes.forEach(prize => {
                    prize.status = 'APPROVED';
                    prize.approvedAt = new Date().toISOString();
                });
                
                this.savePrizeResults();
                this.updateMetrics();
                this.render();
                showToast(`${pendingPrizes.length} premios aprobados! 🎉`, 'success');
            }

            exportToExcel() {
                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Sheet 1: Plays
                    const playsData = this.plays.map(play => ({
                        'ID': play._id,
                        'Usuario': play.userId,
                        'Fecha': play.date,
                        'Estado': play.state,
                        'Sorteo': play.draw,
                        'Juego': play.game,
                        'Tipo Apuesta': play.betType,
                        'Números': play.numbers,
                        'Apuesta': play.wager,
                        'Posición': play.extra?.position || ''
                    }));
                    
                    const ws1 = XLSX.utils.json_to_sheet(playsData);
                    XLSX.utils.book_append_sheet(wb, ws1, 'Jugadas');
                    
                    // Sheet 2: Winners
                    const winnersData = this.winners.map(winner => ({
                        'Fecha': winner.date,
                        'Estado': winner.state,
                        'Sorteo': winner.draw,
                        'Juego': winner.game,
                        'Números Ganadores': winner.numbers
                    }));
                    
                    const ws2 = XLSX.utils.json_to_sheet(winnersData);
                    XLSX.utils.book_append_sheet(wb, ws2, 'Ganadores');
                    
                    // Sheet 3: Prize Results
                    const prizesData = this.prizeResults.map(prize => {
                        const play = this.plays.find(p => p._id === prize.playId);
                        return {
                            'ID Jugada': prize.playId,
                            'Jugador': play?.userId || '',
                            'Fecha': play?.date || '',
                            'Juego': play?.game || '',
                            'Números': play?.numbers || '',
                            'Apuesta': play?.wager || 0,
                            'Premio': prize.amount,
                            'Estado': prize.status,
                            'Calculado': prize.calculatedAt,
                            'Aprobado': prize.approvedAt || '',
                            'Rechazado': prize.rejectedAt || ''
                        };
                    });
                    
                    const ws3 = XLSX.utils.json_to_sheet(prizesData);
                    XLSX.utils.book_append_sheet(wb, ws3, 'Premios');
                    
                    // Sheet 4: Prize Table
                    const prizeTableData = [];
                    Object.keys(this.prizeTable).forEach(game => {
                        Object.keys(this.prizeTable[game]).forEach(betType => {
                            prizeTableData.push({
                                'Juego': game,
                                'Tipo Apuesta': betType,
                                'Premio por $1': this.prizeTable[game][betType]
                            });
                        });
                    });
                    
                    const ws4 = XLSX.utils.json_to_sheet(prizeTableData);
                    XLSX.utils.book_append_sheet(wb, ws4, 'Tabla Premios');
                    
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `calculadora-premios-neon-${timestamp}.xlsx`;
                    
                    XLSX.writeFile(wb, filename);
                    showToast('Excel exportado exitosamente! 📊✨', 'success');
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Error al exportar Excel', 'error');
                }
            }

            render() {
                this.renderPrizeTable();
                this.renderWinners();
                this.renderPlays();
                this.updateMetrics();
            }

            renderPrizeTable() {
                const container = document.getElementById('prize-table-container');
                const gameTable = this.prizeTable[this.currentGame] || {};
                
                let html = `<div class="space-y-4">`;
                
                Object.keys(gameTable).forEach(betType => {
                    const value = gameTable[betType];
                    const displayName = BET_TYPE_OPTIONS[this.currentGame]?.find(opt => opt.value === betType)?.label || betType;
                    
                    html += `
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium" style="color: var(--text-primary);">${displayName}</span>
                            <input type="number" 
                                   value="${value}" 
                                   class="input-neon w-20 text-sm"
                                   onchange="app.updatePrizeTable('${this.currentGame}', '${betType}', this.value)">
                        </div>
                    `;
                });
                
                html += `</div>`;
                container.innerHTML = html;
            }

            renderWinners() {
                const tbody = document.getElementById('winners-table');
                const currentGameWinners = this.winners.filter(w => w.game === this.currentGame);
                
                let html = '';
                
                currentGameWinners.forEach((winner, index) => {
                    html += `
                        <tr class="hover:opacity-80 transition-all">
                            <td class="px-4 py-3" style="color: var(--text-primary);">
                                ${winner.date}
                                <div class="text-xs" style="color: var(--text-secondary);">${winner.state} | ${winner.draw}</div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="badge-neon badge-approved">${winner.game}</span>
                            </td>
                            <td class="px-4 py-3 font-mono" style="color: var(--text-primary);">
                                ${winner.numbers}
                            </td>
                            <td class="px-4 py-3">
                                <button onclick="app.removeWinner(${this.winners.indexOf(winner)})" 
                                        class="text-red-500 hover:text-red-300 transition-colors">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                if (currentGameWinners.length === 0) {
                    html = `
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center" style="color: var(--text-secondary);">
                                No hay números ganadores para ${this.currentGame}
                            </td>
                        </tr>
                    `;
                }
                
                tbody.innerHTML = html;
            }

            renderPlays() {
                const container = document.getElementById('plays-container');
                const playsToShow = this.filteredPlays.length > 0 ? this.filteredPlays : 
                                   this.plays.filter(p => p.game === this.currentGame);
                
                let html = '';
                
                playsToShow.forEach(play => {
                    const prizes = this.prizeResults.filter(p => p.playId === play._id);
                    const hasPrize = prizes.length > 0;
                    const pendingPrizes = prizes.filter(p => p.status === 'PENDING').length;
                    const approvedPrizes = prizes.filter(p => p.status === 'APPROVED').length;
                    
                    let statusBadge = '';
                    let prizeAmount = 0;
                    
                    if (hasPrize) {
                        prizeAmount = prizes.reduce((sum, p) => sum + (p.status === 'APPROVED' ? p.amount : 0), 0);
                        
                        if (pendingPrizes > 0) {
                            statusBadge = `<span class="badge-neon badge-pending">⏳ Pendiente</span>`;
                        } else if (approvedPrizes > 0) {
                            statusBadge = `<span class="badge-neon badge-approved">✅ Aprobado</span>`;
                        } else {
                            statusBadge = `<span class="badge-neon badge-rejected">❌ Rechazado</span>`;
                        }
                    } else {
                        statusBadge = `<span class="badge-neon badge-no-win">⭕ Sin premio</span>`;
                    }
                    
                    html += `
                        <div class="p-4 border-b transition-all hover:scale-[1.01]" style="border-color: var(--border); background: var(--bg-secondary);">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="text-lg font-mono font-bold" style="color: var(--accent);">${play.numbers}</span>
                                        <span class="text-xs px-2 py-1 rounded" style="background: var(--bg-accent); color: var(--text-secondary);">${play.betType}</span>
                                        <span class="text-sm font-medium" style="color: var(--text-primary);">$${play.wager.toFixed(2)}</span>
                                    </div>
                                    <div class="text-xs mb-3" style="color: var(--text-secondary);">
                                        ${play.date} | ${play.state} | ${play.draw} | ${play.game}
                                        ${play.extra?.position ? ` | Posición ${play.extra.position}` : ''}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${statusBadge}
                                        ${prizeAmount > 0 ? `<span class="text-sm font-bold" style="color: var(--accent);">$${prizeAmount.toFixed(2)}</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    ${pendingPrizes > 0 ? `
                                        <button onclick="app.showPrizeModal('${play._id}')" 
                                                class="btn-neon text-xs px-3 py-1 rounded">
                                            Confirmar
                                        </button>
                                    ` : ''}
                                    ${hasPrize ? `
                                        <button onclick="app.showPrizeModal('${play._id}')" 
                                                class="btn-neon text-xs px-3 py-1 rounded">
                                            Ver
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (playsToShow.length === 0) {
                    html = `
                        <div class="p-8 text-center">
                            <span class="text-6xl">🎮</span>
                            <p class="mt-4 text-lg" style="color: var(--text-secondary);">
                                No hay jugadas para mostrar
                            </p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
        }

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Add entrance animation
                const content = modal.querySelector('.modal-content-neon');
                if (content) {
                    content.style.animation = 'bounceIn 0.6s ease-out';
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const content = modal.querySelector('.modal-content-neon');
                if (content) {
                    content.style.animation = 'fadeIn 0.3s ease-out reverse';
                }
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }, 300);
            }
        }

        // ==========================================
        // APPLICATION INITIALIZATION
        // ==========================================
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new LotteryPrizeCalculator();
            
            // Add some magic sparkles on load
            setTimeout(() => {
                if (document.body.classList.contains('dark-theme')) {
                    showToast('Modo neón activado! ✨⚡🎆', 'success');
                } else {
                    showToast('Modo claro activado! ☀️🌸🎨', 'success');
                }
            }, 1000);
        });

        // Global click handler for modal backgrounds
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-neon')) {
                const modalId = e.target.id;
                if (modalId.includes('modal')) {
                    closeModal(modalId);
                }
            }
        });

        // ESC key handler for modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal-neon.flex');
                openModals.forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // Add some visual flair to interactions
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-neon') || 
                e.target.classList.contains('btn-success-neon') || 
                e.target.classList.contains('btn-danger-neon')) {
                
                // Create ripple effect
                const button = e.target;
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    left: ${x}px;
                    top: ${y}px;
                    background: rgba(255, 255, 255, 0.4);
                    border-radius: 50%;
                    transform: scale(0);
                    animation: ripple 0.6s ease-out;
                    pointer-events: none;
                `;
                
                button.style.position = 'relative';
                button.style.overflow = 'hidden';
                button.appendChild(ripple);
                
                setTimeout(() => {
                    if (button.contains(ripple)) {
                        button.removeChild(ripple);
                    }
                }, 600);
            }
        });

        // Add ripple animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
