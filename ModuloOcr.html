 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo OCR y Chatbot de Lotería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos base y variables de color */
        :root {
            --color-light-bg: #f8f9fa;
            --color-light-text: #212529;
            --color-light-card-bg: #ffffff;
            --color-light-border: #dee2e6;
            --color-light-primary: #007bff;
            --color-light-primary-hover: #0056b3;
            --color-light-table-header-bg: #e9ecef;

            --color-dark-bg: rgb(10, 10, 10);
            --color-dark-text: #e0e0e0;
            --color-dark-card-bg: #1e1e1e;
            --color-dark-border: #333;
            --color-dark-table-header-bg: #2c2c2c;
            
            --color-neon-cian: #00ffff;
            --color-neon-verde: #39ff14;
            --color-neon-morado: #ff00ff;
            --color-neon-amarillo: #fff000;

            --font-family-sans: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-family-sans);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Modo Claro */
        .light-mode {
            background-color: var(--color-light-bg);
            color: var(--color-light-text);
        }
        .light-mode .card {
            background-color: var(--color-light-card-bg);
            border-color: var(--color-light-border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .light-mode .btn-primary {
            background-color: var(--color-light-primary);
            color: white;
        }
        .light-mode .btn-primary:hover {
            background-color: var(--color-light-primary-hover);
        }
        .light-mode .text-input, .light-mode select {
            background-color: white;
            border-color: var(--color-light-border);
            color: var(--color-light-text);
        }
        .light-mode .text-input:focus {
            border-color: var(--color-light-primary);
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .light-mode .neon-glow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .light-mode .neon-text-primary { color: var(--color-light-primary); }
        .light-mode .neon-text-secondary { color: #17a2b8; }
        .light-mode .neon-text-danger { color: #dc3545; }
        .light-mode .neon-border-primary { border-color: var(--color-light-primary); }
        .light-mode .table-results th { background-color: var(--color-light-table-header-bg); border-color: var(--color-light-border); }
        .light-mode .table-results td { border-color: var(--color-light-border); }
        .light-mode .doubtful { color: #dc3545; font-style: italic; }

        /* Modo Oscuro */
        .dark-mode {
            background-color: var(--color-dark-bg);
            color: var(--color-dark-text);
        }
        .dark-mode .card {
            background-color: var(--color-dark-card-bg);
            border-color: var(--color-neon-cian);
            box-shadow: 0 0 15px rgba(var(--color-neon-cian-rgb), 0.3), 0 0 5px rgba(var(--color-neon-cian-rgb), 0.2);
        }
        .dark-mode .btn-primary {
            background-color: var(--color-neon-cian);
            color: var(--color-dark-bg);
            font-weight: bold;
            border: 1px solid var(--color-neon-cian);
            box-shadow: 0 0 8px var(--color-neon-cian), inset 0 0 5px rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        .dark-mode .btn-primary:hover {
            background-color: var(--color-dark-bg);
            color: var(--color-neon-cian);
            box-shadow: 0 0 15px var(--color-neon-cian), 0 0 25px var(--color-neon-cian);
        }
        .dark-mode .btn-secondary {
            background-color: var(--color-neon-verde);
            color: var(--color-dark-bg);
            font-weight: bold;
            border: 1px solid var(--color-neon-verde);
            box-shadow: 0 0 8px var(--color-neon-verde), inset 0 0 5px rgba(0,0,0,0.3);
        }
        .dark-mode .btn-secondary:hover {
            background-color: var(--color-dark-bg);
            color: var(--color-neon-verde);
            box-shadow: 0 0 15px var(--color-neon-verde), 0 0 25px var(--color-neon-verde);
        }
        .dark-mode .text-input, .dark-mode select {
            background-color: rgba(30,30,30,0.7);
            border-color: var(--color-neon-cian);
            color: var(--color-dark-text);
        }
        .dark-mode .text-input:focus {
            border-color: var(--color-neon-verde);
            box-shadow: 0 0 8px var(--color-neon-verde);
        }
        .dark-mode .neon-text-primary { color: var(--color-neon-cian); text-shadow: 0 0 5px var(--color-neon-cian), 0 0 10px var(--color-neon-cian); }
        .dark-mode .neon-text-secondary { color: var(--color-neon-verde); text-shadow: 0 0 5px var(--color-neon-verde), 0 0 10px var(--color-neon-verde); }
        .dark-mode .neon-text-danger { color: var(--color-neon-morado); text-shadow: 0 0 5px var(--color-neon-morado), 0 0 10px var(--color-neon-morado); }
        .dark-mode .neon-border-primary { border-color: var(--color-neon-cian); }
        .dark-mode .neon-glow-sm { box-shadow: 0 0 5px rgba(var(--color-neon-cian-rgb), 0.5); }
        .dark-mode .table-results th { background-color: var(--color-dark-table-header-bg); border-color: var(--color-neon-cian); color: var(--color-neon-cian); }
        .dark-mode .table-results td { border-color: #444; }
        .dark-mode .doubtful { color: var(--color-neon-morado); font-style: italic; }


        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        .light-mode ::-webkit-scrollbar-track { background: #f1f1f1; }
        .light-mode ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .light-mode ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .dark-mode ::-webkit-scrollbar-track { background: #2c2c2c; }
        .dark-mode ::-webkit-scrollbar-thumb { background: var(--color-neon-cian); border-radius: 4px; box-shadow: 0 0 3px var(--color-neon-cian); }
        .dark-mode ::-webkit-scrollbar-thumb:hover { background: #00e0e0; }

        /* Componentes Generales */
        .module-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease; border: 1px solid; }
        .btn { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn i { font-size: 1.1em; }
        .text-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        
        /* Theme Toggle */
        #theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .light-mode #theme-toggle { background-color: var(--color-light-card-bg); color: var(--color-light-text); border: 1px solid var(--color-light-border); }
        .dark-mode #theme-toggle { background-color: var(--color-dark-card-bg); color: var(--color-neon-cian); border: 1px solid var(--color-neon-cian); box-shadow: 0 0 10px var(--color-neon-cian); }
        #theme-toggle i { font-size: 1.5rem; }

        /* OCR Direct Section */
        #ocr-file-dropzone { border: 2px dashed; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .light-mode #ocr-file-dropzone { border-color: var(--color-light-border); }
        .dark-mode #ocr-file-dropzone { border-color: var(--color-neon-cian); }
        .light-mode #ocr-file-dropzone.dragover { background-color: #e9ecef; }
        .dark-mode #ocr-file-dropzone.dragover { background-color: rgba(0, 255, 255, 0.1); }
        #ocr-image-preview img { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 15px; }
        
        /* Chatbot */
        #chatbot-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 999; }
        .light-mode #chatbot-fab { background-color: var(--color-light-primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .dark-mode #chatbot-fab { background-color: var(--color-neon-verde); color: var(--color-dark-bg); border: 1px solid var(--color-neon-verde); box-shadow: 0 0 15px var(--color-neon-verde), 0 0 25px var(--color-neon-verde); }
        #chatbot-fab i { font-size: 1.8rem; }

        #chatbot-modal { position: fixed; bottom: 100px; right: 30px; width: 90%; max-width: 400px; height: 70vh; max-height: 600px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; z-index: 998; transform: translateY(20px) scale(0.95); opacity: 0; visibility: hidden; transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease; }
        #chatbot-modal.active { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
        .light-mode #chatbot-modal { background-color: var(--color-light-card-bg); border: 1px solid var(--color-light-border); box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
        .dark-mode #chatbot-modal { background-color: var(--color-dark-card-bg); border: 1px solid var(--color-neon-verde); box-shadow: 0 0 20px rgba(var(--color-neon-verde-rgb), 0.4); }
        
        #chatbot-header { padding: 15px 20px; border-bottom: 1px solid; }
        .light-mode #chatbot-header { border-color: var(--color-light-border); }
        .dark-mode #chatbot-header { border-color: var(--color-neon-verde); }
        
        #chatbot-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 10px 15px; border-radius: 12px; max-width: 80%; word-wrap: break-word; }
        .user-message { align-self: flex-end; border-bottom-right-radius: 4px; }
        .light-mode .user-message { background-color: var(--color-light-primary); color: white; }
        .dark-mode .user-message { background-color: var(--color-neon-cian); color: var(--color-dark-bg); }
        
        .assistant-message { align-self: flex-start; border-bottom-left-radius: 4px; }
        .light-mode .assistant-message { background-color: #e9ecef; color: var(--color-light-text); }
        .dark-mode .assistant-message { background-color: #2a2a2a; color: var(--color-dark-text); border: 1px solid #444; }

        #chatbot-input-bar { padding: 15px; border-top: 1px solid; display: flex; gap: 10px; align-items: center; }
        .light-mode #chatbot-input-bar { border-color: var(--color-light-border); }
        .dark-mode #chatbot-input-bar { border-color: var(--color-neon-verde); }
        #chatbot-input-bar input[type="text"] { flex-grow: 1; }
        #chatbot-input-bar button { flex-shrink: 0; width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; }
        .dark-mode #chatbot-input-bar button { background-color: transparent; border: 1px solid var(--color-neon-verde); color: var(--color-neon-verde); }
        .dark-mode #chatbot-input-bar button:hover { background-color: rgba(var(--color-neon-verde-rgb), 0.2); box-shadow: 0 0 5px var(--color-neon-verde); }
        .light-mode #chatbot-input-bar button { background-color: #e9ecef; border: 1px solid #ced4da; color: var(--color-light-text); }
        .light-mode #chatbot-input-bar button:hover { background-color: #dde2e6; }

        /* Spinner */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
        .light-mode .spinner { border-left-color: var(--color-light-primary); }
        .dark-mode .spinner { border-left-color: var(--color-neon-cian); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos para la tabla de resultados */
        .table-results {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .table-results th, .table-results td {
            border: 1px solid;
            padding: 8px;
            text-align: left;
        }
        .table-results th {
            font-weight: 600;
        }
        .table-results .text-center { text-align: center; }
        .table-results .text-xs { font-size: 0.8em; }

        /* Para que los colores neón puedan ser parseados a RGB por JS si es necesario */
        :root {
            --color-neon-cian-rgb: 0, 255, 255;
            --color-neon-verde-rgb: 57, 255, 20;
            --color-neon-morado-rgb: 255, 0, 255;
        }
    </style>
</head>
<body class="light-mode">

    <div id="module-container" class="module-container">
        <button id="theme-toggle" title="Cambiar Tema">
            <i class="fas fa-sun"></i>
        </button>

        <section id="ocr-direct-section" class="card mb-8">
            <h1 class="text-2xl font-bold mb-2">Módulo de Interpretación de Tickets</h1>
            <h2 class="text-xl font-semibold mb-6 neon-text-primary">Beast Reader OCR</h2>

            <div id="ocr-file-dropzone" class="mb-4">
                <input type="file" id="ocr-file-input" accept="image/*" class="hidden" capture="camera">
                <p>Arrastra y suelta una imagen aquí, o <span class="font-semibold cursor-pointer neon-text-secondary underline">haz clic para seleccionar</span>.</p>
                <p class="text-sm mt-1">(Recomendado: .jpg, .png)</p>
            </div>

            <div id="ocr-image-preview" class="mb-4 text-center"></div>
            
            <button id="interpret-ticket-button" class="btn btn-primary w-full md:w-auto">
                <i class="fas fa-microchip"></i> Interpretar Ticket
            </button>

            <div id="ocr-processing-indicator" class="mt-4 text-center hidden">
                <div class="spinner"></div>
                <p class="mt-2">Procesando con IA...</p>
            </div>

            <div id="ocr-error-message" class="mt-4 p-3 rounded-md hidden bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300"></div>

            <div id="ocr-results-area" class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Resultados de la Interpretación:</h3>
                <div id="ocr-results-content"></div>
            </div>
        </section>

        <button id="chatbot-fab" title="Asistente de Jugadas">
            <i class="fas fa-comments"></i>
        </button>

        <div id="chatbot-modal" class="card">
            <div id="chatbot-header" class="flex justify-between items-center">
                <h3 class="text-lg font-semibold neon-text-primary">Asistente de Jugadas Beast Reader</h3>
                <button id="close-chatbot-modal" class="text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="chatbot-messages"></div>
            <div id="chatbot-typing-indicator" class="px-4 py-2 text-sm italic hidden">
                Asistente está escribiendo...
            </div>
            <div id="chatbot-input-bar">
                <input type="text" id="chatbot-text-input" class="text-input" placeholder="Escribe tu jugada...">
                <input type="file" id="chatbot-image-input" accept="image/*" class="hidden">
                <button id="chatbot-attach-image-button" title="Adjuntar Imagen" class="btn">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button id="chatbot-voice-button" title="Entrada de Voz" class="btn">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="chatbot-send-button" title="Enviar" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTES Y CONFIGURACIÓN ---
        // IMPORTANTE: Reemplaza el siguiente placeholder con tu clave API real de OpenAI.
        // NO LA COMPROMETAS en repositorios públicos. Considera usar variables de entorno para producción.
        const OPENAI_API_KEY = "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE"; 
        
        // El ID del Asistente proporcionado por el usuario. También puede ser configurable.
        const ASSISTANT_ID = "asst_iPQIGQRDCf1YeQ4P3p9ued6W"; 
        const OPENAI_API_BASE_URL = "https://api.openai.com/v1";

        const ASSISTANT_PROMPT_FOR_INTERPRETATION = `Eres "Beast Reader", un experto analista de tickets de lotería manuscritos y un asistente para tomar jugadas de lotería. Tu tarea es interpretar la información proporcionada (imagen de ticket, texto de jugada, o audio transcrito) y extraer todas las jugadas de lotería.

Para cada jugada, debes identificar:
1.  El NÚMERO o NÚMEROS apostados (ej. "123", o "24 y 56" para un palé).
2.  El MONTO APOSTADO para cada MODALIDAD (Straight, Box, Combo). Si solo hay un monto y una modalidad implícita (ej. "123 - 5" interpretado como Straight $5), indícalo así. Si se especifican múltiples modalidades (ej. "123 2S 1B" significa 123 Straight $2 y Box $1), extráelos por separado.
3.  La MODALIDAD de la apuesta (Straight, Box, Combo, Palé).

Intenta también identificar el NOMBRE DE LA LOTERÍA (Track) y la FECHA DEL TICKET si son visibles en una imagen o mencionados.

Devuelve tu respuesta ÚNICAMENTE en el siguiente formato JSON estructurado:
{
  "ticketInfo": {
    "fechaDetectada": "MM-DD-YYYY | null",
    "trackDetectado": "Nombre del Track | null",
    "esFechaDudosa": false,
    "esTrackDudoso": false
  },
  "jugadasInterpretadas": [
    {
      "numeros": ["string" | ["string", "string"]],
      "modalidades": [
        { "tipo": "Straight", "monto": number | null, "esDudoso": false },
        { "tipo": "Box", "monto": number | null, "esDudoso": false },
        { "tipo": "Combo", "monto": number | null, "esDudoso": false },
        { "tipo": "Palé", "monto": number | null, "esDudoso": false } // Añadido Palé aquí para consistencia
      ],
      "textoOriginalDetectado": "string | null",
      "esJugadaGeneralDudosa": false
    }
  ],
  "mensajeParaUsuario": "string",
  "camposSolicitandoClarificacion": ["string"]
}

Si la entrada es una imagen, analiza la imagen adjunta (referenciada por su file_id que te proporcionaré).
Si la entrada es texto, interpreta ese texto.
Si alguna información no es clara o es ambigua, establece el campo 'esDudoso' correspondiente a true y, si es posible, pide clarificación al usuario a través de 'mensajeParaUsuario' y 'camposSolicitandoClarificacion'.
Si no se encuentra un valor, usa 'null' para montos y strings vacíos o null para texto.
Si el usuario solo saluda o hace una pregunta general, responde de forma conversacional sin intentar extraer jugadas, y el JSON de jugadas puede estar vacío o no presente.`;

        // --- ESTADO DE LA APLICACIÓN ---
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentChatThreadId = null; 
        let isRecordingVoice = false;
        let speechRecognition;

        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const body = document.body;
        const themeToggleButton = document.getElementById('theme-toggle');
        const ocrFileDropzone = document.getElementById('ocr-file-dropzone');
        const ocrFileInput = document.getElementById('ocr-file-input');
        const ocrImagePreview = document.getElementById('ocr-image-preview');
        const interpretTicketButton = document.getElementById('interpret-ticket-button');
        const ocrProcessingIndicator = document.getElementById('ocr-processing-indicator');
        const ocrErrorMessage = document.getElementById('ocr-error-message');
        const ocrResultsContent = document.getElementById('ocr-results-content');
        const chatbotFab = document.getElementById('chatbot-fab');
        const chatbotModal = document.getElementById('chatbot-modal');
        const closeChatbotModalButton = document.getElementById('close-chatbot-modal');
        const chatbotMessagesContainer = document.getElementById('chatbot-messages');
        const chatbotTypingIndicator = document.getElementById('chatbot-typing-indicator');
        const chatbotTextInput = document.getElementById('chatbot-text-input');
        const chatbotImageInput = document.getElementById('chatbot-image-input');
        const chatbotAttachImageButton = document.getElementById('chatbot-attach-image-button');
        const chatbotVoiceButton = document.getElementById('chatbot-voice-button');
        const chatbotSendButton = document.getElementById('chatbot-send-button');

        // --- LÓGICA DE TEMAS ---
        function applyTheme(theme) {
            body.classList.remove('light-mode', 'dark-mode');
            body.classList.add(theme + '-mode');
            themeToggleButton.innerHTML = theme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        }
        themeToggleButton.addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });
        
        // --- LÓGICA DE INTERACCIÓN CON API DE OPENAI ---
        // Funciones simuladas para desarrollo si la API Key no está configurada.
        async function mockOpenAIFileUpload(file) {
            console.log("Simulando subida de archivo a OpenAI:", file.name);
            await new Promise(resolve => setTimeout(resolve, 1000));
            return `file_mock_${Date.now()}`;
        }

        async function mockOpenAIAssistantResponse(userInput, imageFileId = null, mode = 'ocr') {
            console.log("Simulando interacción con OpenAI Assistant:", { userInput, imageFileId, mode });
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

            if (userInput.toLowerCase().includes("hola") || userInput.toLowerCase().includes("ayuda")) {
                 return {
                    mensajeParaUsuario: "¡Hola! Soy Beast Reader, tu asistente de lotería. ¿Cómo puedo ayudarte hoy? (Respuesta Simulada)",
                    jugadasInterpretadas: [], ticketInfo: {}, camposSolicitandoClarificacion: []
                };
            }
            
            const isImageInput = !!imageFileId;
            return { 
                ticketInfo: {
                    fechaDetectada: isImageInput ? "18-05-2025" : null,
                    trackDetectado: isImageInput ? "Lotería Mock" : "No especificado",
                    esFechaDudosa: isImageInput ? false : true,
                    esTrackDudoso: isImageInput ? false : true
                },
                jugadasInterpretadas: [
                    { numeros: ["123"], modalidades: [ { tipo: "Straight", monto: 5, esDudoso: false }, { tipo: "Box", monto: 2, esDudoso: true } ], textoOriginalDetectado: isImageInput ? "Mock: 123 S5 B2?" : userInput, esJugadaGeneralDudosa: true },
                    { numeros: ["45", "67"], modalidades: [ { tipo: "Palé", monto: 10, esDudoso: false } ], textoOriginalDetectado: isImageInput ? "Mock: 45-67 P10" : "45 67 pale 10", esJugadaGeneralDudosa: false }
                ],
                mensajeParaUsuario: `He interpretado las jugadas (Respuesta Simulada). Revisa los detalles. Para "123", el monto de Box es dudoso.`,
                camposSolicitandoClarificacion: ["monto para 123 Box"]
            };
        }
        
        // FUNCIÓN PRINCIPAL para interactuar con OpenAI (Lógica Real y Simulación de Respaldo)
        async function processWithOpenAIAssistant(userInput, imageFile = null, mode = 'ocr') {
            // Comprobar si la API Key es el placeholder.
            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                console.warn("ALERTA DE SEGURIDAD Y CONFIGURACIÓN: La OpenAI API Key no ha sido configurada. Usando datos simulados. Reemplaza 'YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE' en el script con tu clave real.");
                addMessageToChat("ADVERTENCIA: OpenAI API Key no configurada. Mostrando resultados simulados.", 'system');
                // Deshabilitar botones principales para evitar confusión si la API no está lista
                interpretTicketButton.disabled = true;
                chatbotSendButton.disabled = true;
                showOcrError("OpenAI API Key no configurada. Por favor, edita el script para añadir tu clave API.");
                return mockOpenAIAssistantResponse(userInput, imageFile ? `file_mock_${Date.now()}` : null, mode);
            }
            // Si la API Key está presente, re-habilitar botones (en caso de que se hayan deshabilitado antes)
            interpretTicketButton.disabled = false;
            chatbotSendButton.disabled = false;
            
            console.log("Iniciando proceso con OpenAI Assistant (API Real)");
            let fileId = null;

            // 1. Subir archivo si existe
            if (imageFile) {
                const formData = new FormData();
                formData.append('purpose', 'assistants');
                formData.append('file', imageFile);
                try {
                    const fileUploadResponse = await fetch(`${OPENAI_API_BASE_URL}/files`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${OPENAI_API_KEY}` },
                        body: formData
                    });
                    if (!fileUploadResponse.ok) {
                        const errorData = await fileUploadResponse.json();
                        console.error("Error subiendo archivo a OpenAI:", errorData);
                        throw new Error(`Error subiendo archivo: ${errorData.error?.message || fileUploadResponse.statusText}`);
                    }
                    const fileData = await fileUploadResponse.json();
                    fileId = fileData.id;
                    console.log("Archivo subido, File ID:", fileId);
                } catch (error) {
                    console.error("Excepción subiendo archivo:", error);
                    throw error; 
                }
            }

            // 2. Crear o reutilizar Thread
            let threadIdToUse = mode === 'chat' ? currentChatThreadId : null;
            if (!threadIdToUse) { // Si no hay thread (para OCR o primer mensaje de chat)
                try {
                    const threadResponse = await fetch(`${OPENAI_API_BASE_URL}/threads`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${OPENAI_API_KEY}`,
                            'OpenAI-Beta': 'assistants=v2',
                            'Content-Type': 'application/json'
                        }
                    });
                    if (!threadResponse.ok) {
                        const errorData = await threadResponse.json();
                        throw new Error(`Error creando thread: ${errorData.error?.message || threadResponse.statusText}`);
                    }
                    const threadData = await threadResponse.json();
                    threadIdToUse = threadData.id;
                    if (mode === 'chat') {
                        currentChatThreadId = threadIdToUse; // Guardar para la sesión de chat
                        console.log("Nuevo Thread Creado (Chat):", currentChatThreadId);
                    } else {
                        console.log("Nuevo Thread Creado (OCR Temporal):", threadIdToUse);
                    }
                } catch (error) {
                     console.error("Excepción creando thread:", error);
                    throw error;
                }
            }
            if (!threadIdToUse) throw new Error("No se pudo obtener un ID de Hilo (Thread ID)");

            // 3. Crear Mensaje en el Thread
            const messagePayload = {
                role: 'user',
                content: userInput, 
            };
            if (fileId) { 
                messagePayload.attachments = [{ file_id: fileId, tools: [{type: "code_interpreter"}] }]; 
                // Nota: file_search es otro tipo de herramienta, code_interpreter es para análisis de archivos como imágenes.
                // El prompt ya instruye al asistente sobre cómo usar el file_id si se menciona en el texto.
                // Alternativamente, el prompt podría ser más genérico y el asistente usaría el archivo adjunto.
            }

            try {
                const messageResponse = await fetch(`${OPENAI_API_BASE_URL}/threads/${threadIdToUse}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'OpenAI-Beta': 'assistants=v2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messagePayload)
                });
                if (!messageResponse.ok) {
                    const errorData = await messageResponse.json();
                    throw new Error(`Error creando mensaje: ${errorData.error?.message || messageResponse.statusText}`);
                }
                const messageData = await messageResponse.json();
                console.log("Mensaje Creado:", messageData.id);
            } catch (error) {
                console.error("Excepción creando mensaje:", error);
                throw error;
            }

            // 4. Crear un Run
            try {
                const runResponse = await fetch(`${OPENAI_API_BASE_URL}/threads/${threadIdToUse}/runs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'OpenAI-Beta': 'assistants=v2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assistant_id: ASSISTANT_ID,
                        instructions: ASSISTANT_PROMPT_FOR_INTERPRETATION 
                    })
                });
                if (!runResponse.ok) {
                     const errorData = await runResponse.json();
                     console.error("Error creando Run:", errorData);
                     throw new Error(`Error creando Run: ${errorData.error?.message || runResponse.statusText}`);
                }
                let runData = await runResponse.json();
                console.log("Run Creado:", runData.id, "Status:", runData.status);

                // 5. Polling para esperar que el Run se complete
                while (['queued', 'in_progress', 'cancelling'].includes(runData.status)) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Aumentar ligeramente el tiempo de polling
                    const pollResponse = await fetch(`${OPENAI_API_BASE_URL}/threads/${threadIdToUse}/runs/${runData.id}`, {
                        headers: {
                            'Authorization': `Bearer ${OPENAI_API_KEY}`,
                            'OpenAI-Beta': 'assistants=v2'
                        }
                    });
                    if (!pollResponse.ok) {
                        const errorData = await pollResponse.json();
                        throw new Error(`Error haciendo polling del Run: ${errorData.error?.message || pollResponse.statusText}`);
                    }
                    runData = await pollResponse.json();
                    console.log("Polling Run Status:", runData.status);
                }

                if (runData.status === 'completed') {
                    // 6. Obtener el último mensaje del Asistente
                    const messagesResponse = await fetch(`${OPENAI_API_BASE_URL}/threads/${threadIdToUse}/messages?order=desc&limit=1`, { // Obtener el más reciente
                        headers: {
                            'Authorization': `Bearer ${OPENAI_API_KEY}`,
                            'OpenAI-Beta': 'assistants=v2'
                        }
                    });
                    if (!messagesResponse.ok) {
                        const errorData = await messagesResponse.json();
                        throw new Error(`Error obteniendo mensajes: ${errorData.error?.message || messagesResponse.statusText}`);
                    }
                    const messagesData = await messagesResponse.json();
                    
                    if (messagesData.data && messagesData.data.length > 0 && messagesData.data[0].role === 'assistant') {
                        const assistantResponseContent = messagesData.data[0].content[0].text.value;
                        console.log("Respuesta del Asistente (texto crudo):", assistantResponseContent);
                        try {
                            return JSON.parse(assistantResponseContent);
                        } catch (e) {
                            console.error("Error parseando JSON de la respuesta del asistente:", e, "\nRespuesta recibida:", assistantResponseContent);
                            return { mensajeParaUsuario: "La respuesta del asistente no fue un JSON válido. Contenido: " + assistantResponseContent, jugadasInterpretadas: [], ticketInfo: {} };
                        }
                    } else {
                        console.error("No se encontró respuesta del asistente o el último mensaje no es del asistente:", messagesData);
                        throw new Error("No se encontró respuesta adecuada del asistente.");
                    }
                } else {
                    console.error("Run no completado, estado final:", runData.status, runData);
                    const errorMessage = runData.last_error ? runData.last_error.message : (runData.incomplete_details ? runData.incomplete_details.reason : 'Error desconocido durante el run.');
                    throw new Error(`Run finalizó con estado: ${runData.status}. Detalles: ${errorMessage}`);
                }
            } catch (error) {
                console.error("Excepción durante el Run o obtención de mensajes:", error);
                throw error;
            }
        }

        // --- LÓGICA OCR DIRECTO ---
        ocrFileDropzone.addEventListener('click', () => ocrFileInput.click());
        ocrFileDropzone.addEventListener('dragover', (e) => { e.preventDefault(); ocrFileDropzone.classList.add('dragover'); });
        ocrFileDropzone.addEventListener('dragleave', () => ocrFileDropzone.classList.remove('dragover'));
        ocrFileDropzone.addEventListener('drop', (e) => {
            e.preventDefault(); ocrFileDropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleOcrFile(e.dataTransfer.files[0]);
        });
        ocrFileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleOcrFile(e.target.files[0]); });

        let currentOcrFile = null;
        function handleOcrFile(file) {
            if (!file.type.startsWith('image/')) { showOcrError("Por favor, selecciona un archivo de imagen."); return; }
            currentOcrFile = file;
            const reader = new FileReader();
            reader.onload = (e) => { ocrImagePreview.innerHTML = `<img src="${e.target.result}" alt="Vista previa del ticket">`; }
            reader.readAsDataURL(file);
            ocrErrorMessage.classList.add('hidden'); ocrResultsContent.innerHTML = '';
        }

        interpretTicketButton.addEventListener('click', async () => {
            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                 showOcrError("Configuración Requerida: OpenAI API Key no está configurada en el script. No se puede procesar.");
                 addMessageToChat("OpenAI API Key no configurada. Por favor, edita el script.", 'system');
                 return;
            }
            if (!currentOcrFile) { showOcrError("Por favor, selecciona una imagen primero."); return; }
            
            ocrProcessingIndicator.classList.remove('hidden'); interpretTicketButton.disabled = true;
            ocrErrorMessage.classList.add('hidden'); ocrResultsContent.innerHTML = '';
            try {
                const ocrPrompt = "Interpreta la imagen del ticket de lotería adjunto según las instrucciones JSON que conoces.";
                const result = await processWithOpenAIAssistant(ocrPrompt, currentOcrFile, 'ocr');
                displayOcrResults(result);
            } catch (error) {
                console.error("Error en OCR directo:", error);
                showOcrError(error.message || "Ocurrió un error al interpretar el ticket.");
            } finally {
                ocrProcessingIndicator.classList.add('hidden'); 
                if (OPENAI_API_KEY !== "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") { // Solo re-habilitar si la API key está (o parece estar) configurada
                    interpretTicketButton.disabled = false;
                }
            }
        });

        function showOcrError(message) {
            ocrErrorMessage.textContent = message; ocrErrorMessage.classList.remove('hidden');
        }

        function formatMonto(monto, esDudoso) {
            let montoStr = monto !== null ? `$${monto}` : 'N/A';
            if (esDudoso) montoStr += ' <span class="doubtful">(dudoso)</span>';
            return montoStr;
        }

        function createPlaysTable(jugadas) {
            if (!jugadas || jugadas.length === 0) return '<p>No se interpretaron jugadas.</p>';
            
            let tableHtml = '<div class="overflow-x-auto"><table class="table-results w-full">';
            tableHtml += `<thead><tr>
                            <th>Número(s)</th>
                            <th>Straight</th>
                            <th>Box</th>
                            <th>Combo</th>
                            <th>Palé</th>
                            <th class="text-xs">Original (detectado)</th>
                            <th class="text-center">Dudosa</th>
                         </tr></thead><tbody>`;

            jugadas.forEach(jugada => {
                const numerosStr = Array.isArray(jugada.numeros) ? jugada.numeros.join(' y ') : jugada.numeros;
                const modalidades = { Straight: null, Box: null, Combo: null, Palé: null }; 
                
                if (jugada.modalidades && Array.isArray(jugada.modalidades)) {
                    jugada.modalidades.forEach(mod => {
                        if (modalidades.hasOwnProperty(mod.tipo)) {
                            modalidades[mod.tipo] = formatMonto(mod.monto, mod.esDudoso);
                        }
                    });
                }


                tableHtml += `<tr>
                                <td>${numerosStr || 'N/A'}</td>
                                <td>${modalidades.Straight || 'N/A'}</td>
                                <td>${modalidades.Box || 'N/A'}</td>
                                <td>${modalidades.Combo || 'N/A'}</td>
                                <td>${modalidades.Palé || 'N/A'}</td>
                                <td class="text-xs">${jugada.textoOriginalDetectado || ''}</td>
                                <td class="text-center">${jugada.esJugadaGeneralDudosa ? '<span class="doubtful">Sí</span>' : 'No'}</td>
                              </tr>`;
            });
            tableHtml += '</tbody></table></div>';
            return tableHtml;
        }

        function displayOcrResults(data) {
            ocrResultsContent.innerHTML = ''; 
            if (!data) {
                showOcrError("No se recibió respuesta o la respuesta fue inválida del asistente.");
                return;
            }
            if (data.mensajeParaUsuario) {
                const msgEl = document.createElement('p');
                msgEl.className = 'mb-3 italic'; msgEl.textContent = data.mensajeParaUsuario;
                ocrResultsContent.appendChild(msgEl);
            }

            if (data.ticketInfo) {
                const ti = data.ticketInfo;
                let infoHtml = '<div class="mb-3 p-3 rounded-md border bg-gray-50 dark:bg-gray-700 dark:border-gray-600">';
                infoHtml += `<h4 class="font-semibold">Información del Ticket:</h4>`;
                if (ti.fechaDetectada) infoHtml += `<p>Fecha: ${ti.fechaDetectada} ${ti.esFechaDudosa ? '<span class="doubtful">(dudoso)</span>' : ''}</p>`;
                if (ti.trackDetectado) infoHtml += `<p>Track/Lotería: ${ti.trackDetectado} ${ti.esTrackDudoso ? '<span class="doubtful">(dudoso)</span>' : ''}</p>`;
                if (!ti.fechaDetectada && !ti.trackDetectado && Object.keys(ti).length <=2) infoHtml += '<p>No se detectó información adicional del ticket.</p>';
                infoHtml += '</div>';
                ocrResultsContent.innerHTML += infoHtml;
            }

            ocrResultsContent.innerHTML += createPlaysTable(data.jugadasInterpretadas);

            if (data.camposSolicitandoClarificacion && data.camposSolicitandoClarificacion.length > 0) {
                ocrResultsContent.innerHTML += `<p class="mt-3 text-yellow-600 dark:text-yellow-400"><strong>Se necesita clarificación para:</strong> ${data.camposSolicitandoClarificacion.join(', ')}</p>`;
            }
        }

        // --- LÓGICA CHATBOT ---
        chatbotFab.addEventListener('click', () => chatbotModal.classList.add('active'));
        closeChatbotModalButton.addEventListener('click', () => chatbotModal.classList.remove('active'));
        chatbotSendButton.addEventListener('click', handleSendChatMessage);
        chatbotTextInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendChatMessage(); });
        chatbotAttachImageButton.addEventListener('click', () => chatbotImageInput.click());
        chatbotImageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleChatImageUpload(e.target.files[0]);
                e.target.value = null; 
            }
        });

        async function handleChatImageUpload(file) {
            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                 addMessageToChat("OpenAI API Key no configurada en el script. No se puede procesar la imagen.", 'system');
                 return;
            }
            if (!file.type.startsWith('image/')) { addMessageToChat("Solo se pueden subir imágenes.", 'system'); return; }
            const reader = new FileReader();
            reader.onload = (e) => { addMessageToChat(`<img src="${e.target.result}" alt="Imagen subida" style="max-height: 150px; border-radius: 8px; display: block;">`, 'user-image'); }
            reader.readAsDataURL(file);
            chatbotTypingIndicator.classList.remove('hidden');
            try {
                const result = await processWithOpenAIAssistant("Interpreta la imagen adjunta para jugadas de lotería según las instrucciones JSON.", file, 'chat');
                addAssistantResponseToChat(result);
            } catch (error) { addMessageToChat("Error procesando imagen: " + error.message, 'system');
            } finally { chatbotTypingIndicator.classList.add('hidden'); }
        }

        async function handleSendChatMessage() {
            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                 addMessageToChat("OpenAI API Key no configurada en el script. No se puede enviar el mensaje.", 'system');
                 return;
            }
            const messageText = chatbotTextInput.value.trim();
            if (!messageText) return;
            addMessageToChat(messageText, 'user');
            chatbotTextInput.value = '';
            chatbotTypingIndicator.classList.remove('hidden');
            try {
                const result = await processWithOpenAIAssistant(messageText, null, 'chat');
                addAssistantResponseToChat(result);
            } catch (error) {
                console.error("Error en chatbot:", error);
                addMessageToChat("Lo siento, tuve un problema: " + error.message, 'assistant');
            } finally { chatbotTypingIndicator.classList.add('hidden'); }
        }
        
        function addMessageToChat(content, sender, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            if (sender === 'user') messageDiv.classList.add('user-message');
            else if (sender === 'user-image') {
                messageDiv.classList.add('user-message');
                messageDiv.style.padding = '5px'; messageDiv.style.backgroundColor = 'transparent';
            } else if (sender === 'assistant') messageDiv.classList.add('assistant-message');
            else { 
                messageDiv.classList.add('assistant-message'); 
                messageDiv.style.fontStyle = 'italic'; messageDiv.style.backgroundColor = 'rgba(128,128,128,0.1)';
                messageDiv.style.fontSize = '0.85em';
                messageDiv.style.borderColor = 'rgba(128,128,128,0.3)'; // System message border
            }
            if (isHtml || sender === 'user-image') messageDiv.innerHTML = content;
            else messageDiv.textContent = content;
            chatbotMessagesContainer.appendChild(messageDiv);
            chatbotMessagesContainer.scrollTop = chatbotMessagesContainer.scrollHeight;
        }

        function addAssistantResponseToChat(data) {
             if (!data) {
                addMessageToChat("No se recibió respuesta o la respuesta fue inválida del asistente.", 'system');
                return;
            }
            if (data.mensajeParaUsuario) addMessageToChat(data.mensajeParaUsuario, 'assistant');

            let playsHtml = '<div class="mt-1 assistant-table-container">'; 
            if (data.ticketInfo) {
                const ti = data.ticketInfo;
                if (ti.fechaDetectada) playsHtml += `<p class="text-xs">Fecha: ${ti.fechaDetectada} ${ti.esFechaDudosa ? '<span class="doubtful">(dudoso)</span>' : ''}</p>`;
                if (ti.trackDetectado) playsHtml += `<p class="text-xs">Track: ${ti.trackDetectado} ${ti.esTrackDudoso ? '<span class="doubtful">(dudoso)</span>' : ''}</p>`;
            }
            playsHtml += createPlaysTable(data.jugadasInterpretadas);
            playsHtml += '</div>';
            
            if (data.jugadasInterpretadas && data.jugadasInterpretadas.length > 0) {
                 addMessageToChat(playsHtml, 'assistant', true);
            }
            
            if (data.camposSolicitandoClarificacion && data.camposSolicitandoClarificacion.length > 0) {
                addMessageToChat(`Necesito que aclares: ${data.camposSolicitandoClarificacion.join(', ')}`, 'assistant');
            }
        }

        // --- LÓGICA DE ENTRADA DE VOZ (Web Speech API) ---
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = false; speechRecognition.lang = 'es-US';
            speechRecognition.interimResults = false; speechRecognition.maxAlternatives = 1;

            chatbotVoiceButton.addEventListener('click', () => {
                if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                    addMessageToChat("OpenAI API Key no configurada. La entrada de voz no puede procesar la solicitud.", 'system');
                    return;
                }
                if (isRecordingVoice) speechRecognition.stop(); else speechRecognition.start();
            });
            speechRecognition.onstart = () => {
                isRecordingVoice = true; chatbotVoiceButton.classList.add('neon-text-danger');
                chatbotVoiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>'; chatbotTextInput.placeholder = "Escuchando...";
            };
            speechRecognition.onend = () => {
                isRecordingVoice = false; chatbotVoiceButton.classList.remove('neon-text-danger');
                chatbotVoiceButton.innerHTML = '<i class="fas fa-microphone"></i>'; chatbotTextInput.placeholder = "Escribe tu jugada...";
            };
            speechRecognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatbotTextInput.value = transcript; handleSendChatMessage();
            };
            speechRecognition.onerror = (event) => {
                console.error("Error en SpeechRecognition:", event.error);
                let errMsg = "Error en el reconocimiento de voz.";
                if (event.error === 'no-speech') errMsg = "No se detectó voz.";
                else if (event.error === 'audio-capture') errMsg = "Problema con micrófono.";
                else if (event.error === 'not-allowed') errMsg = "Permiso para micrófono denegado.";
                addMessageToChat(errMsg, 'system');
            };
        } else {
            chatbotVoiceButton.disabled = true; chatbotVoiceButton.title = "Voz no soportada.";
            console.warn("Web Speech API no soportada.");
        }

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
            addMessageToChat("¡Hola! Soy Beast Reader. Ingresa tus jugadas por texto, imagen o voz.", 'assistant');

            if (OPENAI_API_KEY === "YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE") {
                const warningMsg = "ALERTA DE CONFIGURACIÓN: Tu OpenAI API Key no está configurada en el script. El módulo usará datos simulados y las funciones de IA no contactarán a OpenAI. Por favor, edita el archivo HTML y reemplaza 'YOUR_OPENAI_API_KEY_MUST_BE_SET_HERE' con tu clave real para habilitar la funcionalidad completa.";
                console.warn(warningMsg);
                if (document.getElementById('ocr-direct-section')) showOcrError(warningMsg);
                addMessageToChat(warningMsg, 'system');
                // Deshabilitar botones si la API key no está
                interpretTicketButton.disabled = true;
                chatbotSendButton.disabled = true;
                if (chatbotVoiceButton) chatbotVoiceButton.disabled = true; // También el de voz
                if (chatbotAttachImageButton) chatbotAttachImageButton.disabled = true; // Y el de adjuntar
            } else {
                 console.log("OpenAI API Key y Assistant ID están configurados. El módulo intentará usar la API real.");
                 addMessageToChat("Módulo configurado para usar la API de OpenAI. ¡Listo para operar!", 'system');
            }
        });
    </script>
</body>
</html>
