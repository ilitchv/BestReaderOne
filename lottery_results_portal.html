# Create an improved single-file HTML with the requested updates:
# - Admin PIN modal with password input and eye icon (toggle visibility)
# - Card layout: squarer tiles, dense grid using auto-fill + aspect-ratio
# - OCR: parse multiple lines, map abbreviations to (section/lottery/draw), preview table, "Guardar todos"
# - Mapping based on user's abbreviations for NY, NJ, CT, FL, GA, PA, BK, NY Horses, etc.
# - Neon futuristic theme with glow, animated gradients; simple generated SVG "logos" per lottery initials
# - Keep Texas Sunday off & Tennessee Sunday-only rules
# - Accordion-click admin access preserved
#
# Save to /mnt/data/lottery_results_portal_v3.html

html = r"""<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mangos Lottery ‚Äî Resultados</title>
<style>
  /* ===== Neon Futuristic Theme ===== */
  :root{
    --bg:#06070b;
    --panel:#0b0f17;
    --card:#0e1420;
    --muted:#94a3b8;
    --text:#e5f0ff;
    --acc1:#00e4ff;   /* cyan neon */
    --acc2:#8b5cf6;   /* violet neon */
    --acc3:#00ffa3;   /* green neon */
    --warn:#ffd166;
    --good:#22c55e;
    --bad:#ef4444;
    --ring: 0 0 0 2px rgba(0,228,255,.3), 0 0 32px rgba(139,92,246,.25), inset 0 0 24px rgba(0,228,255,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 16px rgba(0,228,255,.08);
    --grad: linear-gradient(120deg, rgba(0,228,255,.18), rgba(139,92,246,.18) 55%, rgba(0,255,163,.18));
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 700px at 80% -10%, rgba(0,228,255,.08), transparent), radial-gradient(900px 600px at -10% 20%, rgba(139,92,246,.10), transparent), var(--bg);color:var(--text)}
  a{color:var(--acc1);text-decoration:none}
  header{position:sticky;top:0;z-index:6;background:linear-gradient(180deg, rgba(6,7,11,.95), rgba(6,7,11,.6) 70%, transparent);backdrop-filter: blur(8px);padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
  .hero{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand svg{filter: drop-shadow(0 0 22px rgba(0,228,255,.35));}
  .brand h1{font-size:clamp(18px,2.8vw,26px);margin:0;font-weight:800;letter-spacing:.3px}
  .subtitle{color:var(--muted);font-size:12px}
  .toolbar{display:flex;align-items:center;gap:10px}
  .time{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}
  .search{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0a0f17;color:var(--text);min-width:200px;box-shadow:var(--ring)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));gap:10px;padding:14px 14px 90px}
  .section{margin-top:12px}
  .section h2{font-size:16px;margin:16px 6px;color:#dbeafe;opacity:.9;display:flex;gap:8px;align-items:center}
  .chip{padding:3px 8px;border-radius:999px;background:rgba(0,228,255,.12);border:1px solid rgba(0,228,255,.25);color:#7dd3fc;font-size:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:10px;box-shadow:var(--shadow);position:relative;overflow:hidden;isolation:isolate;aspect-ratio: 1 / 1.05;display:flex;flex-direction:column;justify-content:space-between}
  .card:before{content:"";position:absolute;inset:-1px;border-radius:inherit;background:var(--grad);filter:blur(28px);opacity:.5;z-index:-1}
  .card:hover{transform:translateY(-2px);transition:transform .15s ease;box-shadow:0 14px 36px rgba(0,0,0,.5), 0 0 24px rgba(0,228,255,.18)}
  .lot-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .lot-meta{display:flex;gap:8px;align-items:center}
  .logo{width:26px;height:26px;border-radius:9px;background:linear-gradient(135deg, rgba(0,228,255,.35), rgba(139,92,246,.35));display:grid;place-items:center;font-weight:900;color:#00131a;box-shadow:inset 0 0 12px rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.35)}
  .lot-name{font-weight:800;font-size:12px;letter-spacing:.2px}
  .pill{font-size:11px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:#cbd5e1}
  .res{font-size:20px;font-weight:900;letter-spacing:.6px}
  .muted{color:var(--muted);font-size:12px}
  .status-open{color:var(--good);font-weight:800}
  .status-closed{color:var(--bad);font-weight:800}
  /* Admin accordion */
  .admin-tab{position:fixed;right:0;top:40%;transform:translateY(-50%);z-index:8}
  .admin-handle{writing-mode:vertical-rl;transform:rotate(180deg);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);padding:10px 6px;border-radius:10px 0 0 10px;cursor:pointer;font-weight:800;letter-spacing:.08em}
  .admin-accordion{position:fixed;right:-230px;top:30%;width:230px;background:var(--panel);border:1px solid rgba(255,255,255,.12);border-right:none;border-radius:14px 0 0 14px;transition:right .18s;box-shadow:-10px 0 40px rgba(0,0,0,.4);z-index:9}
  .admin-accordion.open{right:0}
  .admin-accordion .inner{padding:12px;display:flex;flex-direction:column;gap:8px}
  .btn{background:linear-gradient(135deg, var(--acc1), var(--acc2));border:none;color:#00131a;font-weight:900;padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--ring)}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);padding:8px 10px;border-radius:10px;cursor:pointer}
  /* Admin modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:20}
  .modal.show{display:grid}
  .panel{width:min(1000px,96vw);max-height:85vh;overflow:auto;background:var(--panel);border:1px solid rgba(255,255,255,.15);border-radius:18px;padding:16px;box-shadow:var(--ring)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tabs button{background:rgba(255,255,255,.06);color:#dbeafe;border:1px solid rgba(255,255,255,.12);font-weight:700;padding:8px 12px;border-radius:10px}
  .tabs button.active{background:linear-gradient(135deg, var(--acc1), var(--acc2));color:#00131a}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px dashed rgba(255,255,255,.12);padding:8px;font-size:14px;vertical-align:top}
  input[type="text"],input[type="password"]{width:140px;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0a0f17;color:var(--text);box-shadow:var(--ring)}
  select{padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0a0f17;color:var(--text)}
  .dropzone{border:2px dashed rgba(148,163,184,.6);border-radius:14px;padding:16px;text-align:center;color:#a3b2c8;background:rgba(148,163,184,.05)}
  .ocr-grid{display:grid;grid-template-columns: 1fr 1fr 1fr 1fr 120px;gap:6px;align-items:center}
  .ocr-row{padding:6px;border-bottom:1px dashed rgba(255,255,255,.08)}
  footer{position:fixed;bottom:0;left:0;right:0;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(0deg, rgba(6,7,11,.95), transparent);border-top:1px solid rgba(255,255,255,.06);z-index:5}
  .logo-big{display:flex;align-items:center;gap:10px}
  .glow{text-shadow:0 0 10px rgba(0,228,255,.5), 0 0 24px rgba(139,92,246,.35)}
  .eye{cursor:pointer;margin-left:-32px;user-select:none}
</style>
</head>
<body>
  <header>
    <div class="hero">
      <div class="brand">
        <!-- Neon SVG Logo -->
        <svg width="38" height="38" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#00e4ff"/><stop offset="1" stop-color="#8b5cf6"/>
            </linearGradient>
          </defs>
          <circle cx="32" cy="32" r="28" fill="none" stroke="url(#g1)" stroke-width="3"/>
          <path d="M18 36 L32 18 L46 36" fill="none" stroke="#00ffa3" stroke-width="3" stroke-linecap="round"/>
          <circle cx="32" cy="42" r="4" fill="#00ffa3"/>
        </svg>
        <div>
          <h1 class="glow">Mangos Lottery</h1>
          <div class="subtitle">Resultados ‚Ä¢ USA ‚Ä¢ Santo Domingo ‚Ä¢ Special</div>
        </div>
      </div>
      <div class="toolbar">
        <input id="q" class="search" placeholder="Buscar loter√≠a o draw‚Ä¶" />
        <span class="time" id="clock"></span>
      </div>
    </div>
  </header>

  <main id="app"></main>

  <!-- Admin Handle & Accordion -->
  <div class="admin-tab">
    <div class="admin-handle" id="openAccordion">‚ãÆ‚ãÆ</div>
  </div>
  <div class="admin-accordion" id="accordion">
    <div class="inner">
      <button id="btnShowAdmin" class="btn">ADMIN</button>
      <div class="muted" style="font-size:12px">Panel oculto</div>
    </div>
  </div>

  <!-- Admin PIN Modal -->
  <div class="modal" id="pinModal" aria-hidden="true">
    <div class="panel" style="max-width:380px">
      <h3 style="margin:0 0 8px 0">Ingresar PIN</h3>
      <div class="muted" style="margin-bottom:10px">Introduce el PIN para acceder al panel.</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="pinField" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" />
        <span class="eye" id="toggleEye" title="Mostrar/ocultar">üëÅÔ∏è</span>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="ghost" id="cancelPin">Cancelar</button>
        <button class="btn" id="enterPin">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="panel">
      <div class="tabs">
        <button data-tab="results" class="active">Resultados</button>
        <button data-tab="ocr">OCR</button>
        <button data-tab="catalog">Cat√°logo</button>
      </div>
      <section id="tab-results"></section>
      <section id="tab-ocr" style="display:none"></section>
      <section id="tab-catalog" style="display:none"></section>
    </div>
  </div>

  <footer>
    <div class="logo-big"><strong class="glow">‚ö°</strong><span class="muted">Actualiza en vivo desde Admin</span></div>
    <div class="muted">PIN: <b>1983</b></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* =============================
   Cat√°logo con reglas especiales (TX/TN)
============================= */
const DEFAULT_CATALOG = {
  sections: [
    {
      id: "usa",
      title: "USA Lotteries",
      format: "P3P4",
      items: [
        { id:"ny", name:"New York", draws:["Midday","Evening"] },
        { id:"nj", name:"New Jersey", draws:["Midday","Evening"] },
        { id:"pa", name:"Pennsylvania", draws:["Day","Evening"] },
        { id:"de", name:"Delaware", draws:["Day","Night"] },
        { id:"ct", name:"Connecticut", draws:["Day","Night"] },
        { id:"md", name:"Maryland", draws:["Midday","Evening"] },
        { id:"ma", name:"Massachusetts", draws:["Midday","Evening"] },
        { id:"va", name:"Virginia", draws:["Day","Night"] },
        { id:"mi", name:"Michigan", draws:["Midday","Evening"] },
        { id:"fl", name:"Florida", draws:["Midday","Evening"] },
        { id:"nc", name:"North Carolina", draws:["Day","Evening"] },
        { id:"sc", name:"South Carolina", draws:["Midday","Evening"] },
        // Tennessee: 3 diarios Lun‚ÄìS√°b + Solo Evening el domingo
        { id:"tn", name:"Tennessee", draws:["Morning","Midday","Evening"], schedule:{
          mon:[0,1,2], tue:[0,1,2], wed:[0,1,2], thu:[0,1,2], fri:[0,1,2], sat:[0,1,2], sun:[2] } },
        // Texas: 4 diarios Lun‚ÄìS√°b (no hay sorteos el domingo)
        { id:"tx", name:"Texas", draws:["Morning","Day","Evening","Night"], schedule:{
          mon:[0,1,2,3], tue:[0,1,2,3], wed:[0,1,2,3], thu:[0,1,2,3], fri:[0,1,2,3], sat:[0,1,2,3], sun:[] } },
        // Georgia: 3 diarios
        { id:"ga", name:"Georgia", draws:["Midday","Evening","Night"] }
      ]
    },
    {
      id:"sd",
      title:"Santo Domingo Lotteries",
      format:"QPT",
      items:[
        { id:"la-primera", name:"La Primera", draws:["D√≠a","Noche"] },
        { id:"lotedom", name:"Lotedom", draws:["Mediod√≠a"] },
        { id:"real", name:"Loter√≠a Real", draws:["Tarde"] },
        { id:"ganamas", name:"Gana M√°s (Loter√≠a Nacional)", draws:["Tarde"] },
        { id:"nacional", name:"Loter√≠a Nacional", draws:["Noche"] },
        { id:"la-suerte", name:"La Suerte Dominicana", draws:["12:30","6:00 pm"] },
        { id:"quiniela-pale", name:"Quiniela Pal√©", draws:["Noche"] },
        { id:"loteka", name:"Loteka", draws:["Noche"] }
      ]
    },
    {
      id:"special",
      title:"Special Lotteries",
      format:"XX-XX-XX",
      items:[
        { id:"anguilla", name:"Anguilla", draws:["10:00","1:00","6:00","9:00"] },
        { id:"king", name:"King Lottery (SXM)", draws:["Midday","Night"] },
        { id:"panama", name:"Panam√°", draws:["Programados"] },
        { id:"ny-race", name:"NY Horses", draws:["R1","R2","R3"] },
        { id:"ny-bk", name:"NY-BK", draws:["AM","PM"] },
        { id:"extra", name:"Extra", draws:["Midday"] }
      ]
    }
  ]
};

const KEY="lottoResults"; const KEY_CATALOG="lottoCatalog";
const PIN="1983";
let authed=false;

const ABBR_MAP = [
  // --- From user's list ---
  // New York
  { keys:["MIDDAY","MID","NY AM","NY MID","NYS AM"], target:{section:"usa",lottery:"ny",draw:"Midday"} },
  { keys:["NYS","STATE","NY PM","NY NIGHT","NEW YORK NIGHT","NEW YORK EVENING"], target:{section:"usa",lottery:"ny",draw:"Evening"} },
  // Brooklyn & Horses (Special)
  { keys:["BK-DAY","BK DAY","BK AM"], target:{section:"special",lottery:"ny-bk",draw:"AM"} },
  { keys:["BK-TV","BK TV","BK PM","BROOKLYN NIGHT"], target:{section:"special",lottery:"ny-bk",draw:"PM"} },
  { keys:["NY","NY HORSES","HORSES"], target:{section:"special",lottery:"ny-race",draw:"AUTO_R"} }, // AUTO_R = R1,R2,R3 in order
  // New Jersey
  { keys:["NJ-DAY","NJ AM","NJ AM.","NJ MIDDAY","NJ MID"], target:{section:"usa",lottery:"nj",draw:"Midday"} },
  { keys:["NJ-NIGHT","NJ PM","NJ NIGHT","NEW JERSEY EVENING"], target:{section:"usa",lottery:"nj",draw:"Evening"} },
  // Connecticut
  { keys:["CONN-DAY","CT AM","CT DAY","CONNECTICUT MIDDAY"], target:{section:"usa",lottery:"ct",draw:"Day"} },
  { keys:["CONN-NIGHT","CT PM","CT NIGHT","CONNECTICUT EVENING"], target:{section:"usa",lottery:"ct",draw:"Night"} },
  // Florida
  { keys:["FLA-MIDDAY","FLORIDA AM","FL AM","FLA AM"], target:{section:"usa",lottery:"fl",draw:"Midday"} },
  { keys:["FLA-NIGHT","FLORIDA PM","FL PM","FLA PM","FL NIGHT","FL EVENING"], target:{section:"usa",lottery:"fl",draw:"Evening"} },
  // Georgia
  { keys:["GEORGIA EVE","GA EVE","GA MIDDAY","GEORGIA MIDDAY"], target:{section:"usa",lottery:"ga",draw:"Midday"} },
  { keys:["GEORGIA PM","GA PM","GEORGIA EVENING"], target:{section:"usa",lottery:"ga",draw:"Evening"} },
  { keys:["GEORGIA NIGHT","GA NIGHT"], target:{section:"usa",lottery:"ga",draw:"Night"} },
  // Pennsylvania
  { keys:["PA AM","PENN AM","PA DAY","PENNSYLVANIA DAY"], target:{section:"usa",lottery:"pa",draw:"Day"} },
  { keys:["PA PM","PENN PM","PENNSYLVANIA EVENING"], target:{section:"usa",lottery:"pa",draw:"Evening"} },
  // Santo Domingo bucket (generic, will not auto-assign to a specific RD lottery)
  { keys:["STO DGO","SANTO DOMINGO","RD"], target:{section:"sd",lottery:null,draw:null} }
];

const AUTO_R_ORDER = ["R1","R2","R3"];

const seedResults = {
  "usa/ny/Midday": { value: "123-4567", updatedAt: Date.now() },
  "usa/ny/Evening": { value: "987-6543", updatedAt: Date.now() },
  "sd/la-primera/D√≠a": { value: "12-34-56", updatedAt: Date.now() }
};

/* =============================
   Storage
============================= */
function ensureSeed(){
  if(!localStorage.getItem(KEY_CATALOG)){
    localStorage.setItem(KEY_CATALOG, JSON.stringify(DEFAULT_CATALOG));
  }
  if(!localStorage.getItem(KEY)){
    localStorage.setItem(KEY, JSON.stringify({results:seedResults}));
  }
}
function getCatalog(){ return JSON.parse(localStorage.getItem(KEY_CATALOG)||"{}"); }
function saveCatalog(cat){ localStorage.setItem(KEY_CATALOG, JSON.stringify(cat)); }
function getStore(){ return JSON.parse(localStorage.getItem(KEY)||"{}"); }
function saveStore(store){ localStorage.setItem(KEY, JSON.stringify(store)); }

/* =============================
   Helpers & UI
============================= */
class Bus extends EventTarget{}; const bus = new Bus();
function $(s,r=document){return r.querySelector(s)}; function $all(s,r=document){return [...r.querySelectorAll(s)]}
function fmt(dt){const d=new Date(dt);return d.toLocaleString();}
function logoFor(id){
  const map={ny:"NY",nj:"NJ",pa:"PA",de:"DE",ct:"CT",md:"MD",ma:"MA",va:"VA",mi:"MI",fl:"FL",nc:"NC",sc:"SC",tn:"TN",tx:"TX",ga:"GA",
             "la-primera":"LP","lotedom":"LD","real":"RL","ganamas":"GM","nacional":"LN","la-suerte":"LS","quiniela-pale":"QP","loteka":"LK",
             "anguilla":"AI","king":"KG","panama":"PA*","ny-race":"NYR","ny-bk":"BK","extra":"EX"};
  return map[id] || id.slice(0,2).toUpperCase();
}
function formatResult(sectionId, raw){
  if(!raw) return "‚Äî";
  if(sectionId==="usa"){
    return /^\d{3}-\d{4}$/.test(raw) ? raw : "123-4567";
  }
  return /^\d{2}-\d{2}-\d{2}$/.test(raw) ? raw : "12-34-56";
}
function isDrawActive(item, idx){
  if(!item.schedule) return true;
  const map = item.schedule;
  const dow = ["sun","mon","tue","wed","thu","fri","sat"][new Date().getDay()];
  const allowed = map[dow] || [];
  return allowed.includes(idx);
}
function statusBadge(active){ return active?'<span class="status-open">Abierto</span>':'<span class="status-closed">Cerrado</span>'; }

/* =============================
   Render Landing
============================= */
function render(filter=""){
  const q = (filter||"").toLowerCase().trim();
  const app = $("#app"); app.innerHTML="";
  const cat = getCatalog(); const store = getStore();
  cat.sections.forEach(section=>{
    const wrapper = document.createElement("div"); wrapper.className="section";
    wrapper.innerHTML = `<h2>${section.title} <span class="chip">${section.items.length} loter√≠as</span></h2>`;
    const grid = document.createElement("div"); grid.className="grid";
    section.items.forEach(item=>{
      if(q && !(`${section.title} ${item.name} ${item.id}`.toLowerCase().includes(q))) return;
      item.draws.forEach((drawName, idx)=>{
        const key = `${section.id}/${item.id}/${drawName}`;
        const res = store.results?.[key]?.value || "";
        const active = isDrawActive(item, idx);
        const card = document.createElement("div"); card.className="card";
        card.innerHTML = `
          <div class="lot-head">
            <div class="lot-meta">
              <div class="logo">${logoFor(item.id)}</div>
              <div class="lot-name">${item.name}</div>
            </div>
            <div class="pill">${drawName}</div>
          </div>
          <div class="res">${formatResult(section.id, res)}</div>
          <div class="muted">${statusBadge(active)} ¬∑ <span class="time">${fmt(store.results?.[key]?.updatedAt||Date.now())}</span></div>
        `;
        grid.appendChild(card);
      });
    });
    wrapper.appendChild(grid); app.appendChild(wrapper);
  });
}

/* =============================
   Admin Access (Accordion + PIN Modal)
============================= */
const accordion = $("#accordion");
$("#openAccordion").addEventListener("click",()=>accordion.classList.toggle("open"));
$("#btnShowAdmin").addEventListener("click",()=>{
  if(!authed){ $("#pinModal").classList.add("show"); $("#pinField").focus(); return; }
  openAdmin();
});
$("#cancelPin").onclick=()=>$("#pinModal").classList.remove("show");
$("#toggleEye").onclick=()=>{
  const f=$("#pinField"); f.type = f.type==="password" ? "text" : "password";
};
$("#enterPin").onclick=()=>{
  if($("#pinField").value===PIN){ authed=true; $("#pinModal").classList.remove("show"); openAdmin(); }
  else alert("PIN incorrecto.");
};

/* =============================
   Admin Modal & Tabs
============================= */
function openAdmin(){
  const modal = $("#adminModal");
  modal.classList.add("show");
  buildResultsTab(); buildOCRTab(); buildCatalogTab();
  modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.classList.remove("show"); });
  $all(".tabs button", modal).forEach(btn=>{
    btn.addEventListener("click",()=>{
      $all(".tabs button", modal).forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      ["results","ocr","catalog"].forEach(id=>$("#tab-"+id).style.display="none");
      $("#tab-"+btn.dataset.tab).style.display="block";
    });
  });
}

/* -------- Resultados (manual) -------- */
function buildResultsTab(){
  const host = $("#tab-results"); host.innerHTML="";
  const cat = getCatalog(); const store = getStore();
  cat.sections.forEach(section=>{
    const h=document.createElement("h3"); h.textContent=section.title; host.appendChild(h);
    const table=document.createElement("table"); table.innerHTML='<thead><tr><th>Loter√≠a</th><th>Draw</th><th>Resultado</th><th></th></tr></thead>';
    const tb=document.createElement("tbody");
    section.items.forEach(item=>{
      item.draws.forEach((drawName, idx)=>{
        const key = `${section.id}/${item.id}/${drawName}`;
        const tr=document.createElement("tr");
        const input=document.createElement("input"); input.type="text"; input.placeholder=(section.id==="usa"?"123-4567":"12-34-56"); input.value = store.results?.[key]?.value || "";
        input.addEventListener("input",()=>{
          const ok = section.id==="usa" ? /^\d{3}-\d{4}$/.test(input.value) : /^\d{2}-\d{2}-\d{2}$/.test(input.value);
          input.style.borderColor = ok ? "#22c55e" : "#ef4444";
        });
        const btn=document.createElement("button"); btn.className="btn"; btn.textContent="Guardar";
        btn.onclick=()=>{
          const ok = section.id==="usa" ? /^\d{3}-\d{4}$/.test(input.value) : /^\d{2}-\d{2}-\d{2}$/.test(input.value);
          if(!ok) return alert("Formato inv√°lido.");
          const s=getStore(); s.results = s.results || {}; s.results[key] = { value: input.value, updatedAt: Date.now() };
          saveStore(s); bus.dispatchEvent(new Event("refresh"));
        };
        tr.append(td(item.name), td(drawName), tdEl(input), tdEl(btn)); tb.appendChild(tr);
      });
    });
    table.appendChild(tb); host.appendChild(table);
  });
}
function td(t){const d=document.createElement("td"); d.textContent=t; return d;}
function tdEl(n){const d=document.createElement("td"); d.appendChild(n); return d;}

/* -------- OCR -------- */
function buildOCRTab(){
  const host=$("#tab-ocr");
  host.innerHTML = `
    <div class="dropzone" id="drop">Arrastra una imagen o haz clic aqu√≠. El OCR detectar√° varias l√≠neas y asignar√° autom√°ticamente seg√∫n abreviaturas.</div>
    <div style="display:flex;gap:8px;margin:10px 0">
      <button class="ghost" id="btnParseToTable">Previsualizar tabla</button>
      <button class="btn" id="btnAssignAll">Guardar todos</button>
    </div>
    <div id="ocrTable" style="max-height:260px;overflow:auto;border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:8px"></div>
    <pre id="ocrOut" class="muted" style="white-space:pre-wrap;margin-top:8px"></pre>
  `;
  const drop=$("#drop");
  drop.addEventListener("click",()=>pickFile());
  drop.addEventListener("dragover",(e)=>{e.preventDefault(); drop.style.background="rgba(0,228,255,.08)";});
  drop.addEventListener("dragleave",()=>drop.style.background="transparent");
  drop.addEventListener("drop",(e)=>{ e.preventDefault(); drop.style.background="transparent"; const f=e.dataTransfer.files[0]; if(f) ocrFile(f); });
  $("#btnParseToTable").onclick=()=>renderOCRTable($("#ocrOut").textContent);
  $("#btnAssignAll").onclick=()=>assignAllFromTable();
}

function pickFile(){ const i=document.createElement("input"); i.type="file"; i.accept="image/*"; i.onchange=()=>{ if(i.files[0]) ocrFile(i.files[0]); }; i.click(); }

async function ocrFile(file){
  const out=$("#ocrOut"); out.textContent="Leyendo imagen con OCR‚Ä¶";
  try{
    const { data:{ text } } = await Tesseract.recognize(file, 'eng', { logger:m=>{} });
    out.textContent = text.trim();
    renderOCRTable(text.trim());
  }catch(e){ out.textContent="Error de OCR: "+e.message; }
}

/* Parse lines -> entries {abbr, p3, p4, target} */
function parseOCRText(text){
  // Split by lines; also split on semicolons
  let lines = text.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
  // Sometimes lines contain multiple fields separated by tabs/spaces
  const entries=[];
  // helper to find mapping
  const findTarget=(token)=>{
    token = token.toUpperCase().replace(/\./g,"").trim();
    for(const map of ABBR_MAP){
      for(const key of map.keys){
        const norm=key.toUpperCase().replace(/\./g,"").trim();
        if(token===norm) return map.target;
      }
    }
    return null;
  };
  // Track auto R slots for NY Horses
  const autoR = { used:0 };

  for(const raw of lines){
    // Attempt to extract abbreviation token and numbers
    // A token is sequence of letters/dashes/spaces; numbers afterwards
    const abbrMatch = raw.match(/[A-Za-z][A-Za-z\s\-\(\)\.]+/);
    const nums3 = raw.match(/(\d{3})(?!\d)/); // 3 consecutive digits
    const nums4 = raw.match(/(\d{4})(?!\d)/);
    if(!abbrMatch || (!nums3 && !nums4)) continue;
    let abbr = abbrMatch[0].trim();
    // Normalize some shorthand like "Nj am" etc.
    abbr = abbr.replace(/\s+/g," ").replace(/\bAM\b/i,"AM").replace(/\bPM\b/i,"PM");
    // Map to target
    let target = findTarget(abbr.toUpperCase());
    if(target && target.draw==="AUTO_R"){
      target = {...target, draw: AUTO_R_ORDER[Math.min(autoR.used, AUTO_R_ORDER.length-1)]};
      autoR.used++;
    }
    // Build entry only if target resolved and has draw and lottery (skip generic RD bucket)
    if(target && target.lottery){
      const p3 = nums3 ? nums3[1] : null;
      const p4 = nums4 ? nums4[1] : null;
      // Decide expected format by section
      let value = null;
      if(target.section==="usa" && p3 && p4) value = `${p3}-${p4}`;
      else if(target.section!=="usa"){
        // for RD/Special try to capture three pairs of 2 digits
        const pairs = (raw.match(/\b\d{2}\b/g)||[]).slice(0,3);
        if(pairs.length===3) value = `${pairs[0]}-${pairs[1]}-${pairs[2]}`;
      }
      entries.push({ abbr, target, p3, p4, value });
    }
  }
  return entries;
}

function renderOCRTable(text){
  const box=$("#ocrTable"); box.innerHTML="";
  const rows = parseOCRText(text);
  if(!rows.length){ box.innerHTML='<div class="muted">No se detectaron filas v√°lidas.</div>'; return; }
  // header
  const header=document.createElement("div"); header.className="ocr-grid muted";
  header.innerHTML = "<div>Abrev.</div><div>Mapa</div><div>Detectado</div><div>Valor</div><div>Acci√≥n</div>";
  box.appendChild(header);
  rows.forEach((r,i)=>{
    const row=document.createElement("div"); row.className="ocr-grid ocr-row";
    const mapLabel = `${r.target.section}/${r.target.lottery}/${r.target.draw}`;
    const detected = r.p3 && r.p4 ? `${r.p3}-${r.p4}` : (r.value||"‚Äî");
    const value = r.value || detected || "‚Äî";
    row.dataset.key = mapLabel; row.dataset.value = value;
    row.innerHTML = `
      <div>${r.abbr}</div>
      <div class="muted">${mapLabel}</div>
      <div>${detected}</div>
      <div><input type="text" value="${value}" style="width:130px"/></div>
      <div><button class="btn" data-idx="${i}">Guardar</button></div>
    `;
    box.appendChild(row);
  });
  // Attach single-save
  box.querySelectorAll("button[data-idx]").forEach(btn=>{
    btn.onclick=()=>{
      const row=btn.closest(".ocr-grid"); const input=row.querySelector("input");
      const [section,lottery,draw]=row.dataset.key.split("/");
      const store=getStore(); store.results = store.results || {};
      store.results[`${section}/${lottery}/${draw}`] = { value: input.value, updatedAt: Date.now() };
      saveStore(store); bus.dispatchEvent(new Event("refresh"));
      btn.textContent="Guardado ‚úì"; setTimeout(()=>btn.textContent="Guardar",1000);
    };
  });
}

function assignAllFromTable(){
  const box=$("#ocrTable"); const rows = [...box.querySelectorAll(".ocr-grid.ocr-row")];
  if(!rows.length) return alert("No hay filas para guardar.");
  const store=getStore(); store.results = store.results || {};
  rows.forEach(row=>{
    const input=row.querySelector("input"); const val=input.value;
    const [section,lottery,draw]=row.dataset.key.split("/");
    store.results[`${section}/${lottery}/${draw}`] = { value: val, updatedAt: Date.now() };
  });
  saveStore(store); bus.dispatchEvent(new Event("refresh"));
  alert("Todas las filas guardadas.");
}

/* -------- Cat√°logo (CRUD) -------- */
function buildCatalogTab(){
  const host=$("#tab-catalog"); const cat=getCatalog();
  host.innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <select id="catSection"></select>
      <input id="catName" type="text" placeholder="Nombre" />
      <input id="catId" type="text" placeholder="ID" />
      <input id="catDraws" type="text" placeholder="Draws separados por coma" />
      <button class="btn" id="catAdd">Agregar/Actualizar</button>
    </div>
    <div id="catList"></div>
  `;
  const sSel=$("#catSection"); sSel.innerHTML = cat.sections.map(s=>`<option value="${s.id}">${s.title}</option>`).join("");
  $("#catAdd").onclick=()=>{
    const sid=sSel.value; const name=$("#catName").value.trim(); const id=$("#catId").value.trim()||name.toLowerCase().replace(/\s+/g,"-");
    const draws=$("#catDraws").value.split(",").map(x=>x.trim()).filter(Boolean);
    if(!name||!draws.length) return alert("Completa nombre y draws.");
    const sec=cat.sections.find(x=>x.id===sid); const ex=sec.items.find(x=>x.id===id);
    if(ex){ ex.name=name; ex.draws=draws; } else { sec.items.push({id:name? id:"new", name, draws}); }
    saveCatalog(cat); buildCatalogTab(); bus.dispatchEvent(new Event("refresh"));
  };
  const list=$("#catList");
  cat.sections.forEach(section=>{
    const h=document.createElement("h3"); h.textContent=section.title; list.appendChild(h);
    section.items.forEach(item=>{
      const row=document.createElement("div"); row.style.cssText="display:flex;gap:8px;align-items:center;margin:4px 0";
      row.innerHTML = `<div style="min-width:220px">${item.name}</div><div class="muted" style="min-width:160px">${item.draws.join(", ")}</div>`;
      const del=document.createElement("button"); del.className="ghost"; del.textContent="Eliminar";
      del.onclick=()=>{ if(!confirm("Eliminar "+item.name+"?"))return; section.items=section.items.filter(x=>x.id!==item.id); saveCatalog(cat); buildCatalogTab(); bus.dispatchEvent(new Event("refresh")); };
      row.appendChild(del); list.appendChild(row);
    });
  });
}

/* =============================
   Init & events
============================= */
ensureSeed();
render();
$("#q").addEventListener("input", (e)=>render(e.target.value));
function tick(){ $("#clock").textContent = new Date().toLocaleString(); } setInterval(tick,1000); tick();
bus.addEventListener("refresh", ()=>render($("#q").value||""));

</script>
</body>
</html>
"""
with open("/mnt/data/lottery_results_portal_v3.html","w",encoding="utf-8") as f:
    f.write(html)

print("Archivo creado: /mnt/data/lottery_results_portal_v3.html")
