# We'll generate the updated single-file HTML with the requested features (v4).
# The file will be saved to /mnt/data/beast_reader_v4.html

html = r"""<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Beast Reader ‚Äî Resultados de Loter√≠as</title>
<style>
  :root{
    --bg:#0a0b10;
    --card:#10142a;
    --text:#e7f0ff;
    --muted:#a8b3d8;
    --accent1:#5df6ff;
    --accent2:#8a5dff;
    --accent3:#18ffb2;
    --danger:#ff4d6d;
    --ok:#1be7a8;
    --shadow: 0 0 22px rgba(93,246,255,.35), 0 0 55px rgba(138,93,255,.25);
    --tile: 160px;
  }
  [data-theme="light"]{
    --bg:#f7f8ff;
    --card:#ffffff;
    --text:#0b1020;
    --muted:#4a5578;
    --accent1:#00a3ff;
    --accent2:#6a40ff;
    --accent3:#00c07a;
    --shadow: 0 0 16px rgba(0,163,255,.25), 0 0 36px rgba(106,64,255,.20);
  }
  html,body{height:100%}
  body{
    margin:0;background: radial-gradient(1200px 1200px at 10% -10%, rgba(93,246,255,.10), transparent 60%),
                         radial-gradient(900px 900px at 110% 10%, rgba(138,93,255,.12), transparent 60%),
                         var(--bg);
    color:var(--text);font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
  }
  /* ===== Header / Logo ===== */
  header{
    position:sticky;top:0;z-index:50;
    backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(10,11,16,.85), rgba(10,11,16,.55));
    border-bottom: 1px solid rgba(141,160,255,.15);
  }
  [data-theme="light"] header{
    background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
  }
  .wrap{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:14px;align-items:center}
  .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
  .logo svg{width:40px;height:40px;filter: drop-shadow(0 0 12px rgba(93,246,255,.5));}
  .logo h1{font-size:clamp(18px,3.2vw,28px);margin:0;letter-spacing:.5px}
  .sub{font-size:12px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(141,160,255,.25);padding:6px 10px;border-radius:999px;background:linear-gradient(135deg, rgba(93,246,255,.08), rgba(138,93,255,.08));box-shadow:var(--shadow)}
  .chip label{font-size:12px;color:var(--muted)}
  .switch{position:relative;width:46px;height:26px;border-radius:999px;background:#2a325a;cursor:pointer}
  .knob{position:absolute;height:22px;width:22px;border-radius:50%;background:white;top:2px;left:2px;transition:.25s cubic-bezier(.22,.61,.36,1);
        box-shadow:0 2px 10px rgba(0,0,0,.35)}
  input[type="checkbox"]{display:none}
  input[type="checkbox"]:checked + .switch .knob{left:22px}
  .btn{
    background:linear-gradient(135deg, var(--accent1), var(--accent2));
    color:#06121b;border:0;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    box-shadow:var(--shadow);transition: transform .08s ease, box-shadow .2s ease;
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  /* ===== Layout ===== */
  main{max-width:1200px;margin:18px auto 64px;display:grid;grid-template-columns:300px 1fr;gap:16px}
  aside{position:sticky;top:68px;height:calc(100vh - 84px);overflow:auto;padding-right:6px}
  .panel{background:var(--card);border:1px solid rgba(141,160,255,.15);border-radius:16px;padding:14px 14px 8px;box-shadow:var(--shadow)}
  .panel h3{margin:0 0 8px 0;font-size:14px;letter-spacing:.5px;color:var(--muted);text-transform:uppercase}
  .admin-tab{
    position:fixed;left:0;top:50%;transform:translateY(-50%);z-index:60;
    background:linear-gradient(180deg, var(--accent2), var(--accent1));color:#031018;
    padding:8px 10px;border-top-right-radius:12px;border-bottom-right-radius:12px;
    font-weight:800;cursor:pointer;box-shadow:var(--shadow);user-select:none
  }
  .admin {position:fixed;left:-360px;top:0;bottom:0;width:340px;z-index:70;
    backdrop-filter: blur(12px);
    background: linear-gradient(180deg, rgba(6,10,22,.85), rgba(10,22,22,.85));
    border-right:1px solid rgba(141,160,255,.15);transition:left .25s ease}
  [data-theme="light"] .admin{background:linear-gradient(180deg, rgba(250,250,255,.9), rgba(245,245,255,.9))}
  .admin.open{left:0}
  .admin .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(141,160,255,.15)}
  .admin .body{padding:12px;overflow:auto;height:calc(100% - 56px)}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .field input,.field select,.field textarea{background:#0e1424;color:var(--text);border:1px solid rgba(141,160,255,.25);border-radius:10px;padding:8px 10px}
  [data-theme="light"] .field input,[data-theme="light"] .field select,[data-theme="light"] .field textarea{background:#fff;color:#111}
  .ocr-drop{border:1px dashed rgba(141,160,255,.35);padding:14px;border-radius:14px;text-align:center}
  .ocr-drop.drag{background:rgba(93,246,255,.08)}
  .ocr-table{width:100%;border-collapse:collapse;font-size:12px}
  .ocr-table th,.ocr-table td{border-bottom:1px solid rgba(141,160,255,.2);padding:6px}
  /* ===== Results grid ===== */
  .section{margin-bottom:16px}
  .section h2{margin:0 0 10px 0;font-size:18px;display:flex;align-items:center;gap:10px}
  .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr));gap:12px;align-items:stretch}
  .tile{position:relative;background:linear-gradient(135deg, rgba(93,246,255,.08), rgba(138,93,255,.08));border:1px solid rgba(141,160,255,.25);border-radius:16px;padding:10px;
        aspect-ratio: 1 / 1.05;display:flex;flex-direction:column;justify-content:space-between;box-shadow:var(--shadow);overflow:hidden}
  .tile:before{content:"";position:absolute;inset:-1px;border-radius:16px;padding:1px;background:
      linear-gradient(135deg, rgba(93,246,255,.45), rgba(138,93,255,.35), rgba(24,255,178,.35));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none}
  .badge{display:flex;align-items:center;gap:6px;font-weight:800}
  .emblem{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent1),var(--accent3));display:grid;place-items:center;color:#001018;
          font-size:14px;font-weight:900;box-shadow:0 0 16px rgba(93,246,255,.5)}
  .name{font-size:13px;color:var(--muted)}
  .draw{font-size:12px;color:var(--muted)}
  .nums{font-size:22px;letter-spacing:2px;font-weight:900}
  .meta{display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:10px;color:var(--muted)}
  .state{position:absolute;right:8px;top:8px;font-size:10px;color:var(--muted)}
  .status{position:absolute;left:8px;top:8px;font-size:10px;padding:2px 6px;border-radius:999px;background:rgba(24,255,178,.15);color:#00df9a;border:1px solid rgba(24,255,178,.35)}
  .status.closed{background:rgba(255,77,109,.12);color:#ff6682;border-color:rgba(255,77,109,.35)}
  /* ===== Modal ===== */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:80}
  .modal.open{display:grid}
  .card{width:min(520px, 92vw);background:var(--card);border-radius:14px;border:1px solid rgba(141,160,255,.25);box-shadow:var(--shadow);padding:12px}
  .card h3{margin:6px 0 10px 0}
  .row{display:flex;gap:8px;align-items:center}
  .eye{cursor:pointer;user-select:none;font-size:20px;padding:6px}
  .scroll-btn{position:fixed;right:14px;bottom:18px;z-index:55}
  .marquee{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;color:var(--muted)}
</style>
</head>
<body data-theme="dark">
  <div class="admin-tab" id="adminTab">ADMIN</div>
  <div class="admin" id="adminPanel" aria-hidden="true">
    <div class="head">
      <strong>Admin</strong>
      <button class="btn" id="closeAdmin">√ó</button>
    </div>
    <div class="body">
      <div class="field">
        <label>Importar imagen (OCR)</label>
        <div id="drop" class="ocr-drop">
          Arrastra aqu√≠ una imagen de resultados (.jpg/.png) o haz clic para seleccionar.
          <input type="file" id="file" accept="image/*" hidden />
        </div>
      </div>
      <div id="ocrPreview"></div>
      <hr style="border-color:rgba(141,160,255,.2)">
      <div class="field">
        <label>Agregar/Editar resultado manual</label>
        <select id="catalogSelect"></select>
        <select id="drawSelect"></select>
        <input id="resultInput" placeholder="Ej: 123-4567 (USA) o 12-34-56 (RD/Special)"/>
        <button class="btn" id="saveManual">Guardar</button>
      </div>
      <p class="marquee">‚ö° Los cambios se reflejan en vivo en la portada.</p>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal" id="pinModal">
    <div class="card">
      <h3 id="pinTitle">Acceso administrador</h3>
      <div class="field">
        <label id="pinLabel">Introduce PIN</label>
        <div class="row">
          <input id="pinInput" type="password" inputmode="numeric" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
          <span id="toggleEye" class="eye" title="Mostrar/Ocultar">üëÅÔ∏è</span>
          <button class="btn" id="pinOk">Entrar</button>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap">
      <a class="logo" href="#">
        <!-- Neon Beast SVG -->
        <svg viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#5df6ff"/><stop offset="1" stop-color="#8a5dff"/>
            </linearGradient>
            <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <rect x="4" y="4" width="64" height="64" rx="14" fill="url(#g1)"/>
          <path d="M18 46c8-2 20-12 17-22-3 8 8 14 19 11-3 12-17 19-36 11z" fill="#001219" opacity=".85" filter="url(#glow)"/>
          <circle cx="26" cy="28" r="4" fill="#001219"/><circle cx="48" cy="28" r="4" fill="#001219"/>
        </svg>
        <div>
          <h1>Beast Reader</h1>
          <div class="sub" id="subTitle">Resultados en vivo ‚Äî USA, RD & Special</div>
        </div>
      </a>
      <div class="controls">
        <div class="chip">
          <label id="langLbl">Idioma</label>
          <input id="langTgl" type="checkbox"/>
          <div class="switch"><div class="knob"></div></div>
        </div>
        <div class="chip">
          <label id="themeLbl">Tema</label>
          <input id="themeTgl" type="checkbox"/>
          <div class="switch"><div class="knob"></div></div>
        </div>
        <button class="btn scroll-btn" id="autoScrollBtn">Auto Scroll ‚ñΩ</button>
      </div>
    </div>
  </header>

  <main>
    <aside>
      <div class="panel">
        <h3 id="filtersTitle">Filtros</h3>
        <div class="field"><input id="search" placeholder="Buscar loter√≠a..."/></div>
        <div class="field"><label id="closingHint">* El cierre es 20 min antes del sorteo.</label></div>
      </div>
    </aside>
    <section id="content">
      <!-- Sections rendered here -->
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
  /*************** I18N ***************/
  const i18n = {
    es: {
      accessAdmin: "Acceso administrador",
      enterPin: "Introduce PIN",
      filters: "Filtros",
      searchPh: "Buscar loter√≠a...",
      closingHint: "* El cierre es 20 min antes del sorteo.",
      usa: "Loter√≠as de USA",
      rd: "Loter√≠as de Santo Domingo",
      special: "Loter√≠as Special",
      open: "Abierta", closed: "Cerrada",
      draw: "Sorteo", close: "Cierre",
      save: "Guardar", saveAll: "Guardar todos",
      abbr: "Abrev.", map: "Mapa", detected:"Detectado", value:"Valor", actions:"Acciones",
      admin: "Admin", adminHidden:"",  // no texto expl√≠cito
      pinOk: "Entrar"
    },
    en: {
      accessAdmin: "Admin access",
      enterPin: "Enter PIN",
      filters: "Filters",
      searchPh: "Search lottery...",
      closingHint: "* Closing time is 20 minutes before draw time.",
      usa: "USA Lotteries",
      rd: "Santo Domingo Lotteries",
      special: "Special Lotteries",
      open: "Open", closed: "Closed",
      draw: "Draw", close: "Close",
      save: "Save", saveAll: "Save all",
      abbr: "Abbrev.", map: "Map", detected:"Detected", value:"Value", actions:"Actions",
      admin: "Admin", adminHidden:"", // no explicit text
      pinOk: "Enter"
    }
  };
  let lang = localStorage.getItem("lang") || "es";
  function applyLang(){
    const t = i18n[lang];
    document.getElementById("pinTitle").textContent=t.accessAdmin;
    document.getElementById("pinLabel").textContent=t.enterPin;
    document.getElementById("filtersTitle").textContent=t.filters;
    document.getElementById("search").placeholder=t.searchPh;
    document.getElementById("closingHint").textContent=t.closingHint;
    document.getElementById("pinOk").textContent=t.pinOk;
    document.getElementById("subTitle").textContent = lang==="es" ? "Resultados en vivo ‚Äî USA, RD & Special" : "Live results ‚Äî USA, RD & Special";
    render();
  }
  document.getElementById("langTgl").checked = (lang==="en");
  document.getElementById("langTgl").addEventListener("change",e=>{lang=e.target.checked?"en":"es";localStorage.setItem("lang",lang);applyLang();});

  /*************** THEME ***************/
  const themeTgl = document.getElementById("themeTgl");
  const savedTheme = localStorage.getItem("theme") || "dark";
  document.body.setAttribute("data-theme", savedTheme);
  themeTgl.checked = savedTheme==="light";
  themeTgl.addEventListener("change", e=>{
    const th = e.target.checked?"light":"dark";
    document.body.setAttribute("data-theme", th);
    localStorage.setItem("theme", th);
  });

  /*************** ADMIN PIN ***************/
  const ADMIN_PIN = "1983";
  const adminTab = document.getElementById("adminTab");
  const adminPanel = document.getElementById("adminPanel");
  const pinModal = document.getElementById("pinModal");
  const pinInput = document.getElementById("pinInput");
  const pinOk = document.getElementById("pinOk");
  const toggleEye = document.getElementById("toggleEye");
  adminTab.addEventListener("click",()=>{pinModal.classList.add("open"); pinInput.value=""; pinInput.type="password";});
  document.getElementById("closeAdmin").addEventListener("click",()=>adminPanel.classList.remove("open"));
  pinOk.addEventListener("click",()=>{
    if(pinInput.value===ADMIN_PIN){ pinModal.classList.remove("open"); adminPanel.classList.add("open"); }
    else { pinInput.style.borderColor="var(--danger)"; setTimeout(()=>pinInput.style.borderColor="",600); }
  });
  toggleEye.addEventListener("click",()=>{ pinInput.type = pinInput.type==="password"?"text":"password"; });
  pinModal.addEventListener("click",e=>{ if(e.target===pinModal) pinModal.classList.remove("open"); });

  /*************** AUTO SCROLL ***************/
  let scrollTimer=null, scrollDown=true;
  const autoBtn = document.getElementById("autoScrollBtn");
  autoBtn.addEventListener("click",()=>{
    if(scrollTimer){ clearInterval(scrollTimer); scrollTimer=null; autoBtn.textContent="Auto Scroll ‚ñΩ"; return; }
    autoBtn.textContent="Detener Scroll";
    const area = document.scrollingElement;
    scrollTimer = setInterval(()=>{
      const step = 0.6; // pixels per tick (slow)
      area.scrollBy(0, scrollDown?step:-step);
      if(area.scrollTop + window.innerHeight + 2 >= area.scrollHeight){ scrollDown=false; }
      if(area.scrollTop<=1){ scrollDown=true; }
    }, 10);
  });

  /*************** CATALOG + SCHEDULES ***************/
  // Utility: compute closing time 20 minutes before draw
  function minus20(timeStr){
    // timeStr: "HH:MM" 24h
    const [H,M]=timeStr.split(":").map(Number);
    const when=new Date();
    when.setHours(H,M,0,0);
    when.setMinutes(when.getMinutes()-20);
    return when.toTimeString().slice(0,5);
  }
  // Days helper: 0=Sun..6=Sat
  const ALL=[0,1,2,3,4,5,6], M_S=[1,2,3,4,5,6]; // Mon-Sat
  const MON_SAT=[1,2,3,4,5,6];

  // Catalog of lotteries
  const catalog = {
    usa: [
      { id:"ny",  name:"New York", abbr:"NY", emblem:"NY", tz:"ET",
        draws:[
          {code:"Midday",  time:"14:30", days:ALL},
          {code:"Evening", time:"22:30", days:ALL}
        ]
      },
      { id:"nj",  name:"New Jersey", abbr:"NJ", emblem:"NJ", tz:"ET",
        draws:[
          {code:"Midday",  time:"12:59", days:ALL},
          {code:"Evening", time:"22:57", days:ALL}
        ]
      },
      { id:"ct",  name:"Connecticut", abbr:"CT", emblem:"CT", tz:"ET",
        draws:[
          {code:"Day",     time:"13:57", days:ALL},
          {code:"Night",   time:"22:29", days:ALL}
        ]
      },
      { id:"fl",  name:"Florida", abbr:"FL", emblem:"FL", tz:"ET",
        draws:[
          {code:"Midday",  time:"13:30", days:ALL},
          {code:"Evening", time:"21:45", days:ALL}
        ]
      },
      { id:"ga",  name:"Georgia", abbr:"GA", emblem:"GA", tz:"ET",
        draws:[
          {code:"Midday",  time:"12:29", days:ALL},
          {code:"Evening", time:"18:59", days:ALL},
          {code:"Night",   time:"23:34", days:ALL}
        ]
      },
      { id:"pa",  name:"Pennsylvania", abbr:"PA", emblem:"PA", tz:"ET",
        draws:[
          {code:"Day",     time:"13:35", days:ALL},
          {code:"Evening", time:"18:59", days:ALL}
        ]
      },
      { id:"de",  name:"Delaware", abbr:"DE", emblem:"DE", tz:"ET",
        draws:[
          {code:"Day",     time:"13:58", days:ALL},
          {code:"Night",   time:"19:57", days:ALL}
        ]
      },
      { id:"md",  name:"Maryland", abbr:"MD", emblem:"MD", tz:"ET",
        draws:[
          {code:"Midday",  time:"12:28", days:ALL},
          {code:"Evening", time:"19:56", days:ALL}
        ]
      },
      { id:"ma",  name:"Massachusetts", abbr:"MA", emblem:"MA", tz:"ET",
        draws:[
          {code:"Midday",  time:"14:00", days:ALL},
          {code:"Evening", time:"21:00", days:ALL}
        ]
      },
      { id:"va",  name:"Virginia", abbr:"VA", emblem:"VA", tz:"ET",
        draws:[
          {code:"Day",     time:"13:59", days:ALL},
          {code:"Night",   time:"23:00", days:ALL}
        ]
      },
      { id:"mi",  name:"Michigan", abbr:"MI", emblem:"MI", tz:"ET",
        draws:[
          {code:"Midday",  time:"12:59", days:ALL},
          {code:"Evening", time:"19:29", days:ALL}
        ]
      },
      { id:"nc",  name:"North Carolina", abbr:"NC", emblem:"NC", tz:"ET",
        draws:[
          {code:"Day",     time:"15:00", days:ALL},
          {code:"Evening", time:"23:22", days:ALL}
        ]
      },
      { id:"sc",  name:"South Carolina", abbr:"SC", emblem:"SC", tz:"ET",
        draws:[
          {code:"Midday",  time:"12:59", days:MON_SAT},
          {code:"Evening", time:"18:59", days:ALL}
        ]
      },
      { id:"tx",  name:"Texas", abbr:"TX", emblem:"TX", tz:"CT",
        draws:[
          {code:"Morning", time:"10:00", days:[1,2,3,4,5,6]}, // no Sunday
          {code:"Day",     time:"12:27", days:[1,2,3,4,5,6]},
          {code:"Evening", time:"18:00", days:[1,2,3,4,5,6]},
          {code:"Night",   time:"22:12", days:[1,2,3,4,5,6]}
        ]
      },
      { id:"tn",  name:"Tennessee", abbr:"TN", emblem:"TN", tz:"CT",
        draws:[
          {code:"Morning", time:"09:28", days:[1,2,3,4,5,6]}, // Mon-Sat
          {code:"Midday",  time:"12:28", days:[1,2,3,4,5,6]}, // Mon-Sat
          {code:"Evening", time:"18:28", days:ALL} // Sun only this one
        ]
      }
    ],
    rd: [
      { id:"real",  name:"Loter√≠a Real", abbr:"REAL", emblem:"RL", tz:"AST",
        draws:[{code:"Mediod√≠a", time:"12:55", days:[1,2,3,4,5,6,0]}]
      },
      { id:"ganamas",name:"Gana M√°s", abbr:"GANAMAS", emblem:"GM", tz:"AST",
        draws:[{code:"Tarde", time:"14:30", days:[1,2,3,4,5,6,0]}]
      },
      { id:"loteka", name:"Loteka", abbr:"LOTEKA", emblem:"LK", tz:"AST",
        draws:[{code:"Noche", time:"19:55", days:[1,2,3,4,5,6,0]}]
      },
      { id:"nacional", name:"Loter√≠a Nacional", abbr:"NAC", emblem:"LN", tz:"AST",
        draws:[{code:"Tarde", time:"14:30", days:ALL},{code:"Noche", time:"21:00", days:[1,2,3,4,5,6]}, {code:"Domingo", time:"18:00", days:[0]}]
      },
      { id:"quiniela", name:"Quiniela Pal√© (Leidsa)", abbr:"QP", emblem:"QP", tz:"AST",
        draws:[{code:"Diario", time:"20:55", days:[1,2,3,4,5,6]},{code:"Domingo", time:"15:55", days:[0]}]
      },
      { id:"laprimera", name:"La Primera", abbr:"PRIMERA", emblem:"LP", tz:"AST",
        draws:[{code:"AM", time:"12:00", days:ALL}, {code:"PM", time:"20:00", days:ALL}]
      },
      { id:"lasuerte", name:"La Suerte Dominicana", abbr:"SUERTE", emblem:"LS", tz:"AST",
        draws:[{code:"AM", time:"12:30", days:ALL}, {code:"PM", time:"18:00", days:ALL}]
      },
      { id:"lotedom", name:"LoteDom", abbr:"LOTEDOM", emblem:"LD", tz:"AST",
        draws:[{code:"Tarde", time:"13:55", days:ALL}]
      }
    ],
    special: [
      { id:"ny-bk", name:"NY-BK", abbr:"BK", emblem:"BK", tz:"ET", draws:[{code:"AM", time:"12:00", days:ALL},{code:"PM",time:"22:00",days:ALL}]},
      { id:"ny-race", name:"NY Horses", abbr:"NYH", emblem:"NY", tz:"ET", draws:[{code:"R1", time:"14:00", days:ALL},{code:"R2",time:"18:30",days:ALL},{code:"R3",time:"21:30",days:ALL}]},
      { id:"357", name:"3-5-7", abbr:"357", emblem:"35", tz:"ET", draws:[{code:"Main", time:"20:30", days:ALL}]}
    ]
  };

  // Build select options in admin
  const catalogSelect = document.getElementById("catalogSelect");
  const drawSelect = document.getElementById("drawSelect");
  function fillCatalogSelect(){
    const groups=[["usa","USA"],["rd","RD"],["special","Special"]];
    catalogSelect.innerHTML="";
    groups.forEach(([key,label])=>{
      catalog[key].forEach(lot=>{
        const opt=document.createElement("option");
        opt.value = key+"|"+lot.id;
        opt.textContent = `${label} ‚Äî ${lot.name}`;
        catalogSelect.appendChild(opt);
      });
    });
    fillDraws();
  }
  function fillDraws(){
    const [section,id] = catalogSelect.value.split("|");
    const lot = catalog[section].find(x=>x.id===id);
    drawSelect.innerHTML="";
    lot.draws.forEach(d=>{
      const o=document.createElement("option");
      o.value=d.code;o.textContent=d.code;drawSelect.appendChild(o);
    });
  }
  catalogSelect.addEventListener("change",fillDraws);
  fillCatalogSelect();

  /*************** DATA (results) ***************/
  const results = JSON.parse(localStorage.getItem("lottoResults")||"{}");
  function setResult(section,id,draw,value){
    results[section] ??= {};
    results[section][id] ??= {};
    results[section][id][draw] = { value, ts: new Date().toISOString() };
    localStorage.setItem("lottoResults", JSON.stringify(results));
    render();
  }
  document.getElementById("saveManual").addEventListener("click",()=>{
    const [section,id] = catalogSelect.value.split("|");
    setResult(section,id,drawSelect.value,document.getElementById("resultInput").value.trim());
  });

  /*************** OCR ***************/
  const drop = document.getElementById("drop");
  const fileInput = document.getElementById("file");
  drop.addEventListener("click",()=>fileInput.click());
  ;["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add("drag")}));
  ;["dragleave","drop"].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove("drag")}));
  drop.addEventListener("drop",e=>{ if(e.dataTransfer.files[0]) processImage(e.dataTransfer.files[0]); });
  fileInput.addEventListener("change",e=>{ if(e.target.files[0]) processImage(e.target.files[0]); });

  const abbrMap = [
    // New York
    {keys:["MIDDAY","NY AM","NYMID","NYMIDDAY","N Y"], map:{section:"usa", id:"ny", draw:"Midday"}, fmt:"usa"},
    {keys:["STATE","NYS","NY PM","NYNIGHT","NYEVENING","NEWYORKEVENING"], map:{section:"usa", id:"ny", draw:"Evening"}, fmt:"usa"},
    // NY Horses
    {keys:["NY","NYHORSES","HORSES"], map:{section:"special", id:"ny-race", draw:"R1"}, fmt:"rd"},
    // Brooklyn
    {keys:["BKDAY","BKAM","BK-DAY"], map:{section:"special", id:"ny-bk", draw:"AM"}, fmt:"rd"},
    {keys:["BKTV","BKPM","BK-NIGHT"], map:{section:"special", id:"ny-bk", draw:"PM"}, fmt:"rd"},
    // New Jersey
    {keys:["NJDAY","NJAM","NJD","NJ-MIDDAY","NJ A M"], map:{section:"usa", id:"nj", draw:"Midday"}, fmt:"usa"},
    {keys:["NJPM","NJNIGHT","NJE","NJ P M"], map:{section:"usa", id:"nj", draw:"Evening"}, fmt:"usa"},
    // Connecticut
    {keys:["CTAM","CTDAY","CONNDAY","CT A M"], map:{section:"usa", id:"ct", draw:"Day"}, fmt:"usa"},
    {keys:["CTPM","CTNIGHT","CONNNIGHT","CT P M"], map:{section:"usa", id:"ct", draw:"Night"}, fmt:"usa"},
    // Florida
    {keys:["FLORIDAAM","FLAM","FLAAM","FLA-MIDDAY"], map:{section:"usa", id:"fl", draw:"Midday"}, fmt:"usa"},
    {keys:["FLORIDAPM","FLPM","FLANIGHT","FLA-PM"], map:{section:"usa", id:"fl", draw:"Evening"}, fmt:"usa"},
    // Georgia
    {keys:["GEORGIAAM","GAAM"], map:{section:"usa", id:"ga", draw:"Midday"}, fmt:"usa"},
    {keys:["GEORGIAEVE","GEORGIAEVENING","GAPM","GAP"], map:{section:"usa", id:"ga", draw:"Evening"}, fmt:"usa"},
    {keys:["GEORGIANIGHT","GANIGHT","GAE"], map:{section:"usa", id:"ga", draw:"Night"}, fmt:"usa"},
    // Pennsylvania
    {keys:["PAAM","PENNAM","PADAY"], map:{section:"usa", id:"pa", draw:"Day"}, fmt:"usa"},
    {keys:["PAPM","PENNPM","PAEVENING"], map:{section:"usa", id:"pa", draw:"Evening"}, fmt:"usa"},
    // Delaware
    {keys:["DEAM","DEDAY"], map:{section:"usa", id:"de", draw:"Day"}, fmt:"usa"},
    {keys:["DEPM","DENIGHT"], map:{section:"usa", id:"de", draw:"Night"}, fmt:"usa"},
    // Connecticut short
    {keys:["CTPM"], map:{section:"usa", id:"ct", draw:"Night"}, fmt:"usa"},
    // RD
    {keys:["LOTEKA"], map:{section:"rd", id:"loteka", draw:"Noche"}, fmt:"rd"},
    {keys:["REAL"], map:{section:"rd", id:"real", draw:"Mediod√≠a"}, fmt:"rd"},
    {keys:["GANAMAS","GANAM√ÅS","GANA MAS","GANAMAS"], map:{section:"rd", id:"ganamas", draw:"Tarde"}, fmt:"rd"},
    {keys:["QUINIELAPALE","QUINIELAPALELEIDSA","QUINIELAPALE (LEIDSA)","QUINIELAPALELEIDSA"], map:{section:"rd", id:"quiniela", draw:"Diario"}, fmt:"rd"},
    {keys:["NACIONAL","NATIONAL"], map:{section:"rd", id:"nacional", draw:"Noche"}, fmt:"rd"},
    {keys:["LAPRIMERA"], map:{section:"rd", id:"laprimera", draw:"AM"}, fmt:"rd"},
    {keys:["LASUERTE","SUERTE"], map:{section:"rd", id:"lasuerte", draw:"AM"}, fmt:"rd"},
    {keys:["LOTEDOM"], map:{section:"rd", id:"lotedom", draw:"Tarde"}, fmt:"rd"},
    // Special 3-5-7
    {keys:["3.5.7","357","3-5-7"], map:{section:"special", id:"357", draw:"Main"}, fmt:"rd"}
  ];
  function norm(s){ return s.toUpperCase().replace(/\s+/g,"").replace(/[^\w]/g,""); }

  function processImage(file){
    const preview = document.getElementById("ocrPreview");
    preview.innerHTML = "<p>Procesando imagen con OCR...</p>";
    const imgUrl = URL.createObjectURL(file);
    Tesseract.recognize(imgUrl, 'eng', { logger: m => {} })
      .then(({ data:{ text } })=>{
        const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        const rows = [];
        // Extract pairs like "label --- 123 - 4567" or "label 444"
        for(const ln of lines){
          // Split by dashes or colon
          const m = ln.match(/^(.{2,24}?)[\s\-\‚Äî\_:.]+([0-9\s\-]{2,12,})$/i);
          if(m){
            rows.push({abbr:m[1].trim(), detected:m[2].trim().replace(/\s+/g,"")});
          }else{
            const m2 = ln.match(/^([A-Za-z\.\s]{2,24})\s+([0-9]{2,4}(\s*-\s*[0-9]{2,4})?)$/);
            if(m2) rows.push({abbr:m2[1].trim(), detected:m2[2].trim().replace(/\s+/g,"")});
          }
        }
        renderOCRTable(rows);
      })
      .catch(err=>{ preview.innerHTML = "<p style='color:var(--danger)'>OCR fall√≥: "+err+"</p>"; });
  }

  function mapAbbrev(ab){
    const N = norm(ab);
    for(const rule of abbrMap){
      if(rule.keys.some(k => N.includes(k))) return rule.map;
    }
    // Heuristics for common patterns
    if(N==="MIDDAY") return {section:"usa", id:"ny", draw:"Midday"};
    if(N==="STATE") return {section:"usa", id:"ny", draw:"Evening"};
    return null;
  }

  function isUSA(section){ return section==="usa"; }
  function validUSA(val){ return /^\d{3}\-\d{4}$/.test(val); }
  function validRD(val){ return /^\d{2}\-\d{2}\-\d{2}$/.test(val) || /^\d{3}$/.test(val); }

  function renderOCRTable(rows){
    const t=i18n[lang];
    const div = document.getElementById("ocrPreview");
    const table = document.createElement("table"); table.className="ocr-table";
    table.innerHTML = `<thead><tr>
      <th>${t.abbr}</th><th>${t.map}</th><th>${t.detected}</th><th>${t.value}</th><th>${t.actions}</th>
    </tr></thead>`;
    const tb=document.createElement("tbody");
    rows.forEach((r,idx)=>{
      const map = mapAbbrev(r.abbr);
      const tr = document.createElement("tr");
      const mapTxt = map? `${map.section}/${map.id}/${map.draw}` : "‚Äî";
      const inp = document.createElement("input");
      // normalize value spaces -> hyphen
      const normv = r.detected.replace(/\s*-\s*/g,"-");
      inp.value = normv;
      tr.innerHTML = `<td>${r.abbr}</td><td>${mapTxt}</td><td>${r.detected}</td>`;
      const tdv = document.createElement("td"); tdv.appendChild(inp); tr.appendChild(tdv);
      const save = document.createElement("button"); save.className="btn"; save.textContent=t.save;
      save.addEventListener("click",()=>{
        if(!map) return;
        const val = inp.value.trim();
        const ok = isUSA(map.section)? validUSA(val) : validRD(val);
        if(!ok){ inp.style.borderColor="var(--danger)"; setTimeout(()=>inp.style.borderColor="",800); return; }
        setResult(map.section, map.id, map.draw, val);
      });
      const tda = document.createElement("td"); tda.appendChild(save); tr.appendChild(tda);
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    const all = document.createElement("button"); all.className="btn"; all.textContent=t.saveAll;
    all.addEventListener("click",()=>{
      [...tb.querySelectorAll("tr")].forEach(tr=>{
        const ab = tr.children[0].textContent;
        const map = mapAbbrev(ab); if(!map) return;
        const val = tr.querySelector("input").value.trim();
        const ok = isUSA(map.section)? validUSA(val) : validRD(val);
        if(ok) setResult(map.section, map.id, map.draw, val);
      });
    });
    div.innerHTML=""; div.appendChild(table); div.appendChild(all);
  }

  /*************** RENDER ***************/
  function inDays(days,d){ return days.includes(d); }
  function fmtDrawClose(t){ return {draw:t, close: minus20(t)}; }
  function withinOpen(draw, tz){
    // For display only: if current minute < close -> "Abierta"
    const now = new Date();
    // Interpret draw.close in local time for simplicity
    const [cH,cM] = minus20(draw.time).split(":").map(Number);
    const [dH,dM] = draw.time.split(":").map(Number);
    const today = now.getDay();
    const nowMin = now.getHours()*60 + now.getMinutes();
    const closeMin = cH*60 + cM;
    const drawMin = dH*60 + dM;
    const open = nowMin < closeMin && inDays(draw.days,today);
    const closed = nowMin >= closeMin && nowMin < drawMin && inDays(draw.days,today) ? "closing" : (!inDays(draw.days,today) ? "off" : "after");
    return open ? "open" : "closed";
  }

  function renderSection(key, title){
    const sec = document.createElement("div");
    sec.className="section";
    sec.innerHTML = `<h2>${title}</h2><div class="grid"></div>`;
    const grid = sec.querySelector(".grid");
    const q = document.getElementById("search").value.trim().toLowerCase();
    catalog[key].forEach(l=>{
      // Filter by search
      if(q && !(l.name.toLowerCase().includes(q) || l.id.includes(q))) return;
      l.draws.forEach(d=>{
        // Skip day if not allowed today
        const today = new Date().getDay();
        if(!d.days.includes(today)) return;
        const card = document.createElement("div");
        card.className="tile";
        // result value
        const r = results[key]?.[l.id]?.[d.code]?.value || "‚Äî";
        const st = withinOpen(d,l.tz)==="open" ? "open" : "closed";
        const stCls = st==="open"?"status":"status closed";
        const drawClose = fmtDrawClose(d.time);
        card.innerHTML = `
          <div class="${stCls}">${st==="open"? i18n[lang].open : i18n[lang].closed}</div>
          <div class="state">${l.tz}</div>
          <div class="badge">
            <div class="emblem">${l.emblem}</div>
            <div>
              <div class="name">${l.name}</div>
              <div class="draw">${d.code}</div>
            </div>
          </div>
          <div class="nums">${r}</div>
          <div class="meta">
            <div>${i18n[lang].draw}: ${d.time}</div>
            <div>${i18n[lang].close}: ${minus20(d.time)}</div>
          </div>
        `;
        grid.appendChild(card);
      });
    });
    return sec;
  }

  function render(){
    const content = document.getElementById("content");
    content.innerHTML="";
    content.appendChild(renderSection("usa", i18n[lang].usa));
    content.appendChild(renderSection("rd", i18n[lang].rd));
    content.appendChild(renderSection("special", i18n[lang].special));
  }
  document.getElementById("search").addEventListener("input", render);
  applyLang();

  </script>
</body>
</html>
"""
with open("/mnt/data/beast_reader_v4.html","w",encoding="utf-8") as f:
    f.write(html)
print("Archivo creado: /mnt/data/beast_reader_v4.html")
