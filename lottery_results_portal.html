# We'll generate Beast Reader v8.3 single-file HTML with robust OCR->Results import, text & CSV ingest,
# enhanced mapping (Anguilla, Extra, FL Pick2 as USA modality, NY-BK/BP/FP, BK Paper, 3-5-7, etc.),
# alias persistence, and admin PIN enforcement on history edits.
#
# Save to /mnt/data/beast_reader_v8_3.html

html = r"""<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Beast Reader</title>

<!-- Tesseract for OCR (loaded only when used) -->
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
:root{
  --bg:#0d1b16;             /* dark green (mongo-ish) */
  --panel:#10241c;
  --tile:#152a22;
  --tile2:#1a3329;
  --accent:#00f5d4;
  --accent-2:#7bffca;
  --text:#e7fff5;
  --muted:#9fd5bf;
  --warn:#ffb703;
  --danger:#ff5a5f;
  --shadow: 0 10px 40px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.05);
}

*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,'Noto Sans',sans-serif}
a{color:var(--accent)}

header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;position:sticky;top:0;z-index:9;
  background:linear-gradient(180deg,rgba(13,27,22,.95),rgba(13,27,22,.65));
  backdrop-filter: blur(6px);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:54px;height:54px;border-radius:16px;display:grid;place-items:center;
  background:radial-gradient( 120px 80px at 30% 15%, #61ffca, #00b3a4 50%, #0a866e 80%);
  box-shadow:0 10px 30px rgba(0,245,212,.35), inset 0 0 10px rgba(255,255,255,.2);
  position:relative;
}
.logo:before{
  content:"üê≤";font-size:28px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
}
.title{font-weight:800;font-size:22px;letter-spacing:.2px}
.subtitle{font-size:12px;color:var(--muted)}

.controls{display:flex;align-items:center;gap:10px}
.btn-pill{
  background:linear-gradient(135deg,#4bf2c1,#1cc2a4);
  border:none;color:#03251f;padding:10px 16px;border-radius:999px;
  font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(0,255,214,.25);
}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--text);}
.btn-small{padding:8px 12px;font-size:13px}
.switch{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
.switch input{accent-color:var(--accent);width:20px;height:20px}

main{padding:10px 18px 80px}
.section{margin:14px auto;max-width:1400px;background:var(--panel);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
h2.section-title{margin:0 0 6px 2px}
.tabs{display:flex;gap:8px;margin:8px 2px 14px}
.tab{padding:10px 14px;border-radius:12px;background:var(--tile);cursor:pointer;border:1px solid rgba(255,255,255,.06)}
.tab.active{background:var(--tile2);box-shadow:0 8px 24px rgba(0,0,0,.3), inset 0 0 0 1px rgba(255,255,255,.08)}

table{width:100%;border-collapse:collapse;font-size:15px}
thead th{position:sticky;top:0;background:var(--panel);z-index:1}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
th{color:var(--muted);text-align:left}
td input[type="text"], td select{
  width:100%;background:#0f221b;border:1px solid rgba(255,255,255,.1);color:var(--text);
  border-radius:8px;padding:8px 10px;outline:none;
}
td .badge{padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12);color:var(--muted)}
.actions{display:flex;gap:8px;flex-wrap:wrap}

.kbd{font:600 12px/1.5 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
     background:#05130f;border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:6px;color:#9ed8c2}

hr.sep{border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:16px 0}
.note{color:var(--muted);font-size:13px}

.toast{position:fixed;right:16px;bottom:16px;background:#0b2019;border:1px solid rgba(255,255,255,.08);
  padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);display:none}
.toast.show{display:block;animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:.0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

.hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="title">Beast Reader</div>
      <div class="subtitle">Resultados en vivo ‚Äî USA, RD & Special</div>
    </div>
  </div>
  <div class="controls">
    <div class="switch"><label>Idioma</label><input type="checkbox" id="langToggle"></div>
    <div class="switch"><label>Tema</label><input type="checkbox" id="themeToggle"></div>
    <button id="autoScrollBtn" class="btn-pill btn-small">Auto Scroll</button>
    <button id="adminBtn" class="btn-ghost btn-small">Admin</button>
  </div>
</header>

<main>
  <section class="section" id="adminPanel">
    <h2 class="section-title">Beast Reader ‚Äî Admin</h2>
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="results">Resultados</div>
      <div class="tab" data-tab="ocr">OCR</div>
      <div class="tab" data-tab="catalog">Cat√°logo</div>
      <div class="tab" data-tab="logos">Logos</div>
      <div class="tab" data-tab="visibility">Visibilidad</div>
    </div>

    <div id="adminTools" class="actions" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="actions" style="gap:12px">
        <div class="switch">
          <label>Fecha para resultados</label>
          <input type="date" id="datePicker"/>
        </div>
      </div>
      <div class="actions">
        <input type="search" id="searchInput" placeholder="Buscar..." class="btn-ghost" style="padding:9px 12px;border-radius:10px"/>
        <button id="autoScrollBtn2" class="btn-pill btn-small">Auto Scroll</button>
        <button id="closeAdmin" class="btn-ghost btn-small">Cerrar</button>
      </div>
    </div>

    <!-- RESULTS TAB -->
    <div id="tab-results">
      <div class="actions" style="justify-content:flex-end;margin-bottom:8px">
        <button id="refreshFromOCR" class="btn-pill btn-small">Refresh from OCR</button>
        <button id="resetResults" class="btn-ghost btn-small">Reset results</button>
      </div>

      <div id="resultsTables"></div>
      <div class="note" style="margin-top:10px">Editar/guardar resultados manualmente.</div>
    </div>

    <!-- OCR TAB -->
    <div id="tab-ocr" class="hidden">
      <div class="actions" style="flex-wrap:wrap;gap:10px">
        <div class="actions" style="gap:8px">
          <input type="file" id="imageInput" accept="image/*" class="btn-ghost btn-small"/>
          <button id="runOcrBtn" class="btn-pill btn-small">OCR imagen</button>
        </div>
        <div class="actions" style="gap:8px">
          <input type="file" id="csvInput" accept=".csv,text/csv" class="btn-ghost btn-small"/>
          <button id="loadCsvBtn" class="btn-pill btn-small">Cargar CSV</button>
          <a id="csvSample" href="#" download="beast_reader_sample.csv" class="btn-ghost btn-small">Plantilla CSV</a>
        </div>
      </div>
      <textarea id="pasteArea" rows="6" placeholder="Pega aqu√≠ texto con resultados (WhatsApp/Poster/Lista)..."
        style="width:100%;margin:10px 0;background:#0f221b;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px"></textarea>
      <div class="actions" style="gap:8px">
        <button id="previewTextBtn" class="btn-pill btn-small">Previsualizar</button>
        <button id="clearPreviewBtn" class="btn-ghost btn-small">Limpiar</button>
      </div>

      <hr class="sep"/>
      <div id="ocrStats" class="note"></div>
      <div style="overflow:auto; max-height:55vh; border-radius:12px; border:1px solid rgba(255,255,255,.06)">
        <table id="ocrTable">
          <thead>
            <tr>
              <th style="min-width:220px">Abbrev.</th>
              <th>Map</th>
              <th>Detected</th>
              <th>Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note" style="margin-top:8px">
        * La previsualizaci√≥n se guarda como snapshot y se usar√° en <span class="kbd">Refresh from OCR</span>.
      </div>
    </div>

    <!-- CATALOG TAB -->
    <div id="tab-catalog" class="hidden">
      <div class="note" style="margin-bottom:8px">Editar cat√°logo (IDs can√≥nicos, horarios). Para agregar filas: usa el bot√≥n + al final.</div>
      <div id="catalogWrap" style="overflow:auto;max-height:60vh;border:1px solid rgba(255,255,255,.06);border-radius:12px">
        <table id="catalogTable">
          <thead>
            <tr>
              <th>Secci√≥n</th><th>Loter√≠a</th><th>Draw</th><th>Canon ID</th><th>Hora sorteo</th><th>Hora cierre</th><th>Visible</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="actions" style="margin-top:10px">
        <button id="addCatalogRow" class="btn-pill btn-small">+ Agregar</button>
        <button id="saveCatalog" class="btn-ghost btn-small">Guardar cat√°logo</button>
      </div>
    </div>

    <!-- LOGOS TAB -->
    <div id="tab-logos" class="hidden">
      <div class="note">Sube o pega URLs de logos. Se guardan por `canonId`.</div>
      <div id="logosWrap"></div>
    </div>

    <!-- VISIBILITY TAB -->
    <div id="tab-visibility" class="hidden">
      <div id="visibilityWrap"></div>
    </div>

  </section>
</main>

<div id="toast" class="toast"></div>

<script>
/* ========= Utilities ========= */
const $ = (s,root=document)=>root.querySelector(s);
const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500); };
const LS = {
  get:(k,def)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:(k)=>localStorage.removeItem(k)
};
const todayStr = ()=>{
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};

/* ========= Canonical catalog ========= */
/* Each entry: {section:'usa'|'rd'|'special', lottery:'New York', draw:'Midday', canonId:'usa/ny/Midday', drawTime:'14:30', closeTime:'14:10', visible:true} */

const defaultCatalog = [
  /* USA core */
  {section:'usa', lottery:'New York', draw:'Midday', canonId:'usa/ny/Midday', drawTime:'14:30', closeTime:'14:10', visible:true},
  {section:'usa', lottery:'New York', draw:'Evening', canonId:'usa/ny/Evening', drawTime:'22:30', closeTime:'22:10', visible:true},
  {section:'usa', lottery:'New Jersey', draw:'Midday', canonId:'usa/nj/Midday', drawTime:'12:59', closeTime:'12:39', visible:true},
  {section:'usa', lottery:'New Jersey', draw:'Evening', canonId:'usa/nj/Evening', drawTime:'22:57', closeTime:'22:37', visible:true},
  {section:'usa', lottery:'Connecticut', draw:'Day', canonId:'usa/ct/Day', drawTime:'13:57', closeTime:'13:37', visible:true},
  {section:'usa', lottery:'Connecticut', draw:'Night', canonId:'usa/ct/Night', drawTime:'22:29', closeTime:'22:09', visible:true},
  {section:'usa', lottery:'Florida', draw:'Midday', canonId:'usa/fl/Midday', drawTime:'13:30', closeTime:'13:10', visible:true},
  {section:'usa', lottery:'Florida', draw:'Evening', canonId:'usa/fl/Evening', drawTime:'21:45', closeTime:'21:25', visible:true},
  {section:'usa', lottery:'Georgia', draw:'Midday', canonId:'usa/ga/Midday', drawTime:'12:29', closeTime:'12:09', visible:true},
  {section:'usa', lottery:'Georgia', draw:'Evening', canonId:'usa/ga/Evening', drawTime:'18:59', closeTime:'18:39', visible:true},
  {section:'usa', lottery:'Georgia', draw:'Night', canonId:'usa/ga/Night', drawTime:'23:34', closeTime:'23:14', visible:true},
  {section:'usa', lottery:'Pennsylvania', draw:'Day', canonId:'usa/pa/Day', drawTime:'13:35', closeTime:'13:15', visible:true},
  {section:'usa', lottery:'Pennsylvania', draw:'Evening', canonId:'usa/pa/Evening', drawTime:'18:59', closeTime:'18:39', visible:true},
  {section:'usa', lottery:'Delaware', draw:'Day', canonId:'usa/de/Day', drawTime:'13:58', closeTime:'13:38', visible:true},
  {section:'usa', lottery:'Delaware', draw:'Night', canonId:'usa/de/Night', drawTime:'19:57', closeTime:'19:37', visible:true},
  {section:'usa', lottery:'Maryland', draw:'Midday', canonId:'usa/md/Midday', drawTime:'12:28', closeTime:'12:08', visible:true},
  {section:'usa', lottery:'Maryland', draw:'Evening', canonId:'usa/md/Evening', drawTime:'19:56', closeTime:'19:36', visible:true},
  {section:'usa', lottery:'Massachusetts', draw:'Midday', canonId:'usa/ma/Midday', drawTime:'14:00', closeTime:'13:40', visible:true},
  {section:'usa', lottery:'Massachusetts', draw:'Evening', canonId:'usa/ma/Evening', drawTime:'21:00', closeTime:'20:40', visible:true},
  {section:'usa', lottery:'Virginia', draw:'Day', canonId:'usa/va/Day', drawTime:'13:59', closeTime:'13:39', visible:true},
  {section:'usa', lottery:'Virginia', draw:'Night', canonId:'usa/va/Night', drawTime:'23:00', closeTime:'22:40', visible:true},
  {section:'usa', lottery:'Michigan', draw:'Midday', canonId:'usa/mi/Midday', drawTime:'12:59', closeTime:'12:39', visible:true},
  {section:'usa', lottery:'Michigan', draw:'Evening', canonId:'usa/mi/Evening', drawTime:'19:29', closeTime:'19:09', visible:true},
  {section:'usa', lottery:'North Carolina', draw:'Day', canonId:'usa/nc/Day', drawTime:'15:00', closeTime:'14:40', visible:true},
  {section:'usa', lottery:'North Carolina', draw:'Evening', canonId:'usa/nc/Evening', drawTime:'23:22', closeTime:'23:02', visible:true},
  {section:'usa', lottery:'South Carolina', draw:'Midday', canonId:'usa/sc/Midday', drawTime:'12:59', closeTime:'12:39', visible:true},
  {section:'usa', lottery:'South Carolina', draw:'Evening', canonId:'usa/sc/Evening', drawTime:'18:59', closeTime:'18:39', visible:true},
  {section:'usa', lottery:'Tennessee', draw:'Morning', canonId:'usa/tn/Morning', drawTime:'09:28', closeTime:'09:08', visible:true},
  {section:'usa', lottery:'Tennessee', draw:'Midday', canonId:'usa/tn/Midday', drawTime:'12:28', closeTime:'12:08', visible:true},
  {section:'usa', lottery:'Tennessee', draw:'Evening', canonId:'usa/tn/Evening', drawTime:'18:28', closeTime:'18:08', visible:true},
  {section:'usa', lottery:'Texas', draw:'Morning', canonId:'usa/tx/Morning', drawTime:'10:00', closeTime:'09:40', visible:true},
  {section:'usa', lottery:'Texas', draw:'Day', canonId:'usa/tx/Day', drawTime:'12:27', closeTime:'12:07', visible:true},
  {section:'usa', lottery:'Texas', draw:'Evening', canonId:'usa/tx/Evening', drawTime:'18:00', closeTime:'17:40', visible:true},
  {section:'usa', lottery:'Texas', draw:'Night', canonId:'usa/tx/Night', drawTime:'22:12', closeTime:'21:52', visible:true},

  /* USA modality: FL Pick2 (hidden by default as requested) */
  {section:'usa', lottery:'Florida Pick 2', draw:'AM', canonId:'usa/fl-pick2/AM', drawTime:'13:20', closeTime:'13:00', visible:false},
  {section:'usa', lottery:'Florida Pick 2', draw:'PM', canonId:'usa/fl-pick2/PM', drawTime:'21:20', closeTime:'21:00', visible:false},

  /* RD */
  {section:'rd', lottery:'Loter√≠a Real', draw:'Mediod√≠a', canonId:'rd/real/Mediodia', drawTime:'12:55', closeTime:'12:35', visible:true},
  {section:'rd', lottery:'Gana M√°s', draw:'Tarde', canonId:'rd/ganamas/Tarde', drawTime:'14:30', closeTime:'14:10', visible:true},
  {section:'rd', lottery:'Loteka', draw:'Noche', canonId:'rd/loteka/Noche', drawTime:'19:55', closeTime:'19:35', visible:true},
  {section:'rd', lottery:'Loter√≠a Nacional', draw:'Tarde', canonId:'rd/nacional/Tarde', drawTime:'14:30', closeTime:'14:10', visible:true},
  {section:'rd', lottery:'Loter√≠a Nacional', draw:'Noche', canonId:'rd/nacional/Noche', drawTime:'21:00', closeTime:'20:40', visible:true},
  {section:'rd', lottery:'Loter√≠a Nacional', draw:'Domingo', canonId:'rd/nacional/Domingo', drawTime:'18:00', closeTime:'17:40', visible:true},
  {section:'rd', lottery:'Quiniela Pal√© (Leidsa)', draw:'Diario', canonId:'rd/quiniela/Diario', drawTime:'20:55', closeTime:'20:35', visible:true},
  {section:'rd', lottery:'Quiniela Pal√© (Leidsa)', draw:'Domingo', canonId:'rd/quiniela/Domingo', drawTime:'15:55', closeTime:'15:35', visible:true},
  {section:'rd', lottery:'La Primera', draw:'AM', canonId:'rd/laprimera/AM', drawTime:'12:00', closeTime:'11:40', visible:true},
  {section:'rd', lottery:'La Primera', draw:'PM', canonId:'rd/laprimera/PM', drawTime:'20:00', closeTime:'19:40', visible:true},
  {section:'rd', lottery:'La Suerte Dominicana', draw:'AM', canonId:'rd/lasuerte/AM', drawTime:'12:30', closeTime:'12:10', visible:true},
  {section:'rd', lottery:'La Suerte Dominicana', draw:'PM', canonId:'rd/lasuerte/PM', drawTime:'18:00', closeTime:'17:40', visible:true},
  {section:'rd', lottery:'Lotedom', draw:'Tarde', canonId:'rd/lotedom/Tarde', drawTime:'13:55', closeTime:'13:35', visible:true},

  /* Special */
  {section:'special', lottery:'Anguilla', draw:'10AM', canonId:'special/anguilla/10AM', drawTime:'10:00', closeTime:'09:40', visible:true},
  {section:'special', lottery:'Anguilla', draw:'1PM', canonId:'special/anguilla/1PM', drawTime:'13:00', closeTime:'12:40', visible:true},
  {section:'special', lottery:'Anguilla', draw:'6PM', canonId:'special/anguilla/6PM', drawTime:'18:00', closeTime:'17:40', visible:true},
  {section:'special', lottery:'Anguilla', draw:'9PM', canonId:'special/anguilla/9PM', drawTime:'21:00', closeTime:'20:40', visible:true},
  {section:'special', lottery:'Extra', draw:'Midday', canonId:'special/extra/Midday', drawTime:'13:00', closeTime:'12:40', visible:true},
  {section:'special', lottery:'Extra', draw:'Night', canonId:'special/extra/Night', drawTime:'21:00', closeTime:'20:40', visible:true},
  {section:'special', lottery:'NY-BK', draw:'AM', canonId:'special/ny-bk/AM', drawTime:'12:00', closeTime:'11:40', visible:true},
  {section:'special', lottery:'NY-BK', draw:'PM', canonId:'special/ny-bk/PM', drawTime:'22:00', closeTime:'21:40', visible:true},
  {section:'special', lottery:'NY-BP', draw:'AM', canonId:'special/ny-bp/AM', drawTime:'12:00', closeTime:'11:40', visible:true},
  {section:'special', lottery:'NY-BP', draw:'PM', canonId:'special/ny-bp/PM', drawTime:'22:00', closeTime:'21:40', visible:true},
  {section:'special', lottery:'NY-FP', draw:'AM', canonId:'special/ny-fp/AM', drawTime:'12:00', closeTime:'11:40', visible:true},
  {section:'special', lottery:'NY-FP', draw:'PM', canonId:'special/ny-fp/PM', drawTime:'22:00', closeTime:'21:40', visible:true},
  {section:'special', lottery:'NY Horses', draw:'R1', canonId:'special/ny-horses/R1', drawTime:'14:00', closeTime:'13:40', visible:true},
  {section:'special', lottery:'NY Horses', draw:'R2', canonId:'special/ny-horses/R2', drawTime:'18:30', closeTime:'18:10', visible:true},
  {section:'special', lottery:'NY Horses', draw:'R3', canonId:'special/ny-horses/R3', drawTime:'21:30', closeTime:'21:10', visible:true},
  {section:'special', lottery:'3-5-7', draw:'Main', canonId:'special/357/Main', drawTime:'20:30', closeTime:'20:10', visible:true},
  {section:'special', lottery:'BK Paper', draw:'Main', canonId:'special/bk-paper/Main', drawTime:'20:00', closeTime:'19:40', visible:true},
  {section:'special', lottery:'King Lottery', draw:'AM', canonId:'special/king/AM', drawTime:'10:30', closeTime:'10:10', visible:true},
  {section:'special', lottery:'King Lottery', draw:'PM', canonId:'special/king/PM', drawTime:'19:30', closeTime:'19:10', visible:true},
];

function loadCatalog(){
  const saved = LS.get('br_catalog_v3');
  return saved && Array.isArray(saved) ? saved : defaultCatalog.slice();
}
function saveCatalog(c){ LS.set('br_catalog_v3', c); }

let catalog = loadCatalog();

/* ========= Admin session (PIN) ========= */
const ADMIN_PIN = "1983";
function isAdmin(){ return sessionStorage.getItem('br_admin_session') === '1'; }
function ensureAdmin(cb){
  if(isAdmin()) return cb();
  const pin = prompt("PIN de administrador:");
  if(pin===ADMIN_PIN){ sessionStorage.setItem('br_admin_session','1'); toast("Sesi√≥n admin activa"); cb(); }
  else if(pin!=null){ toast("PIN incorrecto"); }
}

/* ========= Results store (by date + canonId) ========= */
function resKey(date){ return `br_results_${date}`; }
function getResults(date){ return LS.get(resKey(date),{}); }
function saveResults(date,obj){ LS.set(resKey(date), obj); }

/* ========= Alias learned by user ========= */
const aliasKey = 'br_aliases_v1';
function getAliases(){ return LS.get(aliasKey,{}); }
function saveAlias(label, canonId){
  const a=getAliases(); a[normalizeLabel(label)] = canonId; LS.set(aliasKey,a);
}

/* ========= OCR snapshot ========= */
const ocrKey='br_ocr_preview_v1';

/* ========= Mapping rules ========= */
// Helpers
function normalizeLabel(s){
  if(!s) return '';
  return s
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\/\-\s\.]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function hasWord(s,w){ return new RegExp(`(^|\\b)${w}(\\b|$)`,'i').test(s); }

// Index catalog by canonId for quick lookup
function indexCatalogByCanon(){ const idx={}; catalog.forEach(c=>idx[c.canonId]=c); return idx; }
const catalogIndex = ()=>indexCatalogByCanon();

// Build resolver maps
const canonByName = (()=>{
  const map = {};
  catalog.forEach(c=>{
    const key = `${normalizeLabel(c.section)}/${normalizeLabel(c.lottery)}/${normalizeLabel(c.draw)}`;
    map[key]=c.canonId;
  });
  return map;
})();

// Core resolver from a free label (e.g. "NJ AM", "Georgia eve", "STATE", "BK-AM", "FL PICK2 PM")
function findTarget(label){
  if(!label) return null;
  const raw = label.trim();
  const lbl = normalizeLabel(raw);

  // 1) User learned alias first
  const learned = getAliases()[lbl];
  if(learned) return learned;

  // 2) Specific patterns first (Specials & RD & USA modality)
  // Anguilla
  if(/anguilla/.test(lbl)){
    if(/\b10\s*am\b/.test(lbl)) return 'special/anguilla/10AM';
    if(/\b1\s*pm\b/.test(lbl))  return 'special/anguilla/1PM';
    if(/\b6\s*pm\b/.test(lbl))  return 'special/anguilla/6PM';
    if(/\b9\s*pm\b/.test(lbl))  return 'special/anguilla/9PM';
  }
  // Extra
  if(/\bextra\b/.test(lbl)){
    if(/\bmid(day)?\b/.test(lbl)) return 'special/extra/Midday';
    if(/\bnight\b/.test(lbl)) return 'special/extra/Night';
  }
  // FL Pick2 (USA modality)
  if(/\bfl(\s|-)?pick\s*2\b|\bfl\s*pick2\b|\bflorida\s*pick\s*2\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'usa/fl-pick2/AM';
    if(/\bpm\b/.test(lbl)) return 'usa/fl-pick2/PM';
  }
  // NY papers (BK/BP/FP)
  if(/\bny[-\s]?bk\b|\bbk\s*paper\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'special/ny-bk/AM';
    if(/\bpm\b/.test(lbl)) return 'special/ny-bk/PM';
    return 'special/bk-paper/Main'; // generic BK Paper
  }
  if(/\bny[-\s]?bp\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'special/ny-bp/AM';
    if(/\bpm\b/.test(lbl)) return 'special/ny-bp/PM';
  }
  if(/\bny[-\s]?fp\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'special/ny-fp/AM';
    if(/\bpm\b/.test(lbl)) return 'special/ny-fp/PM';
  }
  // 3-5-7
  if(/\b3[\.\-\s]?5[\.\-\s]?7\b/.test(lbl)) return 'special/357/Main';
  // King Lottery
  if(/\bking\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'special/king/AM';
    if(/\bpm\b/.test(lbl)) return 'special/king/PM';
  }

  // RD
  if(/\b(loteria\s*real|real)\b/.test(lbl)) return 'rd/real/Mediodia';
  if(/\bgana\s*mas\b/.test(lbl)) return 'rd/ganamas/Tarde';
  if(/\bloteka\b/.test(lbl)) return 'rd/loteka/Noche';
  if(/\bnacional\b/.test(lbl)){
    if(/\bdomingo\b/.test(lbl)) return 'rd/nacional/Domingo';
    if(/\bnoche\b/.test(lbl)) return 'rd/nacional/Noche';
    return 'rd/nacional/Tarde';
  }
  if(/\b(quiniela\s*pale|quiniela\s*pal[e√©])\b/.test(lbl)){
    if(/\bdomingo\b/.test(lbl)) return 'rd/quiniela/Domingo';
    return 'rd/quiniela/Diario';
  }
  if(/\bla\s*primera\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'rd/laprimera/AM';
    if(/\bpm\b/.test(lbl)) return 'rd/laprimera/PM';
  }
  if(/\bla\s*suerte/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'rd/lasuerte/AM';
    if(/\bpm\b/.test(lbl)) return 'rd/lasuerte/PM';
  }
  if(/\blotedom\b|\blote\s*dom\b/i.test(raw)) return 'rd/lotedom/Tarde';

  // NY ‚ÄúSTATE‚Äù ‚Üí New York Evening (Numbers+Win4). ‚ÄúMidday‚Äù solo ‚Üí NY Midday
  if(/\bstate\b/.test(lbl)) return 'usa/ny/Evening';
  if(/\bmidday\b/.test(lbl) && !/\bconnecticut|ct|penn|pa|mass|ma|michigan|mi|maryland|md|delaware|de|virginia|va|georgia|ga|new\s*jersey|nj|north\s*carolina|south\s*carolina|tennessee|texas\b/.test(lbl)){
    return 'usa/ny/Midday';
  }
  // ‚ÄúN.Y.‚Äù solo n√∫mero ‚Üí NY Horses (ACEPTA 3 o 4 d√≠gitos)
  if(/(^|\b)n[.\s-]*y[.\s-]*($|\b)/.test(lbl) && !/\b(am|pm|midday|evening|night)\b/.test(lbl)){
    return 'special/ny-horses/R1'; // default R1; editable por alias
  }

  // USA states (broad)
  const stateMap = [
    {re:/\bnew\s*york\b|\bny\b/, base:'usa/ny'},
    {re:/\bnew\s*jersey\b|\bnj\b/, base:'usa/nj'},
    {re:/\bconnecticut\b|\bct\b/, base:'usa/ct', draws:{am:'Day', pm:'Night'}},
    {re:/\bflorida\b|\bfl\b/, base:'usa/fl'},
    {re:/\bpenn(sylv(ania)?)?\b|\bpa\b/, base:'usa/pa', draws:{am:'Day', pm:'Evening'}},
    {re:/\bdelaware\b|\bde\b/, base:'usa/de', draws:{am:'Day', pm:'Night'}},
    {re:/\bgeorgia\b|\bga\b/, base:'usa/ga', custom:true},
    {re:/\bmaryland\b|\bmd\b/, base:'usa/md'},
    {re:/\bmassa(chusetts)?\b|\bma\b/, base:'usa/ma'},
    {re:/\bmichigan\b|\bmi\b/, base:'usa/mi'},
    {re:/\bvirginia\b|\bva\b/, base:'usa/va', draws:{am:'Day', pm:'Night'}},
    {re:/\bnorth\s*carolina\b|\bnc\b/, base:'usa/nc', draws:{am:'Day', pm:'Evening'}}, // NC Evening in table
    {re:/\bsouth\s*carolina\b|\bsc\b/, base:'usa/sc'},
    {re:/\btennessee\b|\btn\b/, base:'usa/tn'},
    {re:/\btexas\b|\btx\b/, base:'usa/tx'}
  ];

  for(const st of stateMap){
    if(st.re.test(lbl)){
      // detect draw token
      const isAM = /\bam\b|\bday\b|\bmid(day)?\b/.test(lbl);
      const isPM = /\bpm\b|\beve(ning)?\b|\bnight\b|\bnoche\b/.test(lbl);
      const base = st.base;
      let draw=null;

      if(base==='usa/ga'){
        if(/\bnight\b/.test(lbl)) draw='Night';
        else if(/\beve(ning)?\b/.test(lbl)) draw='Evening';
        else draw='Midday';
      }else if(base==='usa/tx'){
        if(/\bmorning\b/.test(lbl)) draw='Morning';
        else if(/\bday\b/.test(lbl)) draw='Day';
        else if(/\bevening\b/.test(lbl)) draw='Evening';
        else if(/\bnight\b/.test(lbl)) draw='Night';
        else draw= isAM?'Day':'Evening';
      }else if(base==='usa/tn'){
        if(/\bmorning\b/.test(lbl)) draw='Morning';
        else if(/\bmid(day)?\b/.test(lbl)) draw='Midday';
        else draw='Evening';
      }else{
        if(st.draws){
          draw = isAM ? st.draws.am : (isPM ? st.draws.pm : null);
        }else{
          draw = isAM ? 'Midday' : (isPM?'Evening':null);
        }
      }
      if(!draw){
        // defaults if not clear
        if(/night/.test(lbl)) draw='Night';
        else if(/eve(ning)?/.test(lbl)) draw='Evening';
        else if(/mid(day)?|am|day/.test(lbl)) draw= (base==='usa/ct' || base==='usa/pa' || base==='usa/de' || base==='usa/va') ? 'Day' : 'Midday';
        else draw = 'Evening';
      }
      const key = `${base}/${draw}`;
      // Find canon by key
      const found = catalog.find(c=>c.canonId===key);
      return found ? found.canonId : null;
    }
  }

  // Special residuals
  if(/\bbk\s*paper\b/.test(lbl)) return 'special/bk-paper/Main';
  return null;
}

/* ========= Value normalizer ========= */
function normalizeValue(val){
  if(val==null) return '';
  let s = String(val).trim();
  // keep special tokens like xx, xxx, x
  // collapse spaces around dashes
  s = s.replace(/\s*-\s*/g,'-').replace(/\s+/g,' ').trim();
  return s;
}

/* ========= OCR Table rendering ========= */
function renderOcrTable(rows){
  const tbody = $("#ocrTable tbody");
  tbody.innerHTML = "";
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    const canon = r.canonId || findTarget(r.label);
    const val = normalizeValue(r.value || r.detected || "");

    const sel = document.createElement('select');
    // Build options from catalog
    const optDefault = document.createElement('option'); optDefault.value=""; optDefault.textContent="‚Äî seleccionar ‚Äî";
    sel.appendChild(optDefault);
    catalog.forEach(c=>{
      const op = document.createElement('option');
      op.value=c.canonId; op.textContent=`${c.section.toUpperCase()} / ${c.lottery} / ${c.draw}`;
      if(canon===c.canonId) op.selected=true;
      sel.appendChild(op);
    });
    sel.addEventListener('change',()=>{
      rows[idx].canonId = sel.value || null;
      if(sel.value) saveAlias(r.label, sel.value);
      LS.set(ocrKey, rows);
    });

    tr.innerHTML = `
      <td><span class="badge">${r.label}</span></td>
      <td></td>
      <td>${r.detected||''}</td>
      <td><input type="text" value="${val}" /></td>
      <td><button class="btn-ghost btn-small">Save</button></td>
    `;
    tr.children[1].appendChild(sel);
    // Save button to persist per-row change into snapshot
    tr.querySelector('button').addEventListener('click',()=>{
      rows[idx].value = tr.querySelector('input').value;
      rows[idx].canonId = sel.value || rows[idx].canonId || findTarget(r.label);
      LS.set(ocrKey, rows);
      toast("Fila actualizada en la previsualizaci√≥n");
    });

    tbody.appendChild(tr);
  });
  // stats
  const mapped = rows.filter(r=> (r.canonId || findTarget(r.label)) ).length;
  $("#ocrStats").innerHTML = `Filas: <b>${rows.length}</b> ‚Äî Mapeadas: <b>${mapped}</b> ‚Äî Pendientes: <b>${rows.length-mapped}</b>`;
}

/* ========= Parsers ========= */
// 1) Text (WhatsApp/Poster list) ‚Äî one item per line
function parseTextToRows(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows=[];
  for(const ln of lines){
    // Format examples: "Georgia am ‚Äî 256 - 2061" | "Midday ‚Äî 992 - 0845" | "N.Y. - 444"
    // Split label from numbers by dash em or hyphen runs
    const parts = ln.split(/‚Äî|--|:-|\s{2,}/).map(s=>s.trim()).filter(Boolean);
    let label, nums;
    if(parts.length>=2){ label = parts[0]; nums = parts.slice(1).join(' '); }
    else{
      // try label tokens up to first numbers
      const m = ln.match(/^(.*?)[\s\-:]*([0-9xX].*)$/);
      if(m){ label=m[1].trim(); nums=m[2].trim(); } else { label=ln; nums=''; }
    }
    rows.push({label, detected:nums, value:nums, canonId:findTarget(label)});
  }
  return rows;
}

// 2) Whiteboard style ‚Äî we can't always segment columns reliably from image; when pasting as text, treat like general list.
// 3) CSV
function parseCsvToRows(csvText){
  const lines = csvText.split(/\r?\n/).filter(l=>l.trim().length);
  // Simple CSV: detect header
  const header = lines[0].split(',').map(h=>normalizeLabel(h));
  let start=0;
  const hasHeader = header.some(h=>['lottery','draw','label','abbrev','value','first','second','third','pick_3','pick3','pick_4','pick4'].includes(h));
  if(hasHeader) start=1;
  const rows=[];
  for(let i=start;i<lines.length;i++){
    const cells = lines[i].split(',').map(c=>c.trim());
    let label='', value='';
    if(hasHeader){
      const map={};
      header.forEach((h,idx)=>map[h]=cells[idx]||'');
      if(map.label) label=map.label;
      else if(map.abbrev) label=map.abbrev;
      else{
        // synthesize label from lottery/draw
        label = [map.lottery,map.draw].filter(Boolean).join(' ');
      }
      // prefer value column, else build from first/second/third or pick3/pick4
      value = map.value || [map.first,map.second,map.third].filter(Boolean).join('-') || [map.pick3,map.pick_3,map.pick4,map.pick_4].filter(Boolean).join('-');
    }else{
      // assume two columns: label,value
      label = cells[0] || '';
      value = cells.slice(1).join(',').trim();
    }
    rows.push({label, detected:value, value:normalizeValue(value), canonId:findTarget(label)});
  }
  return rows;
}

/* ========= Refresh from OCR (import) ========= */
function refreshFromOcr(){
  const date = $("#datePicker").value || todayStr();
  const snapshot = LS.get(ocrKey, []);
  if(!snapshot.length){ toast("No hay snapshot OCR para importar."); return; }
  const res = getResults(date);
  const idx = catalogIndex();
  let imported=0, omitted=[];

  snapshot.forEach(r=>{
    const canon = r.canonId || findTarget(r.label);
    if(!canon || !idx[canon]){ omitted.push(r.label); return; }
    const val = normalizeValue(r.value || r.detected || '');
    if(!val){ omitted.push(r.label); return; } // no empty overwrite
    res[canon] = val;
    imported++;
  });
  saveResults(date,res);
  renderResultsTables();
  toast(`Importadas ${imported}. Omitidas ${omitted.length}.`);
  if(omitted.length){ console.warn("Omitidas (sin map o sin valor):", omitted); }
}

/* ========= Results tables ========= */
function renderResultsTables(){
  const wrap = $("#resultsTables");
  wrap.innerHTML='';
  const date = $("#datePicker").value || todayStr();
  const res = getResults(date);

  const sections = ['usa','rd','special'];
  sections.forEach(sec=>{
    const group = catalog.filter(c=>c.section===sec);
    if(!group.length) return;
    const title = document.createElement('h3');
    title.textContent = (sec==='usa'?'USA Lotteries': (sec==='rd'?'Santo Domingo Lotteries':'Special Lotteries'));
    title.style.margin = "12px 6px";
    wrap.appendChild(title);

    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr>
        <th style="min-width:180px">Loter√≠a</th>
        <th style="min-width:120px">Draw</th>
        <th>Hora sorteo</th>
        <th>Hora cierre</th>
        <th style="min-width:260px">Resultado</th>
        <th>Actions</th>
      </tr></thead>
      <tbody></tbody>
    `;
    const tbody=table.querySelector('tbody');

    group.forEach(item=>{
      const tr=document.createElement('tr');
      const value = res[item.canonId] || '';
      tr.innerHTML = `
        <td>${item.lottery}</td>
        <td>${item.draw}</td>
        <td>${item.drawTime}</td>
        <td>${item.closeTime}</td>
        <td><input type="text" value="${value}" placeholder=""/></td>
        <td class="actions">
          <button class="btn-pill btn-small">Save</button>
        </td>
      `;
      tr.querySelector('button').addEventListener('click',()=>{
        const v = normalizeValue(tr.querySelector('input').value);
        const r = getResults(date);
        r[item.canonId]=v;
        saveResults(date,r);
        toast("Guardado");
      });
      tbody.appendChild(tr);
    });

    wrap.appendChild(table);
    wrap.appendChild(document.createElement('hr')).className='sep';
  });
}

/* ========= Catalog rendering ========= */
function renderCatalog(){
  const tbody = $("#catalogTable tbody");
  tbody.innerHTML='';
  catalog.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${c.section}</td>
      <td>${c.lottery}</td>
      <td>${c.draw}</td>
      <td><span class="badge">${c.canonId}</span></td>
      <td><input type="text" value="${c.drawTime}"/></td>
      <td><input type="text" value="${c.closeTime}"/></td>
      <td><input type="checkbox" ${c.visible?'checked':''}/></td>
      <td><button class="btn-ghost btn-small">Del</button></td>
    `;
    const [,, , canonSpan, drawTimeInput, closeTimeInput, visChk, delBtn] = tr.children;
    delBtn.querySelector('button').addEventListener('click',()=>{
      ensureAdmin(()=>{ catalog.splice(i,1); saveCatalog(catalog); renderCatalog(); });
    });
    drawTimeInput.querySelector('input')?.addEventListener('change',e=>{
      catalog[i].drawTime = e.target.value; saveCatalog(catalog);
    });
    closeTimeInput.querySelector('input')?.addEventListener('change',e=>{
      catalog[i].closeTime = e.target.value; saveCatalog(catalog);
    });
    visChk.querySelector('input')?.addEventListener('change',e=>{
      catalog[i].visible = e.target.checked; saveCatalog(catalog);
    });
    tbody.appendChild(tr);
  });
}

$("#addCatalogRow").addEventListener('click',()=>{
  ensureAdmin(()=>{
    const section = prompt("Secci√≥n (usa/rd/special):","special")||"special";
    const lottery = prompt("Loter√≠a:","Custom")||"Custom";
    const draw = prompt("Draw:","Main")||"Main";
    const canonId = `${section}/${normalizeLabel(lottery).replace(/\s+/g,'-')}/${draw}`;
    catalog.push({section,lottery,draw,canonId,drawTime:'12:00',closeTime:'11:40',visible:true});
    saveCatalog(catalog); renderCatalog();
  });
});
$("#saveCatalog").addEventListener('click',()=>{ ensureAdmin(()=>{ saveCatalog(catalog); toast("Cat√°logo guardado"); }); });

/* ========= Logos & Visibility placeholders ========= */
function renderLogos(){
  const wrap=$("#logosWrap"); wrap.innerHTML='';
  wrap.innerHTML = `<div class="note">Pr√≥xima iteraci√≥n: gestor de logos. Mientras tanto, los logos SVG autom√°ticos se generan por iniciales.</div>`;
}
function renderVisibility(){
  const wrap=$("#visibilityWrap"); wrap.innerHTML='';
  const sec = ['usa','rd','special'];
  sec.forEach(s=>{
    const h = document.createElement('h3'); h.textContent = s==='usa'?'USA':(s==='rd'?'RD':'Special'); wrap.appendChild(h);
    const list = document.createElement('div'); list.style.display='grid'; list.style.gridTemplateColumns='repeat(auto-fill,minmax(240px,1fr))'; list.style.gap='8px';
    catalog.filter(c=>c.section===s).forEach(c=>{
      const row=document.createElement('div'); row.style.background='var(--tile)'; row.style.padding='8px 10px'; row.style.borderRadius='10px';
      row.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><b>${c.lottery}</b> <span class="badge">${c.draw}</span></div>
          <label class="switch" style="gap:6px"><span>Visible</span><input type="checkbox" ${c.visible?'checked':''}></label>
        </div>`;
      row.querySelector('input').addEventListener('change',(e)=>{ c.visible=e.target.checked; saveCatalog(catalog); });
      list.appendChild(row);
    });
    wrap.appendChild(list);
    wrap.appendChild(document.createElement('hr')).className='sep';
  });
}

/* ========= Tabs & interactions ========= */
function showTab(name){
  $$(".tab").forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $("#tab-results").classList.toggle('hidden', name!=='results');
  $("#tab-ocr").classList.toggle('hidden', name!=='ocr');
  $("#tab-catalog").classList.toggle('hidden', name!=='catalog');
  $("#tab-logos").classList.toggle('hidden', name!=='logos');
  $("#tab-visibility").classList.toggle('hidden', name!=='visibility');
  if(name==='results'){ renderResultsTables(); }
  if(name==='catalog'){ renderCatalog(); }
  if(name==='logos'){ renderLogos(); }
  if(name==='visibility'){ renderVisibility(); }
}
$$(".tab").forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

/* ========= Admin open/close ========= */
const adminPanel = $("#adminPanel");
$("#adminBtn").addEventListener('click',()=>{ ensureAdmin(()=>{ adminPanel.scrollIntoView({behavior:'smooth'}); }); });
$("#closeAdmin").addEventListener('click',()=> adminPanel.classList.add('hidden'));
document.addEventListener('DOMContentLoaded',()=>{ adminPanel.classList.remove('hidden'); });

/* ========= Date picker default ========= */
$("#datePicker").value = todayStr();

/* ========= OCR actions ========= */
// CSV sample
$("#csvSample").addEventListener('click',(e)=>{
  const sample = "label,value\nCONNECT AM,418-2063\nGEORGIA EVENING,584-1884\nANGUILLA 10AM,23-39-07\nFL PICK2 PM,93-x-x\nBK paper,160\n3-5-7,32--------\n";
  const blob=new Blob([sample],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  e.target.href=url;
});

$("#previewTextBtn").addEventListener('click',()=>{
  const txt = $("#pasteArea").value.trim();
  if(!txt){ toast("Pega texto para previsualizar"); return; }
  const rows = parseTextToRows(txt);
  LS.set(ocrKey, rows);
  renderOcrTable(rows);
  toast("Previsualizaci√≥n creada desde texto");
});
$("#clearPreviewBtn").addEventListener('click',()=>{ LS.del(ocrKey); renderOcrTable([]); $("#pasteArea").value=''; });

$("#csvInput").addEventListener('change',()=>{});
$("#loadCsvBtn").addEventListener('click',()=>{
  const f = $("#csvInput").files?.[0];
  if(!f){ toast("Selecciona un CSV"); return; }
  const reader = new FileReader();
  reader.onload = () => {
    const rows = parseCsvToRows(reader.result);
    LS.set(ocrKey, rows);
    renderOcrTable(rows);
    toast("CSV previsualizado");
  };
  reader.readAsText(f);
});

// OCR from image
$("#runOcrBtn").addEventListener('click',async()=>{
  const file = $("#imageInput").files?.[0];
  if(!file){ toast("Selecciona una imagen"); return; }
  toast("Procesando OCR...");
  const { createWorker } = Tesseract;
  const worker = await createWorker('eng');
  const { data:{ text } } = await worker.recognize(file);
  await worker.terminate();
  const rows = parseTextToRows(text);
  LS.set(ocrKey, rows);
  renderOcrTable(rows);
  toast("OCR completado");
});

// Load snapshot on start
document.addEventListener('DOMContentLoaded',()=>{
  const snap = LS.get(ocrKey,[]);
  if(snap && snap.length) renderOcrTable(snap);
  renderResultsTables();
});

/* ========= Buttons ========= */
$("#resetResults").addEventListener('click',()=>{
  ensureAdmin(()=>{
    const date = $("#datePicker").value || todayStr();
    LS.del(resKey(date));
    renderResultsTables();
    toast("Resultados reseteados para la fecha");
  });
});
$("#refreshFromOCR").addEventListener('click',()=>{
  ensureAdmin(()=> refreshFromOcr());
});

/* ========= Search in results (client-side filter) ========= */
$("#searchInput").addEventListener('input',(e)=>{
  const q = normalizeLabel(e.target.value);
  $$("#resultsTables table tbody tr").forEach(tr=>{
    const text = normalizeLabel(tr.textContent);
    tr.style.display = text.includes(q) ? '' : 'none';
  });
});

/* ========= Theme & Language toggles (basic placeholders) ========= */
$("#themeToggle").addEventListener('change', (e)=>{
  document.documentElement.style.setProperty('--bg', e.target.checked ? '#f4eadc' : '#0d1b16');
  document.documentElement.style.setProperty('--panel', e.target.checked ? '#e0d3c2' : '#10241c');
  document.documentElement.style.setProperty('--tile', e.target.checked ? '#e8dbca' : '#152a22');
  document.documentElement.style.setProperty('--tile2', e.target.checked ? '#efe1ce' : '#1a3329');
  document.documentElement.style.setProperty('--text', e.target.checked ? '#222' : '#e7fff5');
  document.documentElement.style.setProperty('--muted', e.target.checked ? '#4d4d4d' : '#9fd5bf');
});
$("#langToggle").addEventListener('change',(e)=>{
  toast(e.target.checked ? "EN not ready (placeholder)" : "ES");
});

/* ========= Auto scroll ========= */
let autoScroll=false, scrollTimer=null;
function tickScroll(){
  if(!autoScroll) return;
  window.scrollBy({top:1,behavior:'smooth'});
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 10);
  if(nearBottom){
    setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}),800);
  }
}
$("#autoScrollBtn").addEventListener('click',()=>{
  autoScroll = !autoScroll;
  if(autoScroll){ scrollTimer=setInterval(tickScroll, 120); toast("Auto Scroll ON"); }
  else { clearInterval(scrollTimer); toast("Auto Scroll OFF"); }
});
$("#autoScrollBtn2").addEventListener('click',()=>$("#autoScrollBtn").click());

</script>
</body>
</html>
"""
open("/mnt/data/beast_reader_v8_3.html","w",encoding="utf-8").write(html)
print("Archivo creado: /mnt/data/beast_reader_v8_3.html")
