html = r"""<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Beast Reader</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
:root{
  /* Dark (Mongo-ish) */
  --bg:#0d1b16;
  --panel:#10241c;
  --tile:#152a22;
  --tile2:#1a3329;
  --accent:#00f5d4;
  --accent-2:#7bffca;
  --text:#e7fff5;
  --muted:#9fd5bf;
  --warn:#ffb703;
  --danger:#ff5a5f;
  --shadow: 0 10px 40px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.05);
}
/* Light (Beige/Cream) palette applied by JS toggle */
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
a{color:var(--accent);text-decoration:none}

header{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:14px 18px;background:linear-gradient(180deg,rgba(13,27,22,.95),rgba(13,27,22,.6));
  border-bottom:1px solid rgba(255,255,255,.06);
  backdrop-filter: blur(6px);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:56px;height:56px;border-radius:18px;display:grid;place-items:center;
  background:radial-gradient( 140px 90px at 30% 15%, #61ffca, #00b3a4 50%, #0a866e 80%);
  box-shadow:0 10px 30px rgba(0,245,212,.35), inset 0 0 10px rgba(255,255,255,.2);
}
.logo::before{content:"üê≤";font-size:28px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.4))}
.title{font-weight:800;font-size:22px}
.subtitle{font-size:12px;color:var(--muted)}

.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{border:none;border-radius:999px;padding:9px 14px;font-weight:700;cursor:pointer}
.btn-pill{background:linear-gradient(135deg,#4bf2c1,#1cc2a4);color:#03251f;box-shadow:0 8px 24px rgba(0,255,214,.25)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.12);color:var(--text)}
.btn-sm{padding:8px 12px;font-size:13px}
.switch{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
.switch input{accent-color:var(--accent)}

main{padding:14px 16px 80px;max-width:1500px;margin:0 auto}
.section{margin:10px 0;background:var(--panel);border-radius:18px;padding:14px;box-shadow:var(--shadow)}

/* PUBLIC BOARD (tiles) */
.board-title{margin:0 0 10px 6px}
.grid{
  display:grid;gap:10px;
  grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
}
.tile{
  position:relative;background:var(--tile);border-radius:16px;padding:10px 10px 12px;box-shadow:var(--shadow);
  display:flex;flex-direction:column;gap:6px;min-height:150px;
}
.tile-head{display:flex;gap:8px;align-items:center}
.badgelogo{
  width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
  background:radial-gradient( 80px 50px at 30% 15%, #7bffca, #05b3a0 60%, #0a866e 90%);
  font-weight:900;color:#04221a;box-shadow: inset 0 0 10px rgba(255,255,255,.15);
}
.tile-name{font-size:14px;font-weight:700;line-height:1.2}
.tile-draw{font-size:12px;color:var(--muted)}
.tile-date{font-size:11px;color:var(--muted)}
.tile-result{
  margin-top:4px;flex:1;display:grid;place-items:center;
  font-size:28px;font-weight:900;letter-spacing:1px;text-align:center;
}
.tile-foot{
  display:flex;align-items:center;justify-content:space-between;
  font-size:12px;color:var(--muted);
}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.open{color:#93ffdd}.open .dot{background:#27e8b2}
.closed{color:#ffc37a}.closed .dot{background:#ffb703}

.hist-btn{font-size:12px;border-radius:8px;padding:4px 8px}

/* ADMIN PANEL */
#adminPanel{display:none}
.tabs{display:flex;gap:8px;margin:8px 2px 14px}
.tab{padding:9px 12px;border-radius:12px;background:var(--tile);cursor:pointer;border:1px solid rgba(255,255,255,.06);user-select:none}
.tab.active{background:var(--tile2);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}

table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle}
thead th{position:sticky;top:0;background:var(--panel);z-index:1;color:var(--muted);text-align:left}
td input[type="text"], td select, textarea.input{
  width:100%;background:#0f221b;border:1px solid rgba(255,255,255,.1);color:var(--text);
  border-radius:8px;padding:8px 10px;outline:none;
}

.actions{display:flex;gap:8px;flex-wrap:wrap}
hr.sep{border:none;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:14px 0}
.note{color:var(--muted);font-size:13px}
.hidden{display:none !important}

.toast{position:fixed;right:16px;bottom:16px;background:#0b2019;border:1px solid rgba(255,255,255,.08);
  padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);display:none}
.toast.show{display:block;animation:fadeIn .2s ease-out}
@keyframes fadeIn{from{opacity:.0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

.modal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.5);z-index:20;
}
.modal .card{
  background:var(--panel);border-radius:14px;min-width:320px;max-width:92vw;max-height:80vh;overflow:auto;
  padding:14px;box-shadow:var(--shadow)
}
.modal.show{display:flex}

</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="title" data-i18n="app_title">Beast Reader</div>
      <div class="subtitle" data-i18n="app_subtitle">Resultados en vivo ‚Äî USA, RD & Special</div>
    </div>
  </div>
  <div class="controls">
    <div class="switch"><label data-i18n="lang">Idioma</label><input type="checkbox" id="langToggle"></div>
    <div class="switch"><label data-i18n="theme">Tema</label><input type="checkbox" id="themeToggle"></div>
    <button id="autoScrollBtn" class="btn btn-pill btn-sm" data-i18n="auto_scroll">Auto Scroll</button>
    <button id="adminBtn" class="btn btn-ghost btn-sm" data-i18n="admin">Admin</button>
  </div>
</header>

<main>
  <!-- PUBLIC BOARD -->
  <section class="section" id="publicBoard">
    <h2 class="board-title" data-i18n="board_title">Resultados</h2>

    <h3 style="margin:6px" data-i18n="usa">USA Lotteries</h3>
    <div class="grid" id="grid-usa"></div>

    <h3 style="margin:6px" data-i18n="rd">Santo Domingo Lotteries</h3>
    <div class="grid" id="grid-rd"></div>

    <h3 style="margin:6px" data-i18n="special">Special Lotteries</h3>
    <div class="grid" id="grid-special"></div>
  </section>

  <!-- ADMIN -->
  <section class="section" id="adminPanel">
    <h2 class="board-title">Admin</h2>
    <div class="tabs" role="tablist">
      <div class="tab active" data-tab="results" data-i18n="tab_results">Resultados</div>
      <div class="tab" data-tab="ocr" data-i18n="tab_ocr">OCR</div>
      <div class="tab" data-tab="catalog" data-i18n="tab_catalog">Cat√°logo</div>
      <div class="tab" data-tab="visibility" data-i18n="tab_visibility">Visibilidad</div>
    </div>

    <div class="actions" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="actions">
        <label class="switch"><span data-i18n="date_for_results">Fecha</span>
          <input type="date" id="datePicker"/></label>
      </div>
      <div class="actions">
        <button id="closeAdmin" class="btn btn-ghost btn-sm" data-i18n="close">Cerrar</button>
      </div>
    </div>

    <!-- Results tab -->
    <div id="tab-results">
      <div class="actions" style="justify-content:flex-end;margin-bottom:8px">
        <button id="refreshFromOCR" class="btn btn-pill btn-sm">Refresh from OCR</button>
        <button id="resetResults" class="btn btn-ghost btn-sm" data-i18n="reset_results">Reset results</button>
      </div>
      <div id="resultsTables"></div>
    </div>

    <!-- OCR tab -->
    <div id="tab-ocr" class="hidden">
      <div class="actions" style="gap:8px;flex-wrap:wrap">
        <div class="actions">
          <input type="file" id="imageInput" accept="image/*" class="btn btn-ghost btn-sm">
          <button id="runOcrBtn" class="btn btn-pill btn-sm" data-i18n="ocr_image">OCR imagen</button>
        </div>
        <div class="actions">
          <input type="file" id="csvInput" accept=".csv,text/csv" class="btn btn-ghost btn-sm">
          <button id="loadCsvBtn" class="btn btn-pill btn-sm" data-i18n="load_csv">Cargar CSV</button>
          <button id="saveTextPreviewBtn" class="btn btn-ghost btn-sm">Guardar preview (texto)</button>
        </div>
      </div>
      <textarea id="pasteArea" rows="5" class="input" placeholder="Pega texto con resultados (WhatsApp/Poster)..."></textarea>
      <div class="actions" style="gap:8px">
        <button id="previewTextBtn" class="btn btn-pill btn-sm" data-i18n="preview">Previsualizar</button>
        <button id="clearPreviewBtn" class="btn btn-ghost btn-sm" data-i18n="clear">Limpiar</button>
      </div>
      <hr class="sep"/>
      <div id="ocrStats" class="note"></div>
      <div style="overflow:auto;max-height:50vh;border-radius:12px;border:1px solid rgba(255,255,255,.06)">
        <table id="ocrTable">
          <thead><tr>
            <th>Abbrev.</th><th>Map</th><th>Detected</th><th>Value</th><th>Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="note" style="margin-top:6px">La previsualizaci√≥n se guarda en cach√© y se usa en ‚ÄúRefresh from OCR‚Äù.</div>
    </div>

    <!-- Catalog tab -->
    <div id="tab-catalog" class="hidden">
      <div class="note">Editar horas, visibilidad o agregar nuevas entradas.</div>
      <div style="overflow:auto;max-height:55vh;border:1px solid rgba(255,255,255,.06);border-radius:12px">
        <table id="catalogTable">
          <thead><tr>
            <th>Secci√≥n</th><th>Loter√≠a</th><th>Draw</th><th>Canon ID</th><th>Hora sorteo</th><th>Hora cierre</th><th>Visible</th><th></th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="actions" style="margin-top:8px">
        <button id="addCatalogRow" class="btn btn-pill btn-sm">+ Agregar</button>
        <button id="saveCatalog" class="btn btn-ghost btn-sm">Guardar cat√°logo</button>
      </div>
    </div>

    <!-- Visibility tab -->
    <div id="tab-visibility" class="hidden">
      <div id="visibilityWrap"></div>
    </div>

  </section>
</main>

<!-- History modal -->
<div id="historyModal" class="modal" aria-hidden="true">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <b id="histTitle">Historial</b>
      <div class="actions">
        <button id="histClose" class="btn btn-ghost btn-sm" data-i18n="close">Cerrar</button>
      </div>
    </div>
    <div id="histContent"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== Utilities ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)};
const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:(k)=>localStorage.removeItem(k)};
const todayStr=()=>{const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`};
const ADMIN_PIN='1983';
const isAdmin=()=>sessionStorage.getItem('br_is_admin')==='1';
function ensureAdmin(cb){ if(isAdmin()) return cb(); const pin=prompt('PIN de administrador:'); if(pin===ADMIN_PIN){sessionStorage.setItem('br_is_admin','1'); toast('Sesi√≥n admin activa'); cb();} else if(pin!=null){toast('PIN incorrecto');} }

/* ===== Theme & Language ===== */
const i18n = {
  es: {
    app_title: "Beast Reader",
    app_subtitle: "Resultados en vivo ‚Äî USA, RD & Special",
    lang: "Idioma", theme: "Tema", auto_scroll: "Auto Scroll", admin: "Admin",
    board_title: "Resultados",
    usa:"USA Lotteries", rd:"Santo Domingo Lotteries", special:"Special Lotteries",
    tab_results:"Resultados", tab_ocr:"OCR", tab_catalog:"Cat√°logo", tab_visibility:"Visibilidad",
    date_for_results:"Fecha", close:"Cerrar", reset_results:"Reset results",
    ocr_image:"OCR imagen", load_csv:"Cargar CSV", preview:"Previsualizar", clear:"Limpiar"
  },
  en: {
    app_title: "Beast Reader",
    app_subtitle: "Live results ‚Äî USA, DR & Special",
    lang: "Language", theme: "Theme", auto_scroll: "Auto Scroll", admin: "Admin",
    board_title: "Results",
    usa:"USA Lotteries", rd:"Santo Domingo Lotteries", special:"Special Lotteries",
    tab_results:"Results", tab_ocr:"OCR", tab_catalog:"Catalog", tab_visibility:"Visibility",
    date_for_results:"Date", close:"Close", reset_results:"Reset results",
    ocr_image:"OCR image", load_csv:"Upload CSV", preview:"Preview", clear:"Clear"
  }
};
let currentLang='es';
function applyI18n(){
  const dict=i18n[currentLang];
  $$('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(dict[k]) el.textContent=dict[k]; });
}

/* ===== Catalog ===== */
const defaultCatalog=[
  // USA
  {section:'usa',lottery:'New York',draw:'Midday',canonId:'usa/ny/Midday',drawTime:'14:30',closeTime:'14:10',visible:true},
  {section:'usa',lottery:'New York',draw:'Evening',canonId:'usa/ny/Evening',drawTime:'22:30',closeTime:'22:10',visible:true},
  {section:'usa',lottery:'New Jersey',draw:'Midday',canonId:'usa/nj/Midday',drawTime:'12:59',closeTime:'12:39',visible:true},
  {section:'usa',lottery:'New Jersey',draw:'Evening',canonId:'usa/nj/Evening',drawTime:'22:57',closeTime:'22:37',visible:true},
  {section:'usa',lottery:'Connecticut',draw:'Day',canonId:'usa/ct/Day',drawTime:'13:57',closeTime:'13:37',visible:true},
  {section:'usa',lottery:'Connecticut',draw:'Night',canonId:'usa/ct/Night',drawTime:'22:29',closeTime:'22:09',visible:true},
  {section:'usa',lottery:'Florida',draw:'Midday',canonId:'usa/fl/Midday',drawTime:'13:30',closeTime:'13:10',visible:true},
  {section:'usa',lottery:'Florida',draw:'Evening',canonId:'usa/fl/Evening',drawTime:'21:45',closeTime:'21:25',visible:true},
  {section:'usa',lottery:'Florida Pick 2',draw:'AM',canonId:'usa/fl-pick2/AM',drawTime:'13:20',closeTime:'13:00',visible:false},
  {section:'usa',lottery:'Florida Pick 2',draw:'PM',canonId:'usa/fl-pick2/PM',drawTime:'21:20',closeTime:'21:00',visible:false},
  {section:'usa',lottery:'Georgia',draw:'Midday',canonId:'usa/ga/Midday',drawTime:'12:29',closeTime:'12:09',visible:true},
  {section:'usa',lottery:'Georgia',draw:'Evening',canonId:'usa/ga/Evening',drawTime:'18:59',closeTime:'18:39',visible:true},
  {section:'usa',lottery:'Georgia',draw:'Night',canonId:'usa/ga/Night',drawTime:'23:34',closeTime:'23:14',visible:true},
  {section:'usa',lottery:'Pennsylvania',draw:'Day',canonId:'usa/pa/Day',drawTime:'13:35',closeTime:'13:15',visible:true},
  {section:'usa',lottery:'Pennsylvania',draw:'Evening',canonId:'usa/pa/Evening',drawTime:'18:59',closeTime:'18:39',visible:true},
  {section:'usa',lottery:'Delaware',draw:'Day',canonId:'usa/de/Day',drawTime:'13:58',closeTime:'13:38',visible:true},
  {section:'usa',lottery:'Delaware',draw:'Night',canonId:'usa/de/Night',drawTime:'19:57',closeTime:'19:37',visible:true},
  {section:'usa',lottery:'Maryland',draw:'Midday',canonId:'usa/md/Midday',drawTime:'12:28',closeTime:'12:08',visible:true},
  {section:'usa',lottery:'Maryland',draw:'Evening',canonId:'usa/md/Evening',drawTime:'19:56',closeTime:'19:36',visible:true},
  {section:'usa',lottery:'Massachusetts',draw:'Midday',canonId:'usa/ma/Midday',drawTime:'14:00',closeTime:'13:40',visible:true},
  {section:'usa',lottery:'Massachusetts',draw:'Evening',canonId:'usa/ma/Evening',drawTime:'21:00',closeTime:'20:40',visible:true},
  {section:'usa',lottery:'Michigan',draw:'Midday',canonId:'usa/mi/Midday',drawTime:'12:59',closeTime:'12:39',visible:true},
  {section:'usa',lottery:'Michigan',draw:'Evening',canonId:'usa/mi/Evening',drawTime:'19:29',closeTime:'19:09',visible:true},
  {section:'usa',lottery:'Virginia',draw:'Day',canonId:'usa/va/Day',drawTime:'13:59',closeTime:'13:39',visible:true},
  {section:'usa',lottery:'Virginia',draw:'Night',canonId:'usa/va/Night',drawTime:'23:00',closeTime:'22:40',visible:true},
  {section:'usa',lottery:'North Carolina',draw:'Day',canonId:'usa/nc/Day',drawTime:'15:00',closeTime:'14:40',visible:true},
  {section:'usa',lottery:'North Carolina',draw:'Evening',canonId:'usa/nc/Evening',drawTime:'23:22',closeTime:'23:02',visible:true},
  {section:'usa',lottery:'South Carolina',draw:'Midday',canonId:'usa/sc/Midday',drawTime:'12:59',closeTime:'12:39',visible:true},
  {section:'usa',lottery:'South Carolina',draw:'Evening',canonId:'usa/sc/Evening',drawTime:'18:59',closeTime:'18:39',visible:true},
  {section:'usa',lottery:'Tennessee',draw:'Morning',canonId:'usa/tn/Morning',drawTime:'09:28',closeTime:'09:08',visible:true},
  {section:'usa',lottery:'Tennessee',draw:'Midday',canonId:'usa/tn/Midday',drawTime:'12:28',closeTime:'12:08',visible:true},
  {section:'usa',lottery:'Tennessee',draw:'Evening',canonId:'usa/tn/Evening',drawTime:'18:28',closeTime:'18:08',visible:true},
  {section:'usa',lottery:'Texas',draw:'Morning',canonId:'usa/tx/Morning',drawTime:'10:00',closeTime:'09:40',visible:true},
  {section:'usa',lottery:'Texas',draw:'Day',canonId:'usa/tx/Day',drawTime:'12:27',closeTime:'12:07',visible:true},
  {section:'usa',lottery:'Texas',draw:'Evening',canonId:'usa/tx/Evening',drawTime:'18:00',closeTime:'17:40',visible:true},
  {section:'usa',lottery:'Texas',draw:'Night',canonId:'usa/tx/Night',drawTime:'22:12',closeTime:'21:52',visible:true},

  // RD
  {section:'rd',lottery:'Loter√≠a Real',draw:'Mediod√≠a',canonId:'rd/real/Mediodia',drawTime:'12:55',closeTime:'12:35',visible:true},
  {section:'rd',lottery:'Gana M√°s',draw:'Tarde',canonId:'rd/ganamas/Tarde',drawTime:'14:30',closeTime:'14:10',visible:true},
  {section:'rd',lottery:'Loteka',draw:'Noche',canonId:'rd/loteka/Noche',drawTime:'19:55',closeTime:'19:35',visible:true},
  {section:'rd',lottery:'Loter√≠a Nacional',draw:'Tarde',canonId:'rd/nacional/Tarde',drawTime:'14:30',closeTime:'14:10',visible:true},
  {section:'rd',lottery:'Loter√≠a Nacional',draw:'Noche',canonId:'rd/nacional/Noche',drawTime:'21:00',closeTime:'20:40',visible:true},
  {section:'rd',lottery:'Loter√≠a Nacional',draw:'Domingo',canonId:'rd/nacional/Domingo',drawTime:'18:00',closeTime:'17:40',visible:true},
  {section:'rd',lottery:'Quiniela Pal√© (Leidsa)',draw:'Diario',canonId:'rd/quiniela/Diario',drawTime:'20:55',closeTime:'20:35',visible:true},
  {section:'rd',lottery:'Quiniela Pal√© (Leidsa)',draw:'Domingo',canonId:'rd/quiniela/Domingo',drawTime:'15:55',closeTime:'15:35',visible:true},
  {section:'rd',lottery:'La Primera',draw:'AM',canonId:'rd/laprimera/AM',drawTime:'12:00',closeTime:'11:40',visible:true},
  {section:'rd',lottery:'La Primera',draw:'PM',canonId:'rd/laprimera/PM',drawTime:'20:00',closeTime:'19:40',visible:true},
  {section:'rd',lottery:'La Suerte Dominicana',draw:'AM',canonId:'rd/lasuerte/AM',drawTime:'12:30',closeTime:'12:10',visible:true},
  {section:'rd',lottery:'La Suerte Dominicana',draw:'PM',canonId:'rd/lasuerte/PM',drawTime:'18:00',closeTime:'17:40',visible:true},
  {section:'rd',lottery:'Lotedom',draw:'Tarde',canonId:'rd/lotedom/Tarde',drawTime:'13:55',closeTime:'13:35',visible:true},

  // Special
  {section:'special',lottery:'Anguilla',draw:'10AM',canonId:'special/anguilla/10AM',drawTime:'10:00',closeTime:'09:40',visible:true},
  {section:'special',lottery:'Anguilla',draw:'1PM',canonId:'special/anguilla/1PM',drawTime:'13:00',closeTime:'12:40',visible:true},
  {section:'special',lottery:'Anguilla',draw:'6PM',canonId:'special/anguilla/6PM',drawTime:'18:00',closeTime:'17:40',visible:true},
  {section:'special',lottery:'Anguilla',draw:'9PM',canonId:'special/anguilla/9PM',drawTime:'21:00',closeTime:'20:40',visible:true},
  {section:'special',lottery:'Extra',draw:'Midday',canonId:'special/extra/Midday',drawTime:'13:00',closeTime:'12:40',visible:true},
  {section:'special',lottery:'Extra',draw:'Night',canonId:'special/extra/Night',drawTime:'21:00',closeTime:'20:40',visible:true},
  {section:'special',lottery:'NY-BK',draw:'AM',canonId:'special/ny-bk/AM',drawTime:'12:00',closeTime:'11:40',visible:true},
  {section:'special',lottery:'NY-BK',draw:'PM',canonId:'special/ny-bk/PM',drawTime:'22:00',closeTime:'21:40',visible:true},
  {section:'special',lottery:'NY-BP',draw:'AM',canonId:'special/ny-bp/AM',drawTime:'12:00',closeTime:'11:40',visible:true},
  {section:'special',lottery:'NY-BP',draw:'PM',canonId:'special/ny-bp/PM',drawTime:'22:00',closeTime:'21:40',visible:true},
  {section:'special',lottery:'NY-FP',draw:'AM',canonId:'special/ny-fp/AM',drawTime:'12:00',closeTime:'11:40',visible:true},
  {section:'special',lottery:'NY-FP',draw:'PM',canonId:'special/ny-fp/PM',drawTime:'22:00',closeTime:'21:40',visible:true},
  {section:'special',lottery:'NY Horses',draw:'R1',canonId:'special/ny-horses/R1',drawTime:'14:00',closeTime:'13:40',visible:true},
  {section:'special',lottery:'NY Horses',draw:'R2',canonId:'special/ny-horses/R2',drawTime:'18:30',closeTime:'18:10',visible:true},
  {section:'special',lottery:'NY Horses',draw:'R3',canonId:'special/ny-horses/R3',drawTime:'21:30',closeTime:'21:10',visible:true},
  {section:'special',lottery:'3-5-7',draw:'Main',canonId:'special/357/Main',drawTime:'20:30',closeTime:'20:10',visible:true},
  {section:'special',lottery:'BK Paper',draw:'Main',canonId:'special/bk-paper/Main',drawTime:'20:00',closeTime:'19:40',visible:true},
  {section:'special',lottery:'King Lottery',draw:'AM',canonId:'special/king/AM',drawTime:'10:30',closeTime:'10:10',visible:true},
  {section:'special',lottery:'King Lottery',draw:'PM',canonId:'special/king/PM',drawTime:'19:30',closeTime:'19:10',visible:true}
];
function loadCatalog(){const c=LS.get('br_catalog_v3');return c && Array.isArray(c)?c:defaultCatalog.slice();}
function saveCatalog(c){LS.set('br_catalog_v3',c);}
let catalog=loadCatalog();

/* ===== Results & History ===== */
function resKey(date){return `br_results_${date}`;}
function getResults(date){return LS.get(resKey(date),{});}
function saveResults(date,obj){LS.set(resKey(date),obj);}
function histKey(canonId){return `br_hist_${canonId}`;}
function pushHistory(canonId,date,value){
  const h=LS.get(histKey(canonId),[]);
  const last=h[h.length-1];
  if(!last || last.value!==value || last.date!==date){
    h.push({date,value,ts:Date.now()});
    LS.set(histKey(canonId),h);
  }
}

/* ===== Public Board rendering ===== */
function openStatus(item,dateStr){
  // Only compute for today
  const d=new Date();
  const today = todayStr();
  if(dateStr!==today) return {label:'',cls:''};
  const [h1,m1]=item.closeTime.split(':').map(Number);
  const [h2,m2]=item.drawTime.split(':').map(Number);
  const now=d.getHours()*60+d.getMinutes();
  const close=h1*60+m1, draw=h2*60+m2;
  if(now<close) return {label:(currentLang==='en'?'Open':'Abierto'), cls:'open'};
  if(now>=close && now<draw) return {label:(currentLang==='en'?'Closed (drawing soon)':'Cerrado (pronto sorteo)'), cls:'closed'};
  return {label:(currentLang==='en'?'Closed':'Cerrado'), cls:'closed'};
}
function initials(name){return name.split(/\s+/).map(x=>x[0]).join('').slice(0,3).toUpperCase();}

function renderBoard(){
  const date=$("#datePicker").value || todayStr();
  const res=getResults(date);
  const secs={usa:$("#grid-usa"), rd:$("#grid-rd"), special:$("#grid-special")};
  Object.values(secs).forEach(el=>el.innerHTML='');
  catalog.filter(c=>c.visible).forEach(item=>{
    const grid=secs[item.section]; if(!grid) return;
    const tile=document.createElement('div'); tile.className='tile';
    const status=openStatus(item,date);

    const name=`${item.lottery}`;
    const draw=item.draw;
    const dateLbl = date;
    const value = res[item.canonId] || '‚Äî';
    tile.innerHTML = `
      <div class="tile-head">
        <div class="badgelogo">${initials(item.lottery)}</div>
        <div>
          <div class="tile-name">${name}</div>
          <div class="tile-draw">${draw}</div>
          <div class="tile-date">${dateLbl}</div>
        </div>
      </div>
      <div class="tile-result">${value}</div>
      <div class="tile-foot">
        <div class="${status.cls}"><span class="dot"></span>${status.label||''}</div>
        <button class="btn btn-ghost hist-btn" data-canon="${item.canonId}" data-i18n="history">Historial</button>
      </div>
    `;
    tile.querySelector('.hist-btn').addEventListener('click',()=>openHistory(item));
    grid.appendChild(tile);
  });
}

/* ===== History modal (edit protected) ===== */
function openHistory(item){
  const modal=$("#historyModal");
  $("#histTitle").textContent=`${item.lottery} ‚Ä¢ ${item.draw}`;
  const list=LS.get(histKey(item.canonId),[]);
  const div=document.createElement('div');
  if(!list.length){
    div.innerHTML=`<div class="note">Sin historial.</div>`;
  }else{
    const t=document.createElement('table');
    t.innerHTML=`<thead><tr><th>Fecha</th><th>Valor</th><th></th></tr></thead><tbody></tbody>`;
    const tb=t.querySelector('tbody');
    list.slice().reverse().forEach((r,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.date}</td><td>${r.value}</td><td class="actions">
        <button class="btn btn-ghost btn-sm">Editar</button>
        <button class="btn btn-ghost btn-sm">Eliminar</button></td>`;
      const [editBtn, delBtn] = tr.querySelectorAll('button');
      editBtn.addEventListener('click',()=>{
        ensureAdmin(()=>{
          const nv=prompt('Nuevo valor:', r.value);
          if(nv!=null && nv!==r.value){
            // apply edit to that record
            const all=LS.get(histKey(item.canonId),[]);
            const rec=all.find(x=>x.date===r.date && x.value===r.value);
            if(rec){ rec.value=nv; LS.set(histKey(item.canonId),all); toast('Historial actualizado'); openHistory(item); }
          }
        });
      });
      delBtn.addEventListener('click',()=>{
        ensureAdmin(()=>{
          const all=LS.get(histKey(item.canonId),[]).filter(x=>!(x.date===r.date && x.value===r.value));
          LS.set(histKey(item.canonId),all); toast('Registro eliminado'); openHistory(item);
        });
      });
      tb.appendChild(tr);
    });
    div.appendChild(t);
  }
  const cont=$("#histContent"); cont.innerHTML=''; cont.appendChild(div);
  modal.classList.add('show');
}
$("#histClose").addEventListener('click',()=>$("#historyModal").classList.remove('show'));

/* ===== Admin panel ===== */
function showTab(name){
  $$(".tab").forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $("#tab-results").classList.toggle('hidden', name!=='results');
  $("#tab-ocr").classList.toggle('hidden', name!=='ocr');
  $("#tab-catalog").classList.toggle('hidden', name!=='catalog');
  $("#tab-visibility").classList.toggle('hidden', name!=='visibility');
  if(name==='results') renderResultsTables();
  if(name==='catalog') renderCatalog();
  if(name==='visibility') renderVisibility();
}
$$(".tab").forEach(t=>t.addEventListener('click',()=>showTab(t.dataset.tab)));

$("#adminBtn").addEventListener('click',()=>ensureAdmin(()=>{
  $("#adminPanel").style.display='block';
  $("#adminPanel").scrollIntoView({behavior:'smooth'});
}));
$("#closeAdmin").addEventListener('click',()=>$("#adminPanel").style.display='none');

/* ===== Admin Results tables ===== */
function renderResultsTables(){
  const wrap=$("#resultsTables"); wrap.innerHTML='';
  const date=$("#datePicker").value || todayStr();
  const res=getResults(date);
  const secs=['usa','rd','special'];
  secs.forEach(sec=>{
    const group=catalog.filter(c=>c.section===sec);
    if(!group.length) return;
    const title=document.createElement('h3'); title.textContent=sec==='usa'?'USA Lotteries':(sec==='rd'?'Santo Domingo Lotteries':'Special Lotteries');
    const table=document.createElement('table');
    table.innerHTML=`<thead><tr>
      <th>Loter√≠a</th><th>Draw</th><th>Hora sorteo</th><th>Hora cierre</th><th>Resultado</th><th></th>
    </tr></thead><tbody></tbody>`;
    const tb=table.querySelector('tbody');
    group.forEach(item=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${item.lottery}</td>
        <td>${item.draw}</td>
        <td><input type="text" value="${item.drawTime}"></td>
        <td><input type="text" value="${item.closeTime}"></td>
        <td><input type="text" value="${res[item.canonId]||''}" placeholder=""></td>
        <td class="actions"><button class="btn btn-pill btn-sm">Save</button></td>`;
      const [lot, dr, dt, ct, valtd, acttd] = tr.children;
      dt.querySelector('input').addEventListener('change',e=>{ item.drawTime=e.target.value; saveCatalog(catalog); renderBoard(); });
      ct.querySelector('input').addEventListener('change',e=>{ item.closeTime=e.target.value; saveCatalog(catalog); renderBoard(); });
      acttd.querySelector('button').addEventListener('click',()=>{
        const v=valtd.querySelector('input').value.trim();
        const r=getResults(date); r[item.canonId]=v; saveResults(date,r); pushHistory(item.canonId,date,v);
        toast('Guardado'); renderBoard();
      });
      tb.appendChild(tr);
    });
    wrap.appendChild(title); wrap.appendChild(table); wrap.appendChild(document.createElement('hr')).className='sep';
  });
}

/* ===== Catalog / Visibility ===== */
function renderCatalog(){
  const tb=$("#catalogTable tbody"); tb.innerHTML='';
  catalog.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.section}</td><td>${c.lottery}</td><td>${c.draw}</td><td><span class="note">${c.canonId}</span></td>
      <td><input type="text" value="${c.drawTime}"></td><td><input type="text" value="${c.closeTime}"></td>
      <td><input type="checkbox" ${c.visible?'checked':''}></td><td><button class="btn btn-ghost btn-sm">Del</button></td>`;
    const inputs=tr.querySelectorAll('input');
    inputs[0].addEventListener('change',e=>{ c.drawTime=e.target.value; saveCatalog(catalog); renderBoard(); });
    inputs[1].addEventListener('change',e=>{ c.closeTime=e.target.value; saveCatalog(catalog); renderBoard(); });
    inputs[2].addEventListener('change',e=>{ c.visible=e.target.checked; saveCatalog(catalog); renderBoard(); });
    tr.querySelector('button').addEventListener('click',()=>ensureAdmin(()=>{ catalog.splice(i,1); saveCatalog(catalog); renderCatalog(); renderBoard(); }));
    tb.appendChild(tr);
  });
}
$("#addCatalogRow").addEventListener('click',()=>ensureAdmin(()=>{
  const s=prompt('Secci√≥n (usa/rd/special):','special')||'special';
  const l=prompt('Loter√≠a:','Custom')||'Custom';
  const d=prompt('Draw:','Main')||'Main';
  const canon=`${s}/${l.toLowerCase().replace(/\s+/g,'-')}/${d}`;
  catalog.push({section:s,lottery:l,draw:d,canonId:canon,drawTime:'12:00',closeTime:'11:40',visible:true});
  saveCatalog(catalog); renderCatalog(); renderBoard();
}));
$("#saveCatalog").addEventListener('click',()=>ensureAdmin(()=>{ saveCatalog(catalog); toast('Cat√°logo guardado'); }));

/* ===== Visibility ===== */
function renderVisibility(){
  const wrap=$("#visibilityWrap"); wrap.innerHTML='';
  ['usa','rd','special'].forEach(s=>{
    const h=document.createElement('h3'); h.textContent=s==='usa'?'USA':'RD'===s?'RD':'Special';
    const list=document.createElement('div'); list.style.display='grid'; list.style.gridTemplateColumns='repeat(auto-fill,minmax(240px,1fr))'; list.style.gap='8px';
    catalog.filter(c=>c.section===s).forEach(c=>{
      const row=document.createElement('div'); row.className='section'; row.style.padding='8px';
      row.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div><b>${c.lottery}</b> <span class="note">${c.draw}</span></div>
        <label class="switch"><span>Visible</span><input type="checkbox" ${c.visible?'checked':''}></label></div>`;
      row.querySelector('input').addEventListener('change',e=>{ c.visible=e.target.checked; saveCatalog(catalog); renderBoard(); });
      list.appendChild(row);
    });
    wrap.appendChild(h); wrap.appendChild(list);
    wrap.appendChild(document.createElement('hr')).className='sep';
  });
}

/* ===== Theme / Language Toggles ===== */
$("#themeToggle").addEventListener('change',(e)=>{
  const on=e.target.checked;
  if(on){
    // Light / Beige
    document.documentElement.style.setProperty('--bg','#f4eadc');
    document.documentElement.style.setProperty('--panel','#e0d3c2');
    document.documentElement.style.setProperty('--tile','#e8dbca');
    document.documentElement.style.setProperty('--tile2','#efe1ce');
    document.documentElement.style.setProperty('--text','#222');
    document.documentElement.style.setProperty('--muted','#4d4d4d');
  }else{
    // Dark Green
    document.documentElement.style.setProperty('--bg','#0d1b16');
    document.documentElement.style.setProperty('--panel','#10241c');
    document.documentElement.style.setProperty('--tile','#152a22');
    document.documentElement.style.setProperty('--tile2','#1a3329');
    document.documentElement.style.setProperty('--text','#e7fff5');
    document.documentElement.style.setProperty('--muted','#9fd5bf');
  }
});
$("#langToggle").addEventListener('change',(e)=>{
  currentLang=e.target.checked?'en':'es'; applyI18n(); renderBoard(); renderResultsTables();
});

/* ===== Auto Scroll ===== */
let autoScroll=false, timer=null;
function tickScroll(){
  if(!autoScroll) return;
  window.scrollBy({top:1,behavior:'smooth'});
  const nearBottom=(window.innerHeight+window.scrollY)>=document.body.offsetHeight-8;
  if(nearBottom){ setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}),900); }
}
$("#autoScrollBtn").addEventListener('click',()=>{
  autoScroll=!autoScroll;
  if(autoScroll) timer=setInterval(tickScroll,100);
  else { clearInterval(timer); timer=null; }
  toast(autoScroll?'Auto Scroll ON':'Auto Scroll OFF');
});

/* ===== OCR PREVIEW & IMPORT ===== */
const ocrKey='br_ocr_preview_v1';
function savePreview(rows){ LS.set(ocrKey,rows); }
function loadPreview(){ return LS.get(ocrKey,[]); }

// Mapping (aliases & resolver)
function normalizeLabel(s){
  return (s||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\/\-\s\.]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function getAliases(){ return LS.get('br_aliases_v1',{}); }
function saveAlias(label, canonId){ const a=getAliases(); a[normalizeLabel(label)]=canonId; LS.set('br_aliases_v1',a); }

function findTarget(label){
  if(!label) return null;
  const raw=label.trim();
  const lbl=normalizeLabel(raw);
  const learned=getAliases()[lbl];
  if(learned) return learned;

  // Special patterns
  if(/anguilla/.test(lbl)){
    if(/\b10\s*am\b/.test(lbl)) return 'special/anguilla/10AM';
    if(/\b1\s*pm\b/.test(lbl))  return 'special/anguilla/1PM';
    if(/\b6\s*pm\b/.test(lbl))  return 'special/anguilla/6PM';
    if(/\b9\s*pm\b/.test(lbl))  return 'special/anguilla/9PM';
  }
  if(/\bextra\b/.test(lbl)){
    if(/\bmid(day)?\b/.test(lbl)) return 'special/extra/Midday';
    if(/\bnight\b/.test(lbl)) return 'special/extra/Night';
  }
  if(/\bfl(\s|-)?pick\s*2\b|\bfl\s*pick2\b|\bflorida\s*pick\s*2\b/.test(lbl)){
    if(/\bam\b/.test(lbl)) return 'usa/fl-pick2/AM';
    if(/\bpm\b/.test(lbl)) return 'usa/fl-pick2/PM';
  }
  if(/\bbk\s*paper\b/.test(lbl)) return 'special/bk-paper/Main';
  if(/\bny[-\s]?bk\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'special/ny-bk/AM'; if(/\bpm\b/.test(lbl)) return 'special/ny-bk/PM'; }
  if(/\bny[-\s]?bp\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'special/ny-bp/AM'; if(/\bpm\b/.test(lbl)) return 'special/ny-bp/PM'; }
  if(/\bny[-\s]?fp\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'special/ny-fp/AM'; if(/\bpm\b/.test(lbl)) return 'special/ny-fp/PM'; }
  if(/\b3[\.\-\s]?5[\.\-\s]?7\b/.test(lbl)) return 'special/357/Main';
  if(/\bking\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'special/king/AM'; if(/\bpm\b/.test(lbl)) return 'special/king/PM'; }

  // RD
  if(/\bloteria\s*real\b|\breal\b/.test(lbl)) return 'rd/real/Mediodia';
  if(/\bgana\s*mas\b/.test(lbl)) return 'rd/ganamas/Tarde';
  if(/\bloteka\b/.test(lbl)) return 'rd/loteka/Noche';
  if(/\bnacional\b/.test(lbl)){
    if(/\bdomingo\b/.test(lbl)) return 'rd/nacional/Domingo';
    if(/\bnoche\b/.test(lbl)) return 'rd/nacional/Noche';
    return 'rd/nacional/Tarde';
  }
  if(/\b(quiniela\s*pale|quiniela\s*pal[e√©])\b/.test(lbl)){ if(/\bdomingo\b/.test(lbl)) return 'rd/quiniela/Domingo'; return 'rd/quiniela/Diario'; }
  if(/\bla\s*primera\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'rd/laprimera/AM'; if(/\bpm\b/.test(lbl)) return 'rd/laprimera/PM'; }
  if(/\bla\s*suerte\b/.test(lbl)){ if(/\bam\b/.test(lbl)) return 'rd/lasuerte/AM'; if(/\bpm\b/.test(lbl)) return 'rd/lasuerte/PM'; }
  if(/\blotedom\b|\blote\s*dom\b/i.test(raw)) return 'rd/lotedom/Tarde';

  // NY specific
  if(/\bstate\b/.test(lbl)) return 'usa/ny/Evening';
  if(/\bmidday\b/.test(lbl) && !/\b(ct|connecticut|pa|penn|ma|mass|mi|mich|md|mary|de|del|va|virg|ga|geor|nj|jersey|nc|sc|tn|tenn|tx|texas)\b/.test(lbl)){
    return 'usa/ny/Midday';
  }
  if(/(^|\b)n[.\s-]*y[.\s-]*($|\b)/.test(lbl) && !/\b(am|pm|midday|evening|night)\b/.test(lbl)){
    return 'special/ny-horses/R1'; // default leg, editable via alias
  }

  // USA general
  const stateMap=[
    {re:/\bnew\s*york\b|\bny\b/, base:'usa/ny'},
    {re:/\bnew\s*jersey\b|\bnj\b/, base:'usa/nj'},
    {re:/\bconnecticut\b|\bct\b/, base:'usa/ct', draws:{am:'Day', pm:'Night'}},
    {re:/\bflorida\b|\bfl\b/, base:'usa/fl'},
    {re:/\bpenn(sylv(ania)?)?\b|\bpa\b/, base:'usa/pa', draws:{am:'Day', pm:'Evening'}},
    {re:/\bdelaware\b|\bde\b/, base:'usa/de', draws:{am:'Day', pm:'Night'}},
    {re:/\bgeorgia\b|\bga\b/, base:'usa/ga', custom:true},
    {re:/\bmaryland\b|\bmd\b/, base:'usa/md'},
    {re:/\bmassa(chusetts)?\b|\bma\b/, base:'usa/ma'},
    {re:/\bmichigan\b|\bmi\b/, base:'usa/mi'},
    {re:/\bvirginia\b|\bva\b/, base:'usa/va', draws:{am:'Day', pm:'Night'}},
    {re:/\bnorth\s*carolina\b|\bnc\b/, base:'usa/nc', draws:{am:'Day', pm:'Evening'}},
    {re:/\bsouth\s*carolina\b|\bsc\b/, base:'usa/sc'},
    {re:/\btennessee\b|\btn\b/, base:'usa/tn'},
    {re:/\btexas\b|\btx\b/, base:'usa/tx'}
  ];
  for(const st of stateMap){
    if(st.re.test(lbl)){
      const isAM=/\bam\b|\bday\b|\bmid(day)?\b/.test(lbl);
      const isPM=/\bpm\b|\beve(ning)?\b|\bnight\b|\bnoche\b/.test(lbl);
      const base=st.base; let draw=null;
      if(base==='usa/ga'){ if(/\bnight\b/.test(lbl)) draw='Night'; else if(/\beve(ning)?\b/.test(lbl)) draw='Evening'; else draw='Midday'; }
      else if(base==='usa/tx'){ if(/\bmorning\b/.test(lbl)) draw='Morning'; else if(/\bday\b/.test(lbl)) draw='Day'; else if(/\bevening\b/.test(lbl)) draw='Evening'; else if(/\bnight\b/.test(lbl)) draw='Night'; else draw=isAM?'Day':'Evening'; }
      else if(base==='usa/tn'){ if(/\bmorning\b/.test(lbl)) draw='Morning'; else if(/\bmid(day)?\b/.test(lbl)) draw='Midday'; else draw='Evening'; }
      else{ if(st.draws){ draw=isAM?st.draws.am:(isPM?st.draws.pm:null);} else { draw=isAM?'Midday':(isPM?'Evening':null);} }
      if(!draw){ if(/night/.test(lbl)) draw='Night'; else if(/eve(ning)?/.test(lbl)) draw='Evening'; else if(/mid(day)?|am|day/.test(lbl)) draw=(base==='usa/ct'||base==='usa/pa'||base==='usa/de'||base==='usa/va')?'Day':'Midday'; else draw='Evening'; }
      const found=catalog.find(c=>c.canonId===`${base}/${draw}`); return found?found.canonId:null;
    }
  }
  return null;
}

function normalizeValue(val){ if(val==null) return ''; return String(val).replace(/\s*-\s*/g,'-').replace(/\s+/g,' ').trim(); }

function renderOcrTable(rows){
  const tbody=$("#ocrTable tbody"); tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const canonical = r.canonId || findTarget(r.label||r.abbr);
    const value = normalizeValue(r.value || r.detected || '');
    tr.innerHTML=`<td><span class="note">${r.label||r.abbr||''}</span></td><td></td><td>${r.detected||''}</td>
      <td><input type="text" value="${value}"></td><td><button class="btn btn-ghost btn-sm">Save</button></td>`;
    const mapCell=tr.children[1];
    const sel=document.createElement('select');
    const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî seleccionar ‚Äî'; sel.appendChild(opt);
    catalog.forEach(c=>{ const o=document.createElement('option'); o.value=c.canonId; o.textContent=`${c.section.toUpperCase()} / ${c.lottery} / ${c.draw}`; if(canonical===c.canonId) o.selected=true; sel.appendChild(o); });
    sel.addEventListener('change',()=>{ rows[i].canonId=sel.value||null; if(sel.value) saveAlias(r.label||r.abbr, sel.value); savePreview(rows); });
    mapCell.appendChild(sel);
    tr.querySelector('button').addEventListener('click',()=>{ rows[i].value = tr.querySelector('input').value; rows[i].canonId = sel.value||rows[i].canonId||canonical; savePreview(rows); toast('Fila guardada'); });
    tbody.appendChild(tr);
  });
  const mapped = rows.filter(r=> (r.canonId || findTarget(r.label||r.abbr)) ).length;
  $("#ocrStats").innerHTML=`Filas: <b>${rows.length}</b> ‚Äî Mapeadas: <b>${mapped}</b> ‚Äî Pendientes: <b>${rows.length-mapped}</b>`;
}

// OCR actions
$("#previewTextBtn").addEventListener('click',()=>{
  const txt = $("#pasteArea").value.trim(); if(!txt){ toast('Pega texto'); return; }
  const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows = lines.map(line=>{
    // Separate label vs numbers
    let label='', nums='';
    const m=line.match(/^(.*?)[\s‚Äî\-:]+([0-9xX][\s0-9xX\-\‚Äì\/]*)$/);
    if(m){ label=m[1].trim(); nums=m[2].trim(); } else { label=line; nums=''; }
    return {label,abbr:label,detected:nums,value:nums,canonId:findTarget(label)};
  });
  savePreview(rows); renderOcrTable(rows);
});
$("#clearPreviewBtn").addEventListener('click',()=>{ LS.del(ocrKey); renderOcrTable([]); $("#pasteArea").value=''; });
$("#saveTextPreviewBtn").addEventListener('click',()=>{
  const txt=$("#pasteArea").value.trim(); if(!txt){ toast('Pega texto'); return; }
  const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const rows=lines.map(l=>({abbr:l.split(/\s+/)[0]||l,label:l,detected:l,value:l}));
  savePreview(rows); toast('Preview guardado (texto)');
});

$("#loadCsvBtn").addEventListener('click',()=>{
  const f=$("#csvInput").files?.[0]; if(!f){ toast('Selecciona CSV'); return; }
  const reader=new FileReader();
  reader.onload=()=>{
    const cont=reader.result||'';
    const lines=String(cont).split(/\r?\n/).filter(Boolean);
    const headers=lines[0].split(',').map(h=>h.trim().toLowerCase());
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cells=lines[i].split(',').map(c=>c.trim());
      const row={};
      headers.forEach((h,idx)=>row[h]=cells[idx]||'');
      const label=row.abbrev||row.abbr||row.label||row.lottery||row.loteria||'';
      const value=row.value||row.result||[row.first,row.second,row.third].filter(Boolean).join('-')||[row.pick3,row.pick_3,row.pick4,row.pick_4].filter(Boolean).join('-');
      rows.push({label,abbr:label,detected:value,value:value,canonId:findTarget(label)});
    }
    savePreview(rows); renderOcrTable(rows); toast('CSV previsualizado');
  };
  reader.readAsText(f);
});

$("#runOcrBtn").addEventListener('click',async()=>{
  const f=$("#imageInput").files?.[0]; if(!f){ toast('Selecciona imagen'); return; }
  toast('OCR procesando...');
  const { createWorker } = Tesseract;
  const worker = await createWorker('eng');
  const { data:{ text } } = await worker.recognize(f);
  await worker.terminate();
  // Parse as text
  $("#pasteArea").value = text;
  $("#previewTextBtn").click();
  toast('OCR completado');
});

/* Refresh from OCR (EXACT copy) */
function refreshFromOcr(){
  const date=$("#datePicker").value || todayStr();
  const rows=loadPreview();
  if(!rows.length){ toast('No hay snapshot OCR'); return; }
  const res=getResults(date);
  let applied=0, omitted=[];
  rows.forEach(r=>{
    const canon = r.canonId || findTarget(r.label||r.abbr);
    const val = normalizeValue(r.value || r.detected || '');
    if(!canon || !val){ omitted.push(r.label||r.abbr||'?'); return; }
    res[canon]=val; applied++; pushHistory(canon,date,val);
  });
  saveResults(date,res); renderResultsTables(); renderBoard();
  toast(`Importadas ${applied}. Omitidas ${omitted.length}.`);
  if(omitted.length) console.warn('Omitidas:', omitted);
}
$("#refreshFromOCR").addEventListener('click',()=>ensureAdmin(()=>refreshFromOcr()));
$("#resetResults").addEventListener('click',()=>ensureAdmin(()=>{ const d=$("#datePicker").value||todayStr(); LS.del(resKey(d)); renderResultsTables(); renderBoard(); toast('Resultados reseteados'); }));

/* ===== Date init & initial render ===== */
$("#datePicker").value=todayStr();
applyI18n();
renderBoard();
</script>
</body>
</html>
