<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Premios de Loter√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                            üé∞ Calculadora de Premios de Loter√≠a
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="theme-toggle" class="p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span class="dark:hidden">üåô</span>
                            <span class="hidden dark:inline">‚òÄÔ∏è</span>
                        </button>
                        <button id="export-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                            üìä Exportar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8" id="game-tabs">
                    <button class="tab-button active py-4 px-1 border-b-2 border-primary-500 text-primary-600 dark:text-primary-400 font-medium text-sm" data-game="PICK3">
                        PICK 3
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:border-gray-300 font-medium text-sm" data-game="WIN4">
                        WIN 4
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:border-gray-300 font-medium text-sm" data-game="VENEZUELA">
                        VENEZUELA
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:border-gray-300 font-medium text-sm" data-game="PULITO">
                        PULITO
                    </button>
                    <button class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:border-gray-300 font-medium text-sm" data-game="SD">
                        SD
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: Prize Tables & Controls -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Metrics Panel -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">üìä M√©tricas</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total Apostado:</span>
                                <span class="font-medium text-gray-900 dark:text-white" id="total-wagered">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total a Pagar:</span>
                                <span class="font-medium text-green-600" id="total-payout">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Premios Pendientes:</span>
                                <span class="font-medium text-yellow-600" id="pending-prizes">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Premios Aprobados:</span>
                                <span class="font-medium text-green-600" id="approved-prizes">0</span>
                            </div>
                            <div class="flex justify-between border-t pt-3">
                                <span class="text-sm text-gray-600 dark:text-gray-400">ROI:</span>
                                <span class="font-medium" id="roi">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Prize Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">üí∞ Tabla de Premios</h3>
                            <button id="reset-prizes-btn" class="text-xs px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Restaurar
                            </button>
                        </div>
                        <div id="prize-table-container" class="space-y-2">
                            <!-- Prize table will be dynamically generated -->
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">‚öôÔ∏è Controles</h3>
                        <div class="space-y-3">
                            <button id="recalculate-btn" class="w-full px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                                üîÑ Recalcular Todo
                            </button>
                            <button id="approve-all-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                                ‚úÖ Aprobar Premios Pendientes
                            </button>
                            <button id="clear-data-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                üóëÔ∏è Limpiar Datos
                            </button>
                            <button id="load-sample-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
                                üìù Cargar Datos Semilla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Plays & Winners -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Plays Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">üéØ Jugadas</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sorteo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">N√∫meros</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Apuesta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Premio</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="plays-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Plays will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Winners Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">üèÜ N√∫meros Ganadores</h3>
                                <button id="add-winner-btn" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                                    + Agregar
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sorteo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Juego</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">N√∫meros</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="winners-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Winners will be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Confirmar Acci√≥n</h3>
            </div>
            <div class="px-6 py-4">
                <div class="text-gray-600 dark:text-gray-400" id="confirmation-message"></div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="confirm-cancel" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Cancelar
                    </button>
                    <button id="confirm-action" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Winner Modal -->
    <div id="add-winner-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Agregar N√∫mero Ganador</h3>
            </div>
            <div class="px-6 py-4">
                <form id="add-winner-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fecha</label>
                        <input type="date" id="winner-date" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Estado</label>
                        <input type="text" id="winner-state" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500" placeholder="FL">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sorteo</label>
                        <select id="winner-draw" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="MID">MID</option>
                            <option value="EVE">EVE</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Juego</label>
                        <select id="winner-game" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500">
                            <option value="PICK3">PICK3</option>
                            <option value="WIN4">WIN4</option>
                            <option value="VENEZUELA">VENEZUELA</option>
                            <option value="PULITO">PULITO</option>
                            <option value="SD">SD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">N√∫meros</label>
                        <input type="text" id="winner-numbers" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-primary-500 focus:ring-primary-500" placeholder="123">
                    </div>
                </form>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-winner" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                        Cancelar
                    </button>
                    <button id="save-winner" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Structures and Constants
        const DEFAULT_PRIZE_TABLE = {
            PICK3: {
                STRAIGHT: 700,
                STRAIGHT_TRIPLE: 500,
                BOX_3WAY: 232,
                BOX_6WAY: 116,
                STRAIGHT_BOX: { straight: 350, box: 82 },
                COMBO_6WAY: 700
            },
            WIN4: {
                STRAIGHT: 5000,
                BOX_24WAY: 200,
                BOX_1COUPLE: 400,
                BOX_DOUBLECOUPLE: 800,
                BOX_TRIPLE: 1200,
                STRAIGHT_OTHER_ST: 2500,
                BOX_OTHER_ST: 100
            },
            VENEZUELA: {
                QUINIELA_PRIMERA: 55,
                QUINIELA_SEGUNDA: 15,
                QUINIELA_TERCERA: 10,
                PALE_FULL: 700,
                PALE_BOX: 175
            },
            PULITO: {
                STRAIGHT: 80,
                BOX: 40
            },
            SD: {
                QUINIELA_PRIMERA: 56,
                QUINIELA_SEGUNDA: 12,
                QUINIELA_TERCERA: 4,
                PALE_FULL: 1300,
                PALE_PARCIAL: 200,
                PALE_BOX: 325
            }
        };

        // Prize status constants
        const PRIZE_STATUS = {
            NO_WIN: 'no_win',
            PENDING: 'pending',
            APPROVED: 'approved',
            REJECTED: 'rejected'
        };

        // Game validation rules
        const GAME_RULES = {
            PICK3: {
                numberLength: 3,
                validBetTypes: ['STRAIGHT', 'STRAIGHT_TRIPLE', 'BOX_3WAY', 'BOX_6WAY', 'STRAIGHT_BOX', 'COMBO_6WAY'],
                numberPattern: /^\d{3}$/
            },
            WIN4: {
                numberLength: 4,
                validBetTypes: ['STRAIGHT', 'BOX_24WAY', 'BOX_1COUPLE', 'BOX_DOUBLECOUPLE', 'BOX_TRIPLE', 'STRAIGHT_OTHER_ST', 'BOX_OTHER_ST'],
                numberPattern: /^\d{4}$/
            },
            VENEZUELA: {
                numberLength: 2,
                validBetTypes: ['QUINIELA_PRIMERA', 'QUINIELA_SEGUNDA', 'QUINIELA_TERCERA', 'PALE_FULL', 'PALE_BOX'],
                numberPattern: /^\d{2}$/,
                palePattern: /^\d{2}-\d{2}-\d{2}$/
            },
            PULITO: {
                numberLength: 2,
                validBetTypes: ['STRAIGHT', 'BOX'],
                numberPattern: /^\d{2}$/
            },
            SD: {
                numberLength: 2,
                validBetTypes: ['QUINIELA_PRIMERA', 'QUINIELA_SEGUNDA', 'QUINIELA_TERCERA', 'PALE_FULL', 'PALE_PARCIAL', 'PALE_BOX'],
                numberPattern: /^\d{2}$/,
                palePattern: /^\d{2}-\d{2}-\d{2}$/
            }
        };

        // Validation utility
        class GameValidator {
            static validateNumbers(game, betType, numbers) {
                const rules = GAME_RULES[game];
                if (!rules) return { valid: false, error: 'Juego no v√°lido' };

                // Validar tipo de apuesta
                if (!rules.validBetTypes.includes(betType)) {
                    return { valid: false, error: 'Tipo de apuesta no v√°lido para este juego' };
                }

                // Validar formato de n√∫meros seg√∫n el tipo de apuesta
                if (betType.includes('PALE') && (game === 'VENEZUELA' || game === 'SD')) {
                    if (!rules.palePattern.test(numbers)) {
                        return { valid: false, error: 'Formato de n√∫meros para Pale debe ser XX-XX-XX' };
                    }
                } else {
                    if (!rules.numberPattern.test(numbers)) {
                        return { valid: false, error: `Formato de n√∫meros debe ser de ${rules.numberLength} d√≠gitos` };
                    }
                }

                return { valid: true };
            }

            static validateWinner(game, numbers) {
                const rules = GAME_RULES[game];
                if (!rules) return { valid: false, error: 'Juego no v√°lido' };

                if (game === 'VENEZUELA' || game === 'SD') {
                    if (!rules.palePattern.test(numbers)) {
                        return { valid: false, error: 'Formato de n√∫meros ganadores debe ser XX-XX-XX' };
                    }
                } else {
                    if (!rules.numberPattern.test(numbers)) {
                        return { valid: false, error: `Formato de n√∫meros debe ser de ${rules.numberLength} d√≠gitos` };
                    }
                }

                return { valid: true };
            }
        }

        // Sample Data
        const SAMPLE_PLAYS = [
            {
                _id: "play001",
                userId: "user1",
                date: "2024-01-15",
                state: "FL",
                draw: "MID",
                game: "PICK3",
                betType: "STRAIGHT",
                numbers: "123",
                wager: 1.00
            },
            {
                _id: "play002",
                userId: "user1",
                date: "2024-01-15",
                state: "FL",
                draw: "EVE",
                game: "WIN4",
                betType: "BOX_24WAY",
                numbers: "1234",
                wager: 0.50
            },
            {
                _id: "play003",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                betType: "QUINIELA_PRIMERA",
                numbers: "12",
                wager: 2.00,
                extra: { position: 1 }
            },
            {
                _id: "play004",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                betType: "QUINIELA_SEGUNDA",
                numbers: "34",
                wager: 1.00,
                extra: { position: 2 }
            },
            {
                _id: "play005",
                userId: "user2",
                date: "2024-01-16",
                state: "FL",
                draw: "EVE",
                game: "PULITO",
                betType: "STRAIGHT",
                numbers: "56",
                wager: 1.50
            },
            {
                _id: "play006",
                userId: "user3",
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                betType: "PALE_FULL",
                numbers: "78-90-12",
                wager: 1.00
            },
            {
                _id: "play007",
                userId: "user3",
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                betType: "QUINIELA_PRIMERA",
                numbers: "78",
                wager: 0.75,
                extra: { position: 1 }
            }
        ];

        const SAMPLE_WINNERS = [
            {
                date: "2024-01-15",
                state: "FL",
                draw: "MID",
                game: "PICK3",
                numbers: "123"
            },
            {
                date: "2024-01-16",
                state: "FL",
                draw: "MID",
                game: "VENEZUELA",
                numbers: "12-34-56"
            },
            {
                date: "2024-01-17",
                state: "FL",
                draw: "MID",
                game: "SD",
                numbers: "78-90-12"
            }
        ];

        // Storage Service
        class StorageService {
            static setItem(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            }

            static getItem(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (error) {
                    console.error('Error reading from localStorage:', error);
                    return defaultValue;
                }
            }

            static removeItem(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.error('Error removing from localStorage:', error);
                }
            }
        }

        // Prize Calculator Engine
        class PrizeCalculator {
            static calculatePrize(play, winner) {
                // Verificar coincidencia b√°sica
                if (play.date !== winner.date || 
                    play.state !== winner.state || 
                    play.draw !== winner.draw || 
                    play.game !== winner.game) {
                    return { hit: false, amount: 0 };
                }

                const prizeTable = StorageService.getItem('prizeTable', DEFAULT_PRIZE_TABLE);
                const gameTable = prizeTable[play.game];
                
                if (!gameTable || !gameTable[play.betType]) {
                    return { hit: false, amount: 0 };
                }

                // Aplicar l√≥gica espec√≠fica por juego
                switch (play.game) {
                    case 'PICK3':
                        return this.calculatePick3Prize(play, winner, gameTable);
                    case 'WIN4':
                        return this.calculateWin4Prize(play, winner, gameTable);
                    case 'VENEZUELA':
                        return this.calculateVenezuelaPrize(play, winner, gameTable);
                    case 'PULITO':
                        return this.calculatePulitoPrize(play, winner, gameTable);
                    case 'SD':
                        return this.calculateSDPrize(play, winner, gameTable);
                    default:
                        return { hit: false, amount: 0 };
                }
            }

            static calculatePick3Prize(play, winner, gameTable) {
                const playNumbers = play.numbers;
                const winnerNumbers = winner.numbers;

                switch (play.betType) {
                    case 'STRAIGHT':
                    case 'STRAIGHT_TRIPLE':
                        if (playNumbers === winnerNumbers) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                    case 'BOX_3WAY':
                    case 'BOX_6WAY':
                        if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                    case 'STRAIGHT_BOX':
                        if (playNumbers === winnerNumbers) {
                            return { hit: true, amount: play.wager * gameTable[play.betType].straight };
                        } else if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            return { hit: true, amount: play.wager * gameTable[play.betType].box };
                        }
                        break;
                    case 'COMBO_6WAY':
                        if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                }
                return { hit: false, amount: 0 };
            }

            static calculateWin4Prize(play, winner, gameTable) {
                const playNumbers = play.numbers;
                const winnerNumbers = winner.numbers;

                switch (play.betType) {
                    case 'STRAIGHT':
                        if (playNumbers === winnerNumbers) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                    case 'BOX_24WAY':
                    case 'BOX_1COUPLE':
                    case 'BOX_DOUBLECOUPLE':
                    case 'BOX_TRIPLE':
                        if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                    case 'STRAIGHT_OTHER_ST':
                        if (playNumbers === winnerNumbers) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                    case 'BOX_OTHER_ST':
                        if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            const multiplier = gameTable[play.betType];
                            return { hit: true, amount: play.wager * multiplier };
                        }
                        break;
                }
                return { hit: false, amount: 0 };
            }

            static calculateVenezuelaPrize(play, winner, gameTable) {
                const winnerParts = winner.numbers.split('-');
                
                // Para quinielas, verificar todas las posiciones si no se especifica una
                switch (play.betType) {
                    case 'QUINIELA_PRIMERA':
                        if (play.extra?.position) {
                            // Posici√≥n espec√≠fica
                            const position = play.extra.position;
                            if (position >= 1 && position <= 3 && winnerParts[position - 1] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        } else {
                            // Verificar primera posici√≥n por defecto
                            if (winnerParts[0] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        }
                        break;
                    case 'QUINIELA_SEGUNDA':
                        if (play.extra?.position) {
                            const position = play.extra.position;
                            if (position >= 1 && position <= 3 && winnerParts[position - 1] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        } else {
                            // Verificar segunda posici√≥n por defecto
                            if (winnerParts[1] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        }
                        break;
                    case 'QUINIELA_TERCERA':
                        if (play.extra?.position) {
                            const position = play.extra.position;
                            if (position >= 1 && position <= 3 && winnerParts[position - 1] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        } else {
                            // Verificar tercera posici√≥n por defecto
                            if (winnerParts[2] === play.numbers) {
                                return { hit: true, amount: play.wager * gameTable[play.betType] };
                            }
                        }
                        break;
                    case 'PALE_FULL':
                        if (play.numbers === winner.numbers) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                    case 'PALE_BOX':
                        if (this.isPaleBoxMatch(play.numbers, winner.numbers)) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                }
                return { hit: false, amount: 0 };
            }

            static calculatePulitoPrize(play, winner, gameTable) {
                const playNumbers = play.numbers;
                const winnerNumbers = winner.numbers;

                switch (play.betType) {
                    case 'STRAIGHT':
                        if (playNumbers === winnerNumbers) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                    case 'BOX':
                        if (this.isBoxMatch(playNumbers, winnerNumbers)) {
                            return { hit: true, amount: play.wager * gameTable[play.betType] };
                        }
                        break;
                }
                return { hit: false, amount: 0 };
            }

            static calculateSDPrize(play, winner, gameTable) {
                // Similar logic to Venezuela but with different prize structure
                return this.calculateVenezuelaPrize(play, winner, gameTable);
            }

            static isBoxMatch(playNumbers, winnerNumbers) {
                if (playNumbers.length !== winnerNumbers.length) return false;
                
                const playDigits = playNumbers.split('').sort();
                const winnerDigits = winnerNumbers.split('').sort();
                
                return playDigits.join('') === winnerDigits.join('');
            }

            static isPaleBoxMatch(playNumbers, winnerNumbers) {
                // Implementar l√≥gica de caja para pale
                const playParts = playNumbers.split('-').map(part => part.split('').sort().join(''));
                const winnerParts = winnerNumbers.split('-').map(part => part.split('').sort().join(''));
                
                return playParts.every((part, index) => part === winnerParts[index]);
            }
        }

        // App State Management
        class AppState {
            constructor() {
                this.currentGame = 'PICK3';
                this.plays = StorageService.getItem('plays', []);
                this.winners = StorageService.getItem('winners', []);
                this.prizeTable = StorageService.getItem('prizeTable', DEFAULT_PRIZE_TABLE);
                this.calculateResults();
            }

            setCurrentGame(game) {
                this.currentGame = game;
                this.render();
            }

            addPlay(play) {
                this.plays.push(play);
                this.savePlays();
                this.calculateResults();
                this.render();
            }

            addWinner(winner) {
                this.winners.push(winner);
                this.saveWinners();
                this.calculateResults();
                this.render();
            }

            removeWinner(index) {
                this.winners.splice(index, 1);
                this.saveWinners();
                this.calculateResults();
                this.render();
            }

            updatePrizeTable(game, betType, value) {
                if (typeof value === 'object') {
                    this.prizeTable[game][betType] = value;
                } else {
                    this.prizeTable[game][betType] = parseFloat(value) || 0;
                }
                StorageService.setItem('prizeTable', this.prizeTable);
                this.calculateResults();
                this.render();
            }

            resetPrizeTable() {
                this.prizeTable = JSON.parse(JSON.stringify(DEFAULT_PRIZE_TABLE));
                StorageService.setItem('prizeTable', this.prizeTable);
                this.calculateResults();
                this.render();
            }

            calculateResults() {
                this.plays.forEach(play => {
                    const oldResult = play.prizeResult;
                    play.prizeResult = null;
                    
                    this.winners.forEach(winner => {
                        const result = PrizeCalculator.calculatePrize(play, winner);
                        if (result.hit && (!play.prizeResult || result.amount > play.prizeResult.amount)) {
                            play.prizeResult = result;
                            // Si hab√≠a un resultado anterior aprobado, mantener el estado
                            if (oldResult && oldResult.status === PRIZE_STATUS.APPROVED) {
                                play.prizeResult.status = PRIZE_STATUS.APPROVED;
                            } else if (oldResult && oldResult.status === PRIZE_STATUS.REJECTED) {
                                play.prizeResult.status = PRIZE_STATUS.REJECTED;
                            } else {
                                // Nuevo premio pendiente de confirmaci√≥n
                                play.prizeResult.status = PRIZE_STATUS.PENDING;
                            }
                        }
                    });
                    
                    // Si no hay premio, marcar como sin ganancia
                    if (!play.prizeResult) {
                        play.prizeResult = { hit: false, amount: 0, status: PRIZE_STATUS.NO_WIN };
                    }
                });
                this.savePlays();
            }

            recalculateAll() {
                this.calculateResults();
                this.render();
            }

            approveAllPendingPrizes() {
                let approvedCount = 0;
                this.plays.forEach(play => {
                    if (play.prizeResult && play.prizeResult.status === PRIZE_STATUS.PENDING) {
                        play.prizeResult.status = PRIZE_STATUS.APPROVED;
                        approvedCount++;
                    }
                });
                
                if (approvedCount > 0) {
                    this.savePlays();
                    this.render();
                    showToast(`${approvedCount} premios aprobados exitosamente`, 'success');
                } else {
                    showToast('No hay premios pendientes para aprobar', 'info');
                }
            }

            clearAllData() {
                this.plays = [];
                this.winners = [];
                StorageService.removeItem('plays');
                StorageService.removeItem('winners');
                this.render();
            }

            loadSampleData() {
                this.plays = [...SAMPLE_PLAYS];
                this.winners = [...SAMPLE_WINNERS];
                this.savePlays();
                this.saveWinners();
                this.calculateResults();
                this.render();
            }

            savePlays() {
                StorageService.setItem('plays', this.plays);
            }

            saveWinners() {
                StorageService.setItem('winners', this.winners);
            }

            approvePrize(playId) {
                const play = this.plays.find(p => p._id === playId);
                if (play && play.prizeResult && play.prizeResult.hit) {
                    play.prizeResult.status = PRIZE_STATUS.APPROVED;
                    this.savePlays();
                    this.render();
                    showToast('Premio aprobado exitosamente', 'success');
                }
            }

            rejectPrize(playId) {
                const play = this.plays.find(p => p._id === playId);
                if (play && play.prizeResult && play.prizeResult.hit) {
                    play.prizeResult.status = PRIZE_STATUS.REJECTED;
                    this.savePlays();
                    this.render();
                    showToast('Premio rechazado', 'warning');
                }
            }

            confirmPrize(playId, action) {
                const play = this.plays.find(p => p._id === playId);
                if (!play || !play.prizeResult || !play.prizeResult.hit) return;

                const modal = document.getElementById('confirmation-modal');
                const message = document.getElementById('confirmation-message');
                const actionBtn = document.getElementById('confirm-action');
                const cancelBtn = document.getElementById('confirm-cancel');
                
                message.innerHTML = `
                    <strong>Jugada:</strong> ${play.numbers} (${play.betType})<br>
                    <strong>Apuesta:</strong> $${play.wager.toFixed(2)}<br>
                    <strong>Premio calculado:</strong> $${play.prizeResult.amount.toFixed(2)}<br><br>
                    ¬øConfirma que desea <strong>${action === 'approve' ? 'aprobar' : 'rechazar'}</strong> este premio?
                `;

                // Update button text and color based on action
                if (action === 'approve') {
                    actionBtn.textContent = 'Aprobar Premio';
                    actionBtn.className = 'px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700';
                } else {
                    actionBtn.textContent = 'Rechazar Premio';
                    actionBtn.className = 'px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700';
                }

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                // Setup confirmation buttons with fresh event listeners
                actionBtn.onclick = () => {
                    if (action === 'approve') {
                        this.approvePrize(playId);
                    } else {
                        this.rejectPrize(playId);
                    }
                    this.closeConfirmationModal();
                };
                
                cancelBtn.onclick = () => {
                    this.closeConfirmationModal();
                };
            }

            closeConfirmationModal() {
                const modal = document.getElementById('confirmation-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            getMetrics() {
                const totalWagered = this.plays.reduce((sum, play) => sum + play.wager, 0);
                const totalPayout = this.plays.reduce((sum, play) => {
                    // Solo contar premios aprobados para el pago
                    return sum + (play.prizeResult && play.prizeResult.status === PRIZE_STATUS.APPROVED ? play.prizeResult.amount : 0);
                }, 0);
                const roi = totalWagered > 0 ? ((totalPayout - totalWagered) / totalWagered * 100) : 0;

                // M√©tricas adicionales
                const pendingPrizes = this.plays.filter(p => p.prizeResult && p.prizeResult.status === PRIZE_STATUS.PENDING).length;
                const approvedPrizes = this.plays.filter(p => p.prizeResult && p.prizeResult.status === PRIZE_STATUS.APPROVED).length;

                return { totalWagered, totalPayout, roi, pendingPrizes, approvedPrizes };
            }

            getCurrentGamePlays() {
                return this.plays.filter(play => play.game === this.currentGame);
            }

            getCurrentGameWinners() {
                return this.winners.filter(winner => winner.game === this.currentGame);
            }

            render() {
                this.renderTabs();
                this.renderPrizeTable();
                this.renderPlaysTable();
                this.renderWinnersTable();
                this.renderMetrics();
            }

            renderTabs() {
                const tabs = document.querySelectorAll('.tab-button');
                tabs.forEach(tab => {
                    tab.classList.remove('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200', 'hover:border-gray-300');
                    
                    if (tab.dataset.game === this.currentGame) {
                        tab.classList.add('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
                        tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-200', 'hover:border-gray-300');
                    }
                });
            }

            renderPrizeTable() {
                const container = document.getElementById('prize-table-container');
                const gameTable = this.prizeTable[this.currentGame];
                
                container.innerHTML = '';
                
                Object.entries(gameTable).forEach(([betType, value]) => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700';
                    
                    if (typeof value === 'object') {
                        // Handle complex prize structures like STRAIGHT_BOX
                        row.innerHTML = `
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${betType}</span>
                            <div class="space-x-2">
                                ${Object.entries(value).map(([subType, subValue]) => `
                                    <input type="number" 
                                           value="${subValue}" 
                                           class="w-16 px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded"
                                           data-game="${this.currentGame}" 
                                           data-bet-type="${betType}" 
                                           data-sub-type="${subType}"
                                           onchange="app.updateComplexPrize(this)">
                                `).join('')}
                            </div>
                        `;
                    } else {
                        row.innerHTML = `
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${betType}</span>
                            <input type="number" 
                                   value="${value}" 
                                   class="w-20 px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded"
                                   data-game="${this.currentGame}" 
                                   data-bet-type="${betType}"
                                   onchange="app.updateSimplePrize(this)">
                        `;
                    }
                    
                    container.appendChild(row);
                });
            }

            renderPlaysTable() {
                const tbody = document.getElementById('plays-table-body');
                const plays = this.getCurrentGamePlays();
                
                tbody.innerHTML = plays.map(play => {
                    const prizeResult = play.prizeResult;
                    let statusBadge = '';
                    let prizeActions = '';
                    
                    if (prizeResult && prizeResult.hit) {
                        switch (prizeResult.status) {
                            case PRIZE_STATUS.PENDING:
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100">Pendiente</span>';
                                prizeActions = `
                                    <div class="flex space-x-2">
                                        <button onclick="app.confirmPrize('${play._id}', 'approve')" 
                                                class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 text-xs">
                                            ‚úì Aprobar
                                        </button>
                                        <button onclick="app.confirmPrize('${play._id}', 'reject')" 
                                                class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 text-xs">
                                            ‚úó Rechazar
                                        </button>
                                    </div>
                                `;
                                break;
                            case PRIZE_STATUS.APPROVED:
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">Aprobado</span>';
                                prizeActions = '<span class="text-xs text-gray-500">Premio acreditado</span>';
                                break;
                            case PRIZE_STATUS.REJECTED:
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100">Rechazado</span>';
                                prizeActions = '<span class="text-xs text-gray-500">Premio rechazado</span>';
                                break;
                        }
                    } else {
                        statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100">Sin premio</span>';
                        prizeActions = '<span class="text-xs text-gray-500">-</span>';
                    }
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${play.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${play.state}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${play.draw}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${play.betType}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900 dark:text-white">
                                ${play.numbers}
                                ${play.extra?.position ? `<br><small class="text-gray-500">Pos: ${play.extra.position}</small>` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">$${play.wager.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${prizeResult && prizeResult.hit ? (prizeResult.status === PRIZE_STATUS.APPROVED ? 'text-green-600' : 'text-yellow-600') : 'text-gray-400'}">
                                ${prizeResult && prizeResult.hit ? `$${prizeResult.amount.toFixed(2)}` : '$0.00'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${statusBadge}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                ${prizeActions}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            renderWinnersTable() {
                const tbody = document.getElementById('winners-table-body');
                const winners = this.getCurrentGameWinners();
                
                tbody.innerHTML = winners.map((winner, index) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${winner.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${winner.state}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${winner.draw}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${winner.game}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900 dark:text-white">${winner.numbers}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="app.removeWinner(${this.winners.indexOf(winner)})" 
                                    class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            renderMetrics() {
                const metrics = this.getMetrics();
                
                document.getElementById('total-wagered').textContent = `$${metrics.totalWagered.toFixed(2)}`;
                document.getElementById('total-payout').textContent = `$${metrics.totalPayout.toFixed(2)}`;
                document.getElementById('pending-prizes').textContent = metrics.pendingPrizes;
                document.getElementById('approved-prizes').textContent = metrics.approvedPrizes;
                
                const roiElement = document.getElementById('roi');
                roiElement.textContent = `${metrics.roi.toFixed(1)}%`;
                roiElement.className = `font-medium ${metrics.roi >= 0 ? 'text-green-600' : 'text-red-600'}`;
            }

            updateSimplePrize(input) {
                const game = input.dataset.game;
                const betType = input.dataset.betType;
                const value = parseFloat(input.value) || 0;
                this.updatePrizeTable(game, betType, value);
            }

            updateComplexPrize(input) {
                const game = input.dataset.game;
                const betType = input.dataset.betType;
                const subType = input.dataset.subType;
                const value = parseFloat(input.value) || 0;
                
                const currentValue = this.prizeTable[game][betType];
                const newValue = { ...currentValue, [subType]: value };
                this.updatePrizeTable(game, betType, newValue);
            }

            removeWinner(index) {
                this.removeWinner(index);
            }

            exportData() {
                const data = {
                    plays: this.plays,
                    winners: this.winners,
                    prizeTable: this.prizeTable,
                    metrics: this.getMetrics()
                };

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Plays sheet
                const playsData = this.plays.map(play => ({
                    ID: play._id,
                    Usuario: play.userId,
                    Fecha: play.date,
                    Estado: play.state,
                    Sorteo: play.draw,
                    Juego: play.game,
                    Tipo: play.betType,
                    N√∫meros: play.numbers,
                    Apuesta: play.wager,
                    Premio: play.prizeResult ? play.prizeResult.amount : 0,
                    Estado_Premio: play.prizeResult ? 'Ganador' : 'Sin premio'
                }));
                const playsSheet = XLSX.utils.json_to_sheet(playsData);
                XLSX.utils.book_append_sheet(wb, playsSheet, 'Jugadas');

                // Winners sheet
                const winnersData = this.winners.map(winner => ({
                    Fecha: winner.date,
                    Estado: winner.state,
                    Sorteo: winner.draw,
                    Juego: winner.game,
                    N√∫meros: winner.numbers
                }));
                const winnersSheet = XLSX.utils.json_to_sheet(winnersData);
                XLSX.utils.book_append_sheet(wb, winnersSheet, 'Ganadores');

                // Export
                XLSX.writeFile(wb, `loteria_report_${new Date().toISOString().split('T')[0]}.xlsx`);
            }
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.theme = StorageService.getItem('theme', 'light');
                this.applyTheme();
            }

            toggle() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                StorageService.setItem('theme', this.theme);
                this.applyTheme();
            }

            applyTheme() {
                if (this.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
        }

        // Global App Instance
        let app;
        let themeManager;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            app = new AppState();
            themeManager = new ThemeManager();

            // Global methods for inline event handlers
            window.app = {
                updateSimplePrize: (input) => app.updateSimplePrize(input),
                updateComplexPrize: (input) => app.updateComplexPrize(input),
                removeWinner: (index) => app.removeWinner(index),
                confirmPrize: (playId, action) => app.confirmPrize(playId, action),
                approvePrize: (playId) => app.approvePrize(playId),
                rejectPrize: (playId) => app.rejectPrize(playId),
                approveAllPendingPrizes: () => app.approveAllPendingPrizes(),
                closeConfirmationModal: () => app.closeConfirmationModal()
            };

            app.render();
            setupEventListeners();
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', () => {
                    app.setCurrentGame(tab.dataset.game);
                });
            });

            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                themeManager.toggle();
            });

            // Export button
            document.getElementById('export-btn').addEventListener('click', () => {
                app.exportData();
            });

            // Control buttons
            document.getElementById('recalculate-btn').addEventListener('click', () => {
                app.recalculateAll();
                showToast('Rec√°lculo completado', 'success');
            });

            document.getElementById('approve-all-btn').addEventListener('click', () => {
                if (confirm('¬øEst√° seguro de que desea aprobar todos los premios pendientes?')) {
                    app.approveAllPendingPrizes();
                }
            });

            document.getElementById('clear-data-btn').addEventListener('click', () => {
                if (confirm('¬øEst√° seguro de que desea limpiar todos los datos?')) {
                    app.clearAllData();
                    showToast('Datos limpiados', 'info');
                }
            });

            document.getElementById('load-sample-btn').addEventListener('click', () => {
                app.loadSampleData();
                showToast('Datos semilla cargados', 'success');
            });

            document.getElementById('reset-prizes-btn').addEventListener('click', () => {
                app.resetPrizeTable();
                showToast('Tabla de premios restaurada', 'info');
            });

            // Add winner modal
            document.getElementById('add-winner-btn').addEventListener('click', () => {
                document.getElementById('add-winner-modal').classList.remove('hidden');
                document.getElementById('add-winner-modal').classList.add('flex');
            });

            document.getElementById('cancel-winner').addEventListener('click', () => {
                closeAddWinnerModal();
            });

            document.getElementById('save-winner').addEventListener('click', () => {
                saveNewWinner();
            });

            // Modal backdrop clicks
            document.getElementById('add-winner-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeAddWinnerModal();
                }
            });

            document.getElementById('confirmation-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    app.closeConfirmationModal();
                }
            });
        }

        function closeAddWinnerModal() {
            document.getElementById('add-winner-modal').classList.add('hidden');
            document.getElementById('add-winner-modal').classList.remove('flex');
            document.getElementById('add-winner-form').reset();
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveNewWinner() {
            const winner = {
                date: document.getElementById('winner-date').value,
                state: document.getElementById('winner-state').value,
                draw: document.getElementById('winner-draw').value,
                game: document.getElementById('winner-game').value,
                numbers: document.getElementById('winner-numbers').value
            };

            if (!winner.date || !winner.state || !winner.numbers) {
                showToast('Por favor complete todos los campos requeridos', 'error');
                return;
            }

            // Validar formato de n√∫meros
            const validation = GameValidator.validateWinner(winner.game, winner.numbers);
            if (!validation.valid) {
                showToast(validation.error, 'error');
                return;
            }

            app.addWinner(winner);
            closeAddWinnerModal();
            showToast('N√∫mero ganador agregado exitosamente', 'success');
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // TODO: Integration points for backend
        // - Replace StorageService with API calls
        // - Add authentication/authorization
        // - Implement real-time updates via WebSocket
        // - Add play validation before saving
        // - Implement audit trail for prize calculations
        // - Add batch operations for large datasets
        // - Implement caching for frequently accessed data
        // - Add error handling and retry logic for API calls
        // - Implement pagination for large datasets
        // - Add data export scheduling capabilities
    </script>
</body>
</html>
